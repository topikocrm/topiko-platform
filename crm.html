<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topiko CRM v5.0 - Modern Professional Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        /* ===== MODERN CLEAN THEME ===== */
        
        .crm-container {
            display: flex;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .crm-sidebar {
            width: 280px;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 2rem 0;
            box-shadow: 4px 0 20px rgba(30, 41, 59, 0.15);
        }

        .crm-logo {
            text-align: center;
            margin-bottom: 3rem;
            padding: 0 2rem;
        }

        .crm-logo h1 {
            color: #f8fafc;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .crm-logo p {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .crm-nav {
            list-style: none;
        }

        .crm-nav-item {
            margin: 0.3rem 0;
            padding: 0 1.5rem;
        }

        .crm-nav-link {
            display: block;
            padding: 1rem 1.5rem;
            color: #94a3b8;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            cursor: pointer;
        }

        .crm-nav-link:hover,
        .crm-nav-link.active {
            color: #f8fafc;
            background: rgba(59, 130, 246, 0.15);
            transform: translateX(4px);
        }

        .crm-nav-icon {
            margin-right: 0.8rem;
            font-size: 1.1rem;
        }

        /* ===== MAIN CONTENT ===== */
        .crm-main {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .crm-section {
            display: none;
        }

        .crm-section.active {
            display: block;
        }

        .crm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .crm-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
        }

        .crm-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* ===== DASHBOARD STATS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .stat-card.clickable {
            cursor: pointer;
        }

        .stat-card.clickable:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .stat-card.active {
            border: 2px solid #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .stat-icon {
            font-size: 1.5rem;
        }

        .stat-title {
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
        }

        .stat-change {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            color: #64748b;
        }

        .stat-positive { color: #059669; }
        .stat-negative { color: #dc2626; }

        /* Special stat cards */
        .stat-card.priority {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #f87171;
        }

        .stat-card.high-budget {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #34d399;
        }

        /* ===== FILTERS SECTION ===== */
        .filters-section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .filters-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .filter-select, .filter-input {
            padding: 0.6rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            color: #64748b;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .filter-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .clear-filters-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-filters-btn:hover {
            background: #dc2626;
        }

        /* ===== MODERN LEAD CARDS ===== */
        .leads-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }

        .leads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        /* ===== CLEAN LEAD CARD DESIGN ===== */
        .lead-card {
            background: #fafafa;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .lead-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #d1d5db;
        }

        .lead-card.priority {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .lead-card.high-budget {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        /* Card Header */
        .lead-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .lead-info {
            flex: 1;
        }

        .lead-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .lead-business {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .lead-contact {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .lead-score-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.2rem;
            color: white;
            flex-shrink: 0;
        }

        .score-hot { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .score-warm { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .score-cold { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }

        /* Card Body */
        .lead-card-body {
            margin-bottom: 1rem;
        }

        .card-section {
            margin-bottom: 1rem;
        }

        .card-section:last-child {
            margin-bottom: 0;
        }

        .card-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .card-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .goal-tag {
            background: #dbeafe;
            color: #1e40af;
        }

        .category-tag {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-priority {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge-high-budget {
            background: #d1fae5;
            color: #059669;
        }

        .badge-decision-maker {
            background: #e0e7ff;
            color: #4338ca;
        }

        .badge-timeline {
            background: #f1f5f9;
            color: #475569;
        }

        .badge-timeline.immediate {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge-timeline.week {
            background: #fef3c7;
            color: #d97706;
        }

        /* Card Details */
        .card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .detail-item {
            font-size: 0.8rem;
            color: #64748b;
        }

        .detail-label {
            font-weight: 500;
            color: #374151;
        }

        /* Card Status */
        .card-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-new { background: #dbeafe; color: #1e40af; }
        .status-contacted { background: #fef3c7; color: #b45309; }
        .status-qualified { background: #d1fae5; color: #059669; }
        .status-assigned { background: #e0f2fe; color: #0369a1; }

        .assigned-sdr {
            font-size: 0.8rem;
            color: #64748b;
        }

        /* Card Actions */
        .card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-assign {
            background: #3b82f6;
            color: white;
        }

        .btn-assign:hover {
            background: #2563eb;
        }

        .btn-assign.reassign {
            background: #f59e0b;
        }

        .btn-assign.reassign:hover {
            background: #d97706;
        }

        .btn-intel {
            background: #10b981;
            color: white;
        }

        .btn-intel:hover {
            background: #059669;
        }

        /* ===== LEAD INTELLIGENCE PANEL ===== */
        .lead-intelligence-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 400px;
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid #e2e8f0;
            z-index: 1000;
            display: none;
            max-height: 90vh;
            overflow-y: auto;
        }

        .lead-intelligence-panel.show {
            display: block;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .intelligence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .intelligence-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
        }

        .intelligence-close {
            background: #f1f5f9;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .intelligence-close:hover {
            background: #e2e8f0;
            color: #374151;
        }

        .intelligence-section {
            margin-bottom: 1.5rem;
        }

        .intelligence-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }

        .intelligence-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .intelligence-item:last-child {
            border-bottom: none;
        }

        .intelligence-label {
            font-size: 0.85rem;
            color: #64748b;
        }

        .intelligence-value {
            font-size: 0.85rem;
            font-weight: 500;
            color: #1e293b;
        }

        .score-display {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .score-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .score-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .action-button {
            width: 100%;
            background: #10b981;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-button:hover {
            background: #059669;
        }

        /* ===== NOTIFICATIONS ===== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s ease;
            z-index: 1001;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.info {
            background: #3b82f6;
        }

        /* ===== SDR SUMMARY GRID ===== */
        .sdr-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .sdr-summary-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .sdr-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .sdr-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .sdr-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 1rem;
        }

        .sdr-info {
            flex: 1;
        }

        .sdr-name {
            font-weight: 600;
            color: #1e293b;
        }

        .sdr-email {
            font-size: 0.8rem;
            color: #64748b;
        }

        .sdr-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .sdr-stat {
            text-align: center;
        }

        .sdr-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }

        .sdr-stat-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== ENHANCED LEAD CARD WITH DATE/TIME ===== */
        .lead-card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            color: #64748b;
        }

        .lead-date {
            font-weight: 500;
        }

        .lead-assigned-sdr {
            font-weight: 500;
            color: #3b82f6;
        }

        /* ===== SDR DROPDOWN STYLES ===== */
        .sdr-dropdown {
            position: relative;
            display: inline-block;
        }

        .sdr-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 4px;
        }

        .sdr-dropdown-content.show {
            display: block;
            animation: dropdownSlideIn 0.2s ease;
        }

        @keyframes dropdownSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sdr-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #374151;
        }

        .sdr-option:hover {
            background-color: #f8fafc;
            color: #3b82f6;
        }

        .sdr-option:last-child {
            border-bottom: none;
        }

        /* Ensure dropdown appears above cards */
        .lead-card {
            position: relative;
            z-index: 1;
        }

        /* Modern browsers with :has() support */
        @supports selector(:has(*)) {
            .lead-card:has(.sdr-dropdown-content.show) {
                z-index: 999;
            }
        }

        /* Fallback for browsers without :has() support - handled by JavaScript */

        /* Alternative positioning for dropdowns near screen edges */
        .sdr-dropdown-content.dropdown-up {
            top: auto;
            bottom: 100%;
            margin-top: 0;
            margin-bottom: 4px;
        }

        .sdr-dropdown-content.dropdown-right {
            left: auto;
            right: 0;
        }

        /* ===== SCORE BREAKDOWN MODAL ===== */
        .score-breakdown-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .score-breakdown-modal.show {
            display: flex;
        }

        .score-breakdown-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .score-breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .score-breakdown-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
        }

        .score-close {
            background: #f1f5f9;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            color: #64748b;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .score-item-label {
            font-size: 0.9rem;
            color: #64748b;
        }

        .score-item-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1e293b;
        }

        .score-total {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
        }

        .score-total-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
        }

        .score-total-label {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        /* ===== ENHANCED LEAD CARD WITH STATUS ===== */
        .card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .card-status-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .status-dropdown {
            position: relative;
        }

        .status-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            min-width: 150px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            z-index: 1000;
            margin-top: 4px;
        }

        .status-dropdown-content.show {
            display: block;
        }

        .status-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.85rem;
            color: #374151;
        }

        .status-option:hover {
            background: #f8fafc;
            color: #3b82f6;
        }

        .status-option:last-child {
            border-bottom: none;
        }

        .btn-status {
            background: #f59e0b;
            color: white;
        }

        .btn-status:hover {
            background: #d97706;
        }

        .btn-followup {
            background: #8b5cf6;
            color: white;
        }

        .btn-followup:hover {
            background: #7c3aed;
        }

        /* ===== FOLLOWUP DATE PICKER ===== */
        .followup-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .followup-modal.show {
            display: flex;
        }

        .followup-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
        }

        .followup-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            margin: 1rem 0;
        }

        .followup-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn-save, .btn-cancel {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-save {
            background: #10b981;
            color: white;
        }

        .btn-cancel {
            background: #64748b;
            color: white;
        }
        @media (max-width: 768px) {
            .crm-container {
                flex-direction: column;
            }
            
            .crm-sidebar {
                width: 100%;
                height: auto;
                order: 2;
            }
            
            .crm-main {
                order: 1;
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .leads-grid {
                grid-template-columns: 1fr;
            }

            .sdr-summary-grid {
                grid-template-columns: 1fr;
            }

            .lead-intelligence-panel {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: auto;
                border-radius: 0;
                max-height: none;
            }

            .card-details {
                grid-template-columns: 1fr;
            }

            .lead-card-top {
                flex-direction: column;
                gap: 0.25rem;
                align-items: flex-start;
            }
        }
        @media (max-width: 768px) {
            .crm-container {
                flex-direction: column;
            }
            
            .crm-sidebar {
                width: 100%;
                height: auto;
                order: 2;
            }
            
            .crm-main {
                order: 1;
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .leads-grid {
                grid-template-columns: 1fr;
            }

            .lead-intelligence-panel {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: auto;
                border-radius: 0;
                max-height: none;
            }
        }

        /* ===== LOADING STATES ===== */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #64748b;
        }

        .loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== UTILITIES ===== */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.85rem; }
        .text-xs { font-size: 0.75rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }
    </style>
</head>
<body>
    <div class="crm-container">
        <!-- SIDEBAR -->
        <nav class="crm-sidebar">
            <div class="crm-logo">
                <h1>Topiko CRM v5.0</h1>
                <p>Modern Professional Dashboard</p>
            </div>
            
            <ul class="crm-nav">
                <li class="crm-nav-item">
                    <div class="crm-nav-link active" onclick="showSection('dashboard')">
                        <span class="crm-nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </div>
                </li>
                <li class="crm-nav-item">
                    <div class="crm-nav-link" onclick="showSection('assigned-leads')">
                        <span class="crm-nav-icon">üë®‚Äçüíº</span>
                        <span>Assigned Leads</span>
                    </div>
                </li>
            </ul>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="crm-main">
            <!-- DASHBOARD SECTION -->
            <section id="dashboard" class="crm-section active" style="display: block;">
                <div class="crm-header">
                    <h1 class="crm-title">Modern Lead Management Dashboard</h1>
                    <div class="crm-user-info">
                        <div class="user-avatar">S</div>
                        <div>
                            <div style="font-weight: 600;">SDR Manager</div>
                            <div style="font-size: 0.85rem; color: #64748b;">Sales Team</div>
                        </div>
                    </div>
                </div>

                <!-- STATS GRID -->
                <div class="stats-grid">
                    <!-- Row 1: Time-based metrics -->
                    <div class="stat-card clickable" onclick="filterByTimeframe('today')">
                        <div class="stat-header">
                            <div class="stat-title">Today's Leads</div>
                            <div class="stat-icon">üìÖ</div>
                        </div>
                        <div class="stat-value" id="todayLeads">0</div>
                        <div class="stat-change stat-positive">Last 24 hours</div>
                    </div>

                    <div class="stat-card clickable" onclick="filterByTimeframe('month')">
                        <div class="stat-header">
                            <div class="stat-title">This Month</div>
                            <div class="stat-icon">üìä</div>
                        </div>
                        <div class="stat-value" id="monthLeads">0</div>
                        <div class="stat-change stat-positive">Month to date</div>
                    </div>

                    <div class="stat-card clickable" onclick="filterByTimeframe('all')">
                        <div class="stat-header">
                            <div class="stat-title">Total Leads</div>
                            <div class="stat-icon">üë•</div>
                        </div>
                        <div class="stat-value" id="totalLeads">0</div>
                        <div class="stat-change">All time</div>
                    </div>

                    <!-- Row 2: Quality-based metrics -->
                    <div class="stat-card priority clickable" onclick="filterByQuality('priority')">
                        <div class="stat-header">
                            <div class="stat-title">Priority Leads</div>
                            <div class="stat-icon">‚ö°</div>
                        </div>
                        <div class="stat-value" id="priorityLeads">0</div>
                        <div class="stat-change">Immediate + Decision Makers</div>
                    </div>

                    <div class="stat-card clickable" onclick="filterByQuality('hot')" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-color: #f87171;">
                        <div class="stat-header">
                            <div class="stat-title">Hot Leads (65+)</div>
                            <div class="stat-icon">üî•</div>
                        </div>
                        <div class="stat-value" id="hotLeads">0</div>
                        <div class="stat-change stat-positive">Ready for contact</div>
                    </div>

                    <div class="stat-card clickable" onclick="filterByQuality('warm')" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b;">
                        <div class="stat-header">
                            <div class="stat-title">Warm Leads (41-65)</div>
                            <div class="stat-icon">üå°Ô∏è</div>
                        </div>
                        <div class="stat-value" id="warmLeads">0</div>
                        <div class="stat-change">Follow-up needed</div>
                    </div>
                </div>

                <!-- FILTERS SECTION -->
                <div class="filters-section">
                    <div class="filters-header">
                        <h2 class="filters-title">Smart Filters</h2>
                        <button class="clear-filters-btn" onclick="clearAllFilters()">Clear All</button>
                    </div>

                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Search Leads</label>
                            <input type="text" class="filter-input" id="searchInput" placeholder="Name, email, business..." oninput="applyFilters()">
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Lead Status</label>
                            <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                                <option value="">All Statuses</option>
                                <option value="New">New</option>
                                <option value="Contacted">Contacted</option>
                                <option value="Qualified">Qualified</option>
                                <option value="Assigned">Assigned</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Lead Quality</label>
                            <select class="filter-select" id="qualityFilter" onchange="applyFilters()">
                                <option value="">All Qualities</option>
                                <option value="Hot">Hot (65+)</option>
                                <option value="Warm">Warm (41-65)</option>
                                <option value="Cold">Cold (<41)</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Timeline</label>
                            <select class="filter-select" id="timelineFilter" onchange="applyFilters()">
                                <option value="">All Timelines</option>
                                <option value="immediately">Immediately</option>
                                <option value="within_week">Within Week</option>
                                <option value="this_month">This Month</option>
                                <option value="just_checking">Just Checking</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Budget Range</label>
                            <select class="filter-select" id="budgetFilter" onchange="applyFilters()">
                                <option value="">All Budgets</option>
                                <option value="high">‚Çπ25,000+ (Premium)</option>
                                <option value="qualified">‚Çπ10,000-‚Çπ25,000</option>
                                <option value="budget_unqualified">‚Çπ5,000-‚Çπ10,000</option>
                                <option value="low"><‚Çπ5,000</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">Business Category</label>
                            <select class="filter-select" id="categoryFilter" onchange="applyFilters()">
                                <option value="">All Categories</option>
                                <option value="boutique">Boutique & Fashion</option>
                                <option value="home-foods">Home Foods</option>
                                <option value="salons">Salons & Beauty</option>
                                <option value="grocery">Grocery</option>
                                <option value="electronics">Electronics</option>
                            </select>
                        </div>
                    </div>

                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="toggleFilter('all', this)">All Leads</button>
                        <button class="filter-btn" onclick="toggleFilter('priority', this)">‚ö° Priority</button>
                        <button class="filter-btn" onclick="toggleFilter('high-budget', this)">üí∞ High Budget</button>
                        <button class="filter-btn" onclick="toggleFilter('decision-makers', this)">üëë Decision Makers</button>
                        <button class="filter-btn" onclick="toggleFilter('unassigned', this)">üìã Unassigned</button>
                    </div>
                </div>

                <!-- LEADS SECTION -->
                <div class="leads-section">
                    <div class="section-header">
                        <div>
                            <h2 class="section-title">Lead Management</h2>
                            <p style="color: #64748b; font-size: 0.9rem; margin-top: 0.25rem;" id="leadCount">Loading leads...</p>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <select id="sortBy" onchange="applySorting()" style="padding: 0.5rem; border-radius: 6px; border: 1px solid #d1d5db;">
                                <option value="created_at">Sort by Date</option>
                                <option value="lead_score">Sort by Score</option>
                                <option value="name">Sort by Name</option>
                                <option value="timeline">Sort by Timeline</option>
                            </select>
                            <button onclick="toggleSortOrder()" id="sortOrderBtn" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                ‚Üì Desc
                            </button>
                        </div>
                    </div>

                    <!-- LEADS GRID -->
                    <div class="leads-grid" id="leadsGrid">
                        <div class="loading">Loading leads...</div>
                    </div>
                </div>
            </section>

            <!-- ASSIGNED LEADS SECTION -->
            <section id="assigned-leads" class="crm-section" style="display: none;">
                <div class="crm-header">
                    <h1 class="crm-title">Assigned Leads Management</h1>
                    <div class="crm-user-info">
                        <div class="user-avatar">S</div>
                        <div>
                            <div style="font-weight: 600;">SDR Manager</div>
                            <div style="font-size: 0.85rem; color: #64748b;">Sales Team</div>
                        </div>
                    </div>
                </div>

                <!-- SDR Summary Cards -->
                <div class="sdr-summary-grid" id="sdrSummaryGrid">
                    <div class="loading">Loading SDR assignments...</div>
                </div>

                <!-- Leads by SDR -->
                <div class="leads-section">
                    <div class="section-header">
                        <div>
                            <h2 class="section-title">Leads by SDR</h2>
                            <p style="color: #64748b; font-size: 0.9rem; margin-top: 0.25rem;" id="assignedLeadCount">Loading assigned leads...</p>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <select id="sdrFilterSelect" onchange="filterBySDR()" style="padding: 0.5rem; border-radius: 6px; border: 1px solid #d1d5db;">
                                <option value="">All SDRs</option>
                            </select>
                            <select id="statusFilterSelect" onchange="filterByStatus()" style="padding: 0.5rem; border-radius: 6px; border: 1px solid #d1d5db;">
                                <option value="">All Statuses</option>
                                <option value="Assigned">Assigned</option>
                                <option value="Contacted">Contacted</option>
                                <option value="Qualified">Qualified</option>
                                <option value="Likely to Convert">Likely to Convert</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Assigned Leads Grid -->
                    <div class="leads-grid" id="assignedLeadsGrid">
                        <div class="loading">Loading assigned leads...</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- LEAD INTELLIGENCE PANEL - ENHANCED WITH ANALYTICS -->
    <div class="lead-intelligence-panel" id="leadIntelligencePanel">
        <div class="intelligence-header">
            <h3 class="intelligence-title">Lead Analytics & Insights</h3>
            <button class="intelligence-close" onclick="closeIntelligencePanel()">√ó</button>
        </div>

        <div class="score-display" id="scoreDisplay">
            <div class="score-value" id="leadScoreValue">0</div>
            <div class="score-label" id="leadScoreLabel">Analytics Score</div>
        </div>

        <div class="intelligence-section">
            <div class="intelligence-section-title">üí° AI Recommendations</div>
            <div id="aiRecommendations" style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 1rem;">
                <div style="font-size: 0.85rem; color: #059669; line-height: 1.5;" id="recommendationText">
                    Loading personalized recommendations...
                </div>
            </div>
        </div>

        <div class="intelligence-section">
            <div class="intelligence-section-title">üìä Behavioral Analytics</div>
            <div class="intelligence-item">
                <span class="intelligence-label">Engagement Level:</span>
                <span class="intelligence-value" id="engagementLevel">-</span>
            </div>
            <div class="intelligence-item">
                <span class="intelligence-label">Time Spent:</span>
                <span class="intelligence-value" id="timeSpent">-</span>
            </div>
            <div class="intelligence-item">
                <span class="intelligence-label">Page Views:</span>
                <span class="intelligence-value" id="pageViews">-</span>
            </div>
            <div class="intelligence-item">
                <span class="intelligence-label">Last Activity:</span>
                <span class="intelligence-value" id="lastActivity">-</span>
            </div>
        </div>

        <div class="intelligence-section">
            <div class="intelligence-section-title">üéØ Conversion Probability</div>
            <div id="conversionMeter" style="background: #f8fafc; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b;" id="conversionScore">0%</div>
                <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;">Based on similar leads</div>
                <div id="conversionBar" style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                    <div id="conversionProgress" style="height: 100%; background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981); width: 0%; transition: width 0.5s ease;"></div>
                </div>
            </div>
        </div>

        <div class="intelligence-section">
            <div class="intelligence-section-title">üìà Lead Journey</div>
            <div id="leadJourney" style="font-size: 0.85rem;">
                <div class="journey-step" style="display: flex; align-items: center; margin: 0.5rem 0; padding: 0.5rem; background: #f8fafc; border-radius: 6px;">
                    <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 0.75rem;"></div>
                    <div>
                        <div style="font-weight: 500; color: #1e293b;">Form Submitted</div>
                        <div style="color: #64748b; font-size: 0.75rem;" id="journeyFormDate">-</div>
                    </div>
                </div>
                <div class="journey-step" style="display: flex; align-items: center; margin: 0.5rem 0; padding: 0.5rem; background: #f8fafc; border-radius: 6px;">
                    <div style="width: 8px; height: 8px; background: #3b82f6; border-radius: 50%; margin-right: 0.75rem;"></div>
                    <div>
                        <div style="font-weight: 500; color: #1e293b;">Profile Completed</div>
                        <div style="color: #64748b; font-size: 0.75rem;" id="journeyProfileDate">-</div>
                    </div>
                </div>
                <div class="journey-step" style="display: flex; align-items: center; margin: 0.5rem 0; padding: 0.5rem; background: #f8fafc; border-radius: 6px;">
                    <div style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%; margin-right: 0.75rem;"></div>
                    <div>
                        <div style="font-weight: 500; color: #1e293b;">Categories Selected</div>
                        <div style="color: #64748b; font-size: 0.75rem;" id="journeyCategoriesDate">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="intelligence-section">
            <div class="intelligence-section-title">üìù Quick Notes</div>
            <textarea id="leadNotes" placeholder="Add notes about this lead..." 
                      style="width: 100%; min-height: 80px; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.85rem; resize: vertical; font-family: inherit;">
            </textarea>
            <button onclick="saveLeadNotes()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">
                Save Notes
            </button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
            <button class="action-button" onclick="initiateCall()" id="callButton">
                üìû Call Lead
            </button>
            <button class="action-button" onclick="sendEmail()" style="background: #8b5cf6;">
                üìß Send Email
            </button>
        </div>
    </div>

    <!-- SCORE BREAKDOWN MODAL -->
    <div class="score-breakdown-modal" id="scoreBreakdownModal">
        <div class="score-breakdown-content">
            <div class="score-breakdown-header">
                <h3 class="score-breakdown-title">Lead Score Breakdown</h3>
                <button class="score-close" onclick="closeScoreBreakdown()">√ó</button>
            </div>
            
            <div id="scoreBreakdownItems">
                <!-- Score items will be populated here -->
            </div>
            
            <div class="score-total">
                <div class="score-total-value" id="totalScoreValue">0</div>
                <div class="score-total-label">Total Lead Score</div>
            </div>
        </div>
    </div>

    <!-- FOLLOWUP DATE MODAL -->
    <div class="followup-modal" id="followupModal">
        <div class="followup-content">
            <h3 style="margin-bottom: 1rem; color: #1e293b;">Set Next Followup Date</h3>
            <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                When should we follow up with <span id="followupLeadName">this lead</span>?
            </p>
            <input type="datetime-local" id="followupDateInput" class="followup-input">
            <div class="followup-buttons">
                <button class="btn-cancel" onclick="closeFollowupModal()">Cancel</button>
                <button class="btn-save" onclick="saveFollowupDate()">Set Followup</button>
            </div>
        </div>
    </div>

    <script>
        // SUPABASE CONFIGURATION
        const SUPABASE_URL = 'https://xssbtsfjtwjholygdbqo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhzc2J0c2ZqdHdqaG9seWdkYnFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxOTk5MjUsImV4cCI6MjA2ODc3NTkyNX0.eOSIHTpvllcH-fK6MARoe5HPiXlujsrzUWfAhmUh94k';

        // GLOBAL STATE
        let allLeads = [];
        let filteredLeads = [];
        let sdrTeam = [];
        let currentSelectedLead = null;
        let currentSort = { field: 'created_at', order: 'desc' };
        let activeFilters = {
            search: '',
            status: '',
            quality: '',
            timeline: '',
            budget: '',
            category: '',
            filterType: 'all',
            timeframe: 'all',
            sdr: '',
            assignedStatus: ''
        };

        // UTILITY FUNCTIONS
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 400);
            }, 3000);
        }

        function getTimeAgo(dateString) {
            if (!dateString) return 'Unknown';
            
            const now = new Date();
            const past = new Date(dateString);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        function isPriorityLead(lead) {
            return lead.timeline === 'immediately' && lead.decision_maker === true;
        }

        function isHighBudgetLead(lead) {
            return lead.budget_range === 'high';
        }

        // DATA FETCHING FUNCTIONS
        async function fetchLeads() {
            try {
                console.log('üîç Fetching leads from multiple sources...');
                
                let allSources = [];
                let successCount = 0;
                let errorCount = 0;
                
                // Try localStorage first (fastest)
                const localLeads = loadFromLocalStorage();
                if (localLeads.length > 0) {
                    allSources.push(...localLeads);
                    console.log(`üì± Loaded ${localLeads.length} leads from localStorage`);
                    successCount++;
                }
                
                // Try Supabase sources with better error handling
                try {
                    const users = await fetchUsers();
                    if (users.length > 0) {
                        allSources.push(...users);
                        console.log(`üë• Loaded ${users.length} users from Supabase`);
                        successCount++;
                    }
                } catch (error) {
                    console.warn('‚ùå Users fetch failed:', error.message);
                    errorCount++;
                }
                
                try {
                    const intelligence = await fetchLeadIntelligence();
                    console.log(`üß† Loaded ${intelligence.length} intelligence records`);
                } catch (error) {
                    console.warn('‚ùå Intelligence fetch failed:', error.message);
                }
                
                try {
                    const crmLeads = await fetchCRMLeads();
                    if (crmLeads.length > 0) {
                        allSources.push(...crmLeads);
                        console.log(`üìä Loaded ${crmLeads.length} CRM leads`);
                        successCount++;
                    }
                } catch (error) {
                    console.warn('‚ùå CRM leads fetch failed:', error.message);
                    errorCount++;
                }
                
                // If no data from any source, load demo data
                if (allSources.length === 0) {
                    console.log('üìã No data found, loading demo data...');
                    allSources = generateDemoLeads();
                    showNotification('Demo data loaded - Connect to database for live data', 'info');
                }
                
                // Process and combine data
                const processedLeads = processCombinedLeads(allSources);
                allLeads = processedLeads;
                
                console.log(`‚úÖ Total processed leads: ${allLeads.length}`);
                console.log(`üìä Success: ${successCount}, Errors: ${errorCount}`);
                
                updateDashboardStats();
                applyFilters();
                
                // Show status notification
                if (errorCount > 0 && successCount > 0) {
                    showNotification(`Loaded ${allLeads.length} leads (some sources failed)`, 'info');
                } else if (errorCount === 0 && successCount > 0) {
                    showNotification(`Successfully loaded ${allLeads.length} leads`, 'success');
                }
                
                return allLeads.length;
                
            } catch (error) {
                console.error('‚ùå Critical error in fetchLeads:', error);
                
                // Emergency fallback to demo data
                console.log('üö® Loading emergency demo data...');
                allLeads = generateDemoLeads();
                updateDashboardStats();
                applyFilters();
                
                showNotification('Using demo data - Check network connection', 'error');
                return allLeads.length;
            }
        }

        function loadFromLocalStorage() {
            try {
                const storedLeads = localStorage.getItem('topiko_local_leads');
                return storedLeads ? JSON.parse(storedLeads) : [];
            } catch (error) {
                console.warn('‚ùå localStorage read failed:', error);
                return [];
            }
        }

        async function fetchUsers() {
            console.log('üë• Fetching users from Supabase...');
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/users?select=*&order=created_at.desc&limit=100`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Request timeout');
                }
                throw error;
            }
        }

        // DATA FETCHING FUNCTIONS
        async function fetchLeads() {
            try {
                console.log('üîç Fetching leads from multiple sources...');
                
                let allSources = [];
                let successCount = 0;
                let errorCount = 0;
                
                // Try localStorage first (fastest)
                const localLeads = loadFromLocalStorage();
                if (localLeads.length > 0) {
                    allSources.push(...localLeads);
                    console.log(`üì± Loaded ${localLeads.length} leads from localStorage`);
                    successCount++;
                }
                
                // Try Supabase sources with better error handling
                try {
                    const users = await fetchUsers();
                    if (users.length > 0) {
                        allSources.push(...users);
                        console.log(`üë• Loaded ${users.length} users from Supabase`);
                        successCount++;
                    }
                } catch (error) {
                    console.warn('‚ùå Users fetch failed:', error.message);
                    errorCount++;
                }
                
                try {
                    const intelligence = await fetchLeadIntelligence();
                    console.log(`üß† Loaded ${intelligence.length} intelligence records`);
                } catch (error) {
                    console.warn('‚ùå Intelligence fetch failed:', error.message);
                }
                
                try {
                    const crmLeads = await fetchCRMLeads();
                    if (crmLeads.length > 0) {
                        allSources.push(...crmLeads);
                        console.log(`üìä Loaded ${crmLeads.length} CRM leads`);
                        successCount++;
                    }
                } catch (error) {
                    console.warn('‚ùå CRM leads fetch failed:', error.message);
                    errorCount++;
                }
                
                // If no data from any source, load demo data
                if (allSources.length === 0) {
                    console.log('üìã No data found, loading demo data...');
                    allSources = generateDemoLeads();
                    showNotification('Demo data loaded - Connect to database for live data', 'info');
                }
                
                // Process and combine data
                const processedLeads = processCombinedLeads(allSources);
                allLeads = processedLeads;
                
                console.log(`‚úÖ Total processed leads: ${allLeads.length}`);
                console.log(`üìä Success: ${successCount}, Errors: ${errorCount}`);
                
                updateDashboardStats();
                applyFilters();
                
                // Show status notification
                if (errorCount > 0 && successCount > 0) {
                    showNotification(`Loaded ${allLeads.length} leads (some sources failed)`, 'info');
                } else if (errorCount === 0 && successCount > 0) {
                    showNotification(`Successfully loaded ${allLeads.length} leads`, 'success');
                }
                
                return allLeads.length;
                
            } catch (error) {
                console.error('‚ùå Critical error in fetchLeads:', error);
                
                // Emergency fallback to demo data
                console.log('üö® Loading emergency demo data...');
                allLeads = generateDemoLeads();
                updateDashboardStats();
                applyFilters();
                
                showNotification('Using demo data - Check network connection', 'error');
                return allLeads.length;
            }
        }

        function loadFromLocalStorage() {
            try {
                const storedLeads = localStorage.getItem('topiko_local_leads');
                return storedLeads ? JSON.parse(storedLeads) : [];
            } catch (error) {
                console.warn('‚ùå localStorage read failed:', error);
                return [];
            }
        }

        async function fetchUsers() {
            console.log('üë• Fetching users from Supabase...');
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/users?select=*&order=created_at.desc&limit=100`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Request timeout');
                }
                throw error;
            }
        }

        async function fetchLeadIntelligence() {
            console.log('üß† Fetching lead intelligence...');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/lead_intelligence?select=*&order=created_at.desc&limit=100`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) return [];
                return await response.json();
            } catch (error) {
                console.warn('‚ùå Lead intelligence table not accessible');
                return [];
            }
        }

        async function fetchCRMLeads() {
            console.log('üìä Fetching CRM leads...');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/crm_leads?select=*&order=created_at.desc&limit=50`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) return [];
                return await response.json();
            } catch (error) {
                console.warn('‚ùå CRM leads table not accessible');
                return [];
            }
        }

        async function fetchSDRTeam() {
            console.log('üë®‚Äçüíº Fetching SDR team...');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/sdr_users?select=*&order=name.asc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    sdrTeam = await response.json();
                    console.log(`‚úÖ Loaded ${sdrTeam.length} SDRs`);
                } else {
                    // Fallback to demo SDRs
                    sdrTeam = generateDemoSDRs();
                    console.log('üìã Using demo SDR data');
                }
                
                updateSDRDropdowns();
                return sdrTeam;
                
            } catch (error) {
                console.warn('‚ùå SDR fetch failed, using demo data:', error);
                sdrTeam = generateDemoSDRs();
                updateSDRDropdowns();
                return sdrTeam;
            }
        }

        function generateDemoSDRs() {
            return [
                { id: 'sdr_001', name: 'Rahul Sharma', email: 'rahul@topiko.com', is_active: true, current_leads: 0 },
                { id: 'sdr_002', name: 'Priya Patel', email: 'priya@topiko.com', is_active: true, current_leads: 0 },
                { id: 'sdr_003', name: 'Vikram Singh', email: 'vikram@topiko.com', is_active: true, current_leads: 0 },
                { id: 'sdr_004', name: 'Anita Kumar', email: 'anita@topiko.com', is_active: true, current_leads: 0 },
                { id: 'sdr_005', name: 'Ravi Mehta', email: 'ravi@topiko.com', is_active: true, current_leads: 0 }
            ];
        }

        function generateDemoLeads() {
            const demoLeads = [];
            const businesses = [
                'TrendyWear Boutique', 'Spice Magic Foods', 'Beauty Parlour Deluxe', 'Fresh Mart Grocery',
                'Tech Solutions Hub', 'Fitness First Gym', 'Golden Jewellers', 'Cafe Coffee Corner',
                'Home Decor Palace', 'Kids Fashion Store'
            ];
            
            const names = [
                'Amit Sharma', 'Priya Singh', 'Rajesh Kumar', 'Sunita Patel', 'Vikram Gupta',
                'Kavya Reddy', 'Arjun Mehta', 'Deepika Jain', 'Rohit Agarwal', 'Sneha Verma'
            ];
            
            const goals = ['ecommerce', 'customers', 'manage', 'search', 'brand'];
            const timelines = ['immediately', 'within_week', 'this_month', 'just_checking'];
            const budgets = ['high', 'qualified', 'budget_unqualified', 'low'];
            const categories = ['boutique', 'home-foods', 'salons', 'grocery', 'electronics'];
            
            for (let i = 0; i < 25; i++) {
                const createdDate = new Date();
                createdDate.setDate(createdDate.getDate() - Math.floor(Math.random() * 30));
                
                const lead = {
                    id: `demo_lead_${i + 1}`,
                    name: names[i % names.length],
                    email: `${names[i % names.length].toLowerCase().replace(' ', '.')}@example.com`,
                    phone: `+91 ${Math.floor(Math.random() * 9000000000) + 1000000000}`,
                    business_name: businesses[i % businesses.length],
                    selected_goals: [goals[Math.floor(Math.random() * goals.length)]],
                    timeline: timelines[Math.floor(Math.random() * timelines.length)],
                    budget_range: budgets[Math.floor(Math.random() * budgets.length)],
                    decision_maker: Math.random() > 0.6,
                    online_presence: Math.random() > 0.5 ? 'social' : 'none',
                    session_duration_minutes: Math.floor(Math.random() * 15) + 1,
                    products_count: Math.floor(Math.random() * 10),
                    selected_categories: [categories[Math.floor(Math.random() * categories.length)]],
                    selected_subcategories: [],
                    lead_status: 'New',
                    assigned_sdr_id: Math.random() > 0.7 ? sdrTeam[Math.floor(Math.random() * sdrTeam.length)]?.id : null,
                    created_at: createdDate.toISOString(),
                    utm_source: 'Direct',
                    device_type: Math.random() > 0.5 ? 'Mobile' : 'Desktop',
                    data_source: 'demo'
                };
                
                demoLeads.push(processLeadData(lead));
            }
            
            return demoLeads;
        }

        function processCombinedLeads(sources) {
            return sources.map(source => processLeadData(source));
        }

        function processLeadData(rawLead) {
            const intel = rawLead.lead_intelligence || {};
            
            // Calculate lead score
            const leadScore = calculateLeadScore(rawLead);
            const leadQuality = getQualityFromScore(leadScore);
            
            return {
                id: rawLead.user_id || rawLead.id || generateId(),
                user_id: rawLead.user_id || rawLead.id,
                
                // Basic info
                name: rawLead.name || 'Unknown Lead',
                email: rawLead.email || '',
                phone: rawLead.phone || '',
                business_name: rawLead.business_name || 'Unknown Business',
                address: rawLead.address || '',
                business_type: rawLead.business_type || '',
                business_category: rawLead.business_category || '',
                
                // Scoring
                lead_score: leadScore,
                lead_quality: leadQuality,
                
                // Goals and categories
                selected_goals: rawLead.selected_goals || [],
                goals_display: formatGoalsForDisplay(rawLead.selected_goals || []),
                selected_categories: rawLead.selected_categories || intel.selected_categories || [],
                selected_subcategories: rawLead.selected_subcategories || intel.selected_subcategories || [],
                
                // Qualification data
                timeline: rawLead.timeline || intel.timeline || 'just_checking',
                budget_range: rawLead.budget_range || intel.budget_range || 'low',
                decision_maker: rawLead.decision_maker || intel.decision_maker || false,
                online_presence: rawLead.online_presence || intel.online_presence || 'none',
                
                // Engagement data
                session_duration_minutes: intel.session_duration_minutes || 0,
                page_views: intel.page_views || 1,
                utm_source: intel.utm_source || 'Direct',
                device_type: intel.device_type || 'Unknown',
                
                // Products
                products_count: rawLead.products_count || 0,
                
                // Status
                lead_status: intel.lead_status || 'New',
                assigned_sdr_id: intel.assigned_sdr_id || null,
                
                // Timestamps
                created_at: rawLead.created_at || new Date().toISOString(),
                
                // Source
                data_source: rawLead.lead_intelligence ? 'supabase' : 'crm'
            };
        }

        function calculateLeadScore(lead) {
            let score = 0;
            
            // Basic completion (20 points)
            if (lead.name && lead.email && lead.phone && lead.business_name) {
                score += 20;
            }
            
            // Goals (25 points max)
            const goals = lead.selected_goals || [];
            score += Math.min(goals.length * 5, 25);
            
            // Categories (20 points max)
            const categories = lead.selected_categories || [];
            const subcategories = lead.selected_subcategories || [];
            score += Math.min((categories.length + subcategories.length) * 2, 20);
            
            // Products (25 points max)
            score += Math.min((lead.products_count || 0) * 5, 25);
            
            // Qualification factors
            if (lead.budget_range === 'qualified' || lead.budget_range === 'high') {
                score += 5;
            }
            
            if (lead.decision_maker) {
                score += 5;
            }
            
            // Timeline urgency
            if (lead.timeline === 'immediately') {
                score += 10;
            } else if (lead.timeline === 'within_week') {
                score += 5;
            }
            
            return Math.min(score, 100);
        }

        function getQualityFromScore(score) {
            if (score >= 65) return 'Hot';
            if (score >= 41) return 'Warm';
            return 'Cold';
        }

        function formatGoalsForDisplay(goals) {
            const goalLabels = {
                'ecommerce': 'Sell Online (E-commerce)',
                'customers': 'Reach More Customers',
                'manage': 'Manage Customers',
                'search': 'Appear in Search Results',
                'brand': 'Establish my Brand'
            };
            
            return goals.map(goal => goalLabels[goal] || goal);
        }

        function generateId() {
            return 'lead_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // DASHBOARD FUNCTIONS
        function updateDashboardStats() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            // Time-based metrics
            const todayLeads = allLeads.filter(lead => new Date(lead.created_at) >= today).length;
            const monthLeads = allLeads.filter(lead => new Date(lead.created_at) >= thisMonth).length;
            const totalLeads = allLeads.length;
            
            // Quality-based metrics
            const hotLeads = allLeads.filter(lead => lead.lead_score >= 65).length;
            const warmLeads = allLeads.filter(lead => lead.lead_score >= 41 && lead.lead_score < 65).length;
            const priorityLeads = allLeads.filter(lead => isPriorityLead(lead)).length;
            
            // Update UI
            document.getElementById('todayLeads').textContent = todayLeads;
            document.getElementById('monthLeads').textContent = monthLeads;
            document.getElementById('totalLeads').textContent = totalLeads;
            document.getElementById('hotLeads').textContent = hotLeads;
            document.getElementById('warmLeads').textContent = warmLeads;
            document.getElementById('priorityLeads').textContent = priorityLeads;
            
            console.log(`üìä Stats updated: Today=${todayLeads}, Month=${monthLeads}, Total=${totalLeads}, Hot=${hotLeads}, Warm=${warmLeads}, Priority=${priorityLeads}`);
        }

        // STAT CARD CLICK HANDLERS
        function filterByTimeframe(timeframe) {
            // Reset all active stat cards
            document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
            
            // Set active timeframe
            activeFilters.timeframe = timeframe;
            
            // Highlight clicked card
            event.target.closest('.stat-card').classList.add('active');
            
            applyFilters();
            
            let filterMessage = '';
            switch(timeframe) {
                case 'today':
                    filterMessage = "Showing today's leads";
                    break;
                case 'month':
                    filterMessage = "Showing this month's leads";
                    break;
                case 'all':
                    filterMessage = "Showing all leads";
                    break;
            }
            
            showNotification(filterMessage, 'info');
        }

        function filterByQuality(quality) {
            // Reset all active stat cards
            document.querySelectorAll('.stat-card').forEach(card => card.classList.remove('active'));
            
            // Set active quality filter
            activeFilters.filterType = quality;
            
            // Highlight clicked card
            event.target.closest('.stat-card').classList.add('active');
            
            applyFilters();
            
            let filterMessage = '';
            switch(quality) {
                case 'priority':
                    filterMessage = "Showing priority leads";
                    break;
                case 'hot':
                    filterMessage = "Showing hot leads (65+)";
                    break;
                case 'warm':
                    filterMessage = "Showing warm leads (41-65)";
                    break;
            }
            
            showNotification(filterMessage, 'info');
        }

        // FILTERING FUNCTIONS
        function applyFilters() {
            // Get filter values
            activeFilters.search = document.getElementById('searchInput')?.value.toLowerCase() || '';
            activeFilters.status = document.getElementById('statusFilter')?.value || '';
            activeFilters.quality = document.getElementById('qualityFilter')?.value || '';
            activeFilters.timeline = document.getElementById('timelineFilter')?.value || '';
            activeFilters.budget = document.getElementById('budgetFilter')?.value || '';
            activeFilters.category = document.getElementById('categoryFilter')?.value || '';
            
            filteredLeads = [...allLeads];
            
            // Apply timeframe filter
            if (activeFilters.timeframe && activeFilters.timeframe !== 'all') {
                const now = new Date();
                let startDate;
                
                if (activeFilters.timeframe === 'today') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                } else if (activeFilters.timeframe === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                }
                
                if (startDate) {
                    filteredLeads = filteredLeads.filter(lead => new Date(lead.created_at) >= startDate);
                }
            }
            
            // Apply search filter
            if (activeFilters.search) {
                filteredLeads = filteredLeads.filter(lead => 
                    lead.name.toLowerCase().includes(activeFilters.search) ||
                    lead.email.toLowerCase().includes(activeFilters.search) ||
                    lead.business_name.toLowerCase().includes(activeFilters.search) ||
                    lead.phone.includes(activeFilters.search)
                );
            }
            
            // Apply other filters
            if (activeFilters.status) {
                filteredLeads = filteredLeads.filter(lead => lead.lead_status === activeFilters.status);
            }
            
            if (activeFilters.quality) {
                filteredLeads = filteredLeads.filter(lead => lead.lead_quality === activeFilters.quality);
            }
            
            if (activeFilters.timeline) {
                filteredLeads = filteredLeads.filter(lead => lead.timeline === activeFilters.timeline);
            }
            
            if (activeFilters.budget) {
                filteredLeads = filteredLeads.filter(lead => lead.budget_range === activeFilters.budget);
            }
            
            if (activeFilters.category) {
                filteredLeads = filteredLeads.filter(lead => lead.business_category === activeFilters.category);
            }
            
            // Apply special filters
            switch (activeFilters.filterType) {
                case 'priority':
                    filteredLeads = filteredLeads.filter(lead => isPriorityLead(lead));
                    break;
                case 'hot':
                    filteredLeads = filteredLeads.filter(lead => lead.lead_score >= 65);
                    break;
                case 'warm':
                    filteredLeads = filteredLeads.filter(lead => lead.lead_score >= 41 && lead.lead_score < 65);
                    break;
                case 'high-budget':
                    filteredLeads = filteredLeads.filter(lead => isHighBudgetLead(lead));
                    break;
                case 'decision-makers':
                    filteredLeads = filteredLeads.filter(lead => lead.decision_maker === true);
                    break;
                case 'unassigned':
                    filteredLeads = filteredLeads.filter(lead => !lead.assigned_sdr_id);
                    break;
            }
            
            applySorting();
        }

        function filterBySDR() {
            const selectedSDR = document.getElementById('sdrFilterSelect')?.value;
            activeFilters.sdr = selectedSDR;
            renderAssignedLeads();
        }

        function filterByStatus() {
            const selectedStatus = document.getElementById('statusFilterSelect')?.value;
            activeFilters.assignedStatus = selectedStatus;
            renderAssignedLeads();
        }

        function toggleFilter(filterType, element) {
            // Update active filter
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            
            activeFilters.filterType = filterType;
            applyFilters();
        }

        function clearAllFilters() {
            // Reset form inputs
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('qualityFilter').value = '';
            document.getElementById('timelineFilter').value = '';
            document.getElementById('budgetFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            
            // Reset active filters
            activeFilters = {
                search: '',
                status: '',
                quality: '',
                timeline: '',
                budget: '',
                category: '',
                filterType: 'all'
            };
            
            // Reset filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.filter-btn').classList.add('active');
            
            applyFilters();
            showNotification('All filters cleared', 'info');
        }

        // SORTING FUNCTIONS
        function applySorting() {
            const sortBy = document.getElementById('sortBy')?.value || currentSort.field;
            currentSort.field = sortBy;
            
            filteredLeads.sort((a, b) => {
                let aVal, bVal;
                
                switch (sortBy) {
                    case 'lead_score':
                        aVal = a.lead_score || 0;
                        bVal = b.lead_score || 0;
                        break;
                    case 'name':
                        aVal = a.name.toLowerCase();
                        bVal = b.name.toLowerCase();
                        break;
                    case 'timeline':
                        const timelineOrder = { 'immediately': 4, 'within_week': 3, 'this_month': 2, 'just_checking': 1 };
                        aVal = timelineOrder[a.timeline] || 0;
                        bVal = timelineOrder[b.timeline] || 0;
                        break;
                    case 'created_at':
                    default:
                        aVal = new Date(a.created_at);
                        bVal = new Date(b.created_at);
                        break;
                }
                
                if (currentSort.order === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            renderLeads();
        }

        function toggleSortOrder() {
            currentSort.order = currentSort.order === 'desc' ? 'asc' : 'desc';
            const btn = document.getElementById('sortOrderBtn');
            btn.textContent = currentSort.order === 'desc' ? '‚Üì Desc' : '‚Üë Asc';
            applySorting();
        }

        // RENDERING FUNCTIONS
        function renderLeads() {
            const leadsGrid = document.getElementById('leadsGrid');
            const leadCount = document.getElementById('leadCount');
            
            leadCount.textContent = `${filteredLeads.length} leads found`;
            
            if (filteredLeads.length === 0) {
                leadsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #64748b;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                        <h3 style="margin-bottom: 0.5rem;">No leads found</h3>
                        <p>Try adjusting your filters or check back later</p>
                        <button onclick="clearAllFilters()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Clear Filters
                        </button>
                    </div>
                `;
                return;
            }
            
            const leadsHTML = filteredLeads.slice(0, 20).map(lead => createLeadCard(lead)).join('');
            leadsGrid.innerHTML = leadsHTML;
            
            if (filteredLeads.length > 20) {
                leadsGrid.innerHTML += `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #64748b; background: #f8fafc; border-radius: 12px;">
                        Showing first 20 of ${filteredLeads.length} leads. Use filters to narrow results.
                    </div>
                `;
            }
        }

        function createLeadCard(lead) {
            const budgetLabels = {
                'high': '‚Çπ25,000+',
                'qualified': '‚Çπ10,000-‚Çπ25,000',
                'budget_unqualified': '‚Çπ5,000-‚Çπ10,000',
                'low': '<‚Çπ5,000'
            };
            
            const timelineLabels = {
                'immediately': 'Immediately',
                'within_week': 'Within Week',
                'this_month': 'This Month',
                'just_checking': 'Just Checking'
            };
            
            let cardClasses = 'lead-card fade-in';
            if (isPriorityLead(lead)) cardClasses += ' priority';
            else if (isHighBudgetLead(lead)) cardClasses += ' high-budget';
            
            const goalsHTML = lead.goals_display.slice(0, 3).map(goal => 
                `<span class="card-tag goal-tag">${goal}</span>`
            ).join('');
            
            const categoriesHTML = lead.selected_categories.slice(0, 2).map(cat => 
                `<span class="card-tag category-tag">${cat}</span>`
            ).join('');
            
            let badges = '';
            if (isPriorityLead(lead)) badges += '<span class="badge badge-priority">Priority</span>';
            if (isHighBudgetLead(lead)) badges += '<span class="badge badge-high-budget">High Budget</span>';
            if (lead.decision_maker) badges += '<span class="badge badge-decision-maker">Decision Maker</span>';
            
            const timelineClass = lead.timeline === 'immediately' ? 'immediate' : 
                                 lead.timeline === 'within_week' ? 'week' : '';
            badges += `<span class="badge badge-timeline ${timelineClass}">${timelineLabels[lead.timeline]}</span>`;
            
            // Format date and time
            const leadDate = new Date(lead.created_at);
            const formattedDate = leadDate.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
            const formattedTime = leadDate.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Get assigned SDR name
            const assignedSDR = lead.assigned_sdr_id ? 
                sdrTeam.find(sdr => sdr.id === lead.assigned_sdr_id)?.name || 'Unknown SDR' : 
                'Unassigned';

            // Current status and followup date
            const currentStatus = lead.lead_pipeline_status || 'New';
            const nextFollowup = lead.next_followup_date ? 
                new Date(lead.next_followup_date).toLocaleDateString('en-IN') : 
                'Not set';
            
            return `
                <div class="${cardClasses}">
                    <div class="lead-card-top">
                        <div class="lead-date">${formattedDate} ‚Ä¢ ${formattedTime}</div>
                        <div class="lead-assigned-sdr">${assignedSDR}</div>
                    </div>
                    
                    <div class="lead-card-header">
                        <div class="lead-info">
                            <div class="lead-name">${lead.name}</div>
                            <div class="lead-business">${lead.business_name}</div>
                            <div class="lead-contact">üìß ${lead.email}</div>
                            <div class="lead-contact">üìû ${lead.phone}</div>
                        </div>
                        <div class="lead-score-badge score-${lead.lead_quality.toLowerCase()}" 
                             onclick="showScoreBreakdown('${lead.id}')" 
                             style="cursor: pointer;" 
                             title="Click to see score breakdown">
                            ${lead.lead_score}
                        </div>
                    </div>
                    
                    <div class="lead-card-body">
                        ${goalsHTML ? `
                        <div class="card-section">
                            <div class="card-section-title">Goals</div>
                            <div class="card-tags">${goalsHTML}</div>
                        </div>` : ''}
                        
                        ${categoriesHTML ? `
                        <div class="card-section">
                            <div class="card-section-title">Categories</div>
                            <div class="card-tags">${categoriesHTML}</div>
                        </div>` : ''}
                        
                        ${badges ? `
                        <div class="card-section">
                            <div class="card-section-title">Qualification</div>
                            <div class="card-tags">${badges}</div>
                        </div>` : ''}
                        
                        <div class="card-details">
                            <div class="detail-item">
                                <span class="detail-label">Budget:</span>
                                ${budgetLabels[lead.budget_range] || lead.budget_range}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Source:</span>
                                ${lead.utm_source}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Session:</span>
                                ${lead.session_duration_minutes}min
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Products:</span>
                                ${lead.products_count}
                            </div>
                        </div>
                        
                        <div class="card-status">
                            <span class="status-badge status-${lead.lead_status.toLowerCase().replace(' ', '-')}">
                                ${lead.lead_status}
                            </span>
                            <span class="assigned-sdr">
                                ${getTimeAgo(lead.created_at)}
                            </span>
                        </div>
                    </div>
                    
                    <div class="card-actions">
                        <div class="sdr-dropdown">
                            <button class="action-btn btn-assign ${lead.assigned_sdr_id ? 'reassign' : ''}" 
                                    onclick="toggleSDRDropdown('${lead.id}', event)">
                                ${lead.assigned_sdr_id ? '‚Üª Re-assign' : 'üë®‚Äçüíº Assign'}
                            </button>
                            <div class="sdr-dropdown-content" id="sdrDropdown-${lead.id}">
                                ${sdrTeam.map(sdr => `
                                    <div class="sdr-option" onclick="assignLeadToSDR('${lead.id}', '${sdr.id}')">
                                        ${sdr.name}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="status-dropdown">
                            <button class="action-btn btn-status" onclick="toggleStatusDropdown('${lead.id}', event)">
                                üìä Status
                            </button>
                            <div class="status-dropdown-content" id="statusDropdown-${lead.id}">
                                <div class="status-option" onclick="updateLeadStatus('${lead.id}', 'Contacted')">Contacted</div>
                                <div class="status-option" onclick="updateLeadStatus('${lead.id}', 'Not Reachable')">Not Reachable</div>
                                <div class="status-option" onclick="updateLeadStatus('${lead.id}', 'Demo Requested')">Demo Requested</div>
                                <div class="status-option" onclick="updateLeadStatus('${lead.id}', 'Samples Requested')">Samples Requested</div>
                                <div class="status-option" onclick="updateLeadStatus('${lead.id}', 'Dropped-Budget')">Dropped-Budget</div>
                                <div class="status-option" onclick="updateLeadStatus('${lead.id}', 'Converted')">Converted</div>
                            </div>
                        </div>
                        
                        <button class="action-btn btn-intel" onclick="showLeadIntelligence('${lead.id}')">
                            üìà Analytics
                        </button>
                    </div>

                    <div class="card-status-section">
                        <div class="detail-item">
                            <span class="detail-label">Pipeline Status:</span>
                            <span style="font-weight: 600; color: #3b82f6;">${currentStatus}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Next Followup:</span>
                            <span style="cursor: pointer; color: #8b5cf6; text-decoration: underline;" 
                                  onclick="setFollowupDate('${lead.id}')">${nextFollowup}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // SDR MANAGEMENT FUNCTIONS
        function updateSDRDropdowns() {
            const sdrFilterSelect = document.getElementById('sdrFilterSelect');
            if (sdrFilterSelect) {
                // Clear existing options (keep "All SDRs")
                while (sdrFilterSelect.children.length > 1) {
                    sdrFilterSelect.removeChild(sdrFilterSelect.lastChild);
                }
                
                // Add SDR options
                sdrTeam.forEach(sdr => {
                    if (sdr.is_active) {
                        const option = document.createElement('option');
                        option.value = sdr.id;
                        option.textContent = sdr.name;
                        sdrFilterSelect.appendChild(option);
                    }
                });
            }
        }

        function toggleSDRDropdown(leadId, event) {
            event.stopPropagation();
            
            // Close all other dropdowns
            document.querySelectorAll('.sdr-dropdown-content').forEach(dropdown => {
                if (dropdown.id !== `sdrDropdown-${leadId}`) {
                    dropdown.classList.remove('show');
                }
            });
            
            // Get current dropdown
            const dropdown = document.getElementById(`sdrDropdown-${leadId}`);
            const button = event.target;
            const card = button.closest('.lead-card');
            
            // Remove any positioning classes
            dropdown.classList.remove('dropdown-up', 'dropdown-right');
            
            // Check if dropdown would go off screen
            const rect = button.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            const dropdownHeight = 200; // max-height
            const dropdownWidth = 200; // min-width
            
            // Position dropdown up if it would go off bottom of screen
            if (rect.bottom + dropdownHeight > viewportHeight - 20) {
                dropdown.classList.add('dropdown-up');
            }
            
            // Position dropdown left if it would go off right side of screen
            if (rect.left + dropdownWidth > viewportWidth - 20) {
                dropdown.classList.add('dropdown-right');
            }
            
            // Toggle dropdown visibility
            dropdown.classList.toggle('show');
            
            // Add higher z-index to parent card when dropdown is open
            if (dropdown.classList.contains('show')) {
                card.style.zIndex = '999';
            } else {
                card.style.zIndex = '1';
            }
            
            // Close dropdown when clicking outside
            if (dropdown.classList.contains('show')) {
                setTimeout(() => {
                    document.addEventListener('click', function closeDropdown(e) {
                        if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                            dropdown.classList.remove('show');
                            card.style.zIndex = '1';
                            document.removeEventListener('click', closeDropdown);
                        }
                    });
                }, 100);
            }
        }

        function assignLeadToSDR(leadId, sdrId) {
            const lead = allLeads.find(l => l.id === leadId);
            const sdr = sdrTeam.find(s => s.id === sdrId);
            
            if (!lead || !sdr) return;
            
            lead.assigned_sdr_id = sdrId;
            lead.lead_status = 'Assigned';
            
            // Close dropdown and reset z-index
            const dropdown = document.getElementById(`sdrDropdown-${leadId}`);
            const card = dropdown.closest('.lead-card');
            
            dropdown.classList.remove('show');
            if (card) card.style.zIndex = '1';
            
            showNotification(`${lead.name} assigned to ${sdr.name}`, 'success');
            
            // Re-render leads
            renderLeads();
            updateDashboardStats();
            
            // Update assigned leads if on that page
            if (document.getElementById('assigned-leads').style.display !== 'none') {
                renderAssignedLeads();
            }
        }

        // ASSIGNED LEADS FUNCTIONS
        function renderAssignedLeads() {
            let assignedLeads = allLeads.filter(lead => lead.assigned_sdr_id);
            
            // Apply filters
            if (activeFilters.sdr) {
                assignedLeads = assignedLeads.filter(lead => lead.assigned_sdr_id === activeFilters.sdr);
            }
            
            if (activeFilters.assignedStatus) {
                assignedLeads = assignedLeads.filter(lead => lead.lead_status === activeFilters.assignedStatus);
            }
            
            // Update count
            const assignedLeadCount = document.getElementById('assignedLeadCount');
            assignedLeadCount.textContent = `${assignedLeads.length} assigned leads`;
            
            // Render SDR summary
            renderSDRSummary();
            
            // Render leads grid
            const assignedLeadsGrid = document.getElementById('assignedLeadsGrid');
            
            if (assignedLeads.length === 0) {
                assignedLeadsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #64748b;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üë®‚Äçüíº</div>
                        <h3 style="margin-bottom: 0.5rem;">No assigned leads found</h3>
                        <p>Assign leads to SDRs from the dashboard</p>
                    </div>
                `;
                return;
            }
            
            const leadsHTML = assignedLeads.map(lead => createLeadCard(lead)).join('');
            assignedLeadsGrid.innerHTML = leadsHTML;
        }

        function renderSDRSummary() {
            const sdrSummaryGrid = document.getElementById('sdrSummaryGrid');
            
            const sdrStats = sdrTeam.map(sdr => {
                const sdrLeads = allLeads.filter(lead => lead.assigned_sdr_id === sdr.id);
                const contactedLeads = sdrLeads.filter(lead => lead.lead_status === 'Contacted').length;
                
                return {
                    ...sdr,
                    totalLeads: sdrLeads.length,
                    contactedLeads: contactedLeads
                };
            });
            
            const sdrCardsHTML = sdrStats.map(sdr => `
                <div class="sdr-summary-card">
                    <div class="sdr-header">
                        <div class="sdr-avatar">${sdr.name.charAt(0)}</div>
                        <div class="sdr-info">
                            <div class="sdr-name">${sdr.name}</div>
                            <div class="sdr-email">${sdr.email}</div>
                        </div>
                    </div>
                    <div class="sdr-stats">
                        <div class="sdr-stat">
                            <div class="sdr-stat-value">${sdr.totalLeads}</div>
                            <div class="sdr-stat-label">Assigned</div>
                        </div>
                        <div class="sdr-stat">
                            <div class="sdr-stat-value">${sdr.contactedLeads}</div>
                            <div class="sdr-stat-label">Contacted</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            sdrSummaryGrid.innerHTML = sdrCardsHTML;
        }

        // LEAD INTELLIGENCE FUNCTIONS
        function showLeadIntelligence(leadId) {
            const lead = allLeads.find(l => l.id === leadId);
            if (!lead) {
                showNotification('Lead not found', 'error');
                return;
            }
            
            currentSelectedLead = lead;
            
            // Update intelligence panel
            document.getElementById('leadScoreValue').textContent = lead.lead_score;
            document.getElementById('leadScoreLabel').textContent = `${lead.lead_quality} Lead`;
            
            document.getElementById('leadName').textContent = lead.name;
            document.getElementById('leadBusiness').textContent = lead.business_name;
            document.getElementById('leadPhone').textContent = lead.phone;
            document.getElementById('leadEmail').textContent = lead.email;
            
            const budgetLabels = {
                'high': '‚Çπ25,000+',
                'qualified': '‚Çπ10,000-‚Çπ25,000',
                'budget_unqualified': '‚Çπ5,000-‚Çπ10,000',
                'low': '<‚Çπ5,000'
            };
            
            const timelineLabels = {
                'immediately': 'Immediately',
                'within_week': 'Within Week',
                'this_month': 'This Month',
                'just_checking': 'Just Checking'
            };
            
            document.getElementById('leadBudget').textContent = budgetLabels[lead.budget_range] || lead.budget_range;
            document.getElementById('leadTimeline').textContent = timelineLabels[lead.timeline] || lead.timeline;
            document.getElementById('leadDecisionMaker').textContent = lead.decision_maker ? 'Yes' : 'No';
            document.getElementById('leadOnlinePresence').textContent = lead.online_presence || 'None';
            
            document.getElementById('leadSessionTime').textContent = `${lead.session_duration_minutes} min`;
            document.getElementById('leadDevice').textContent = lead.device_type;
            document.getElementById('leadSource').textContent = lead.utm_source;
            document.getElementById('leadProducts').textContent = lead.products_count;
            
            // Update score display color
            const scoreDisplay = document.getElementById('scoreDisplay');
            scoreDisplay.className = 'score-display';
            if (lead.lead_score >= 65) {
                scoreDisplay.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            } else if (lead.lead_score >= 41) {
                scoreDisplay.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            } else {
                scoreDisplay.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
            }
            
            document.getElementById('leadIntelligencePanel').classList.add('show');
        }

        function closeIntelligencePanel() {
            document.getElementById('leadIntelligencePanel').classList.remove('show');
            currentSelectedLead = null;
        }

        function initiateCall() {
            if (!currentSelectedLead) return;
            
            const lead = currentSelectedLead;
            const phoneUrl = `tel:${lead.phone}`;
            
            window.open(phoneUrl);
            
            // Update lead status
            lead.lead_status = 'Contacted';
            
            showNotification(`üìû Calling ${lead.name}...`, 'info');
            
            // Log conversation starter
            console.log(`üí¨ CONVERSATION STARTER FOR ${lead.name}:`);
            console.log(`Hi ${lead.name.split(' ')[0]}, this is [Your Name] from Topiko.`);
            console.log(`I see you're interested in ${lead.goals_display.join(', ').toLowerCase()} for your ${lead.business_name}.`);
            
            if (lead.timeline === 'immediately') {
                console.log(`üî• URGENT: You mentioned you need this IMMEDIATELY - let's get you set up today!`);
            }
            
            if (lead.budget_range === 'high') {
                console.log(`üí∞ With your premium budget range, we can offer you our full enterprise solution.`);
            }
            
            if (lead.decision_maker) {
                console.log(`üëë Since you're the decision maker, we can move quickly on this.`);
            }
            
            console.log(`Lead Score: ${lead.lead_score}/100 (${lead.lead_quality})`);
            
            renderLeads();
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.crm-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            document.getElementById(sectionId).style.display = 'block';
            
            // Update navigation
            document.querySelectorAll('.crm-nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.closest('.crm-nav-link').classList.add('active');
            
            // Load section-specific data
            if (sectionId === 'assigned-leads') {
                renderAssignedLeads();
            }
            
            console.log('üìÑ Switched to section:', sectionId);
        }

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Modern Topiko CRM v5.0 Initialized');
            
            // Load SDR team first
            await fetchSDRTeam();
            
            // Initial load
            await fetchLeads();
            
            // Auto-refresh every 30 seconds
            setInterval(async () => {
                await fetchLeads();
                
                // Update assigned leads if on that page
                if (document.getElementById('assigned-leads').style.display !== 'none') {
                    renderAssignedLeads();
                }
            }, 30000);
            
            showNotification('CRM v5.0 ready! Modern dashboard with SDR management loaded.', 'info');
            
            console.log('‚úÖ Modern CRM v5.0 ready for lead management');
        });
    </script>
</body>
</html>