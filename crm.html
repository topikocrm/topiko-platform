<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topiko CRM - Mobile First</title>
    <style>
        /* Add this to your existing CRM CSS - Missing Functions Fix */
        
        /* AI Recommendations Panel Styles */
        .ai-recommendations {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            color: white;
        }
        
        .ai-recommendations h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .ai-recommendation-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid #00ff88;
        }
        
        .ai-recommendation-item strong {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .ai-recommendation-item span {
            font-size: 13px;
            opacity: 0.9;
        }
        
        /* Mobile specific */
        @media (max-width: 767px) {
            .ai-recommendations {
                margin: 12px 0;
                padding: 12px;
            }
            
            .ai-recommendation-item {
                padding: 10px;
            }
        }
    </style>
</head>
<body>

<script>
// Add these missing functions to your CRM JavaScript

// MISSING FUNCTION 1: Generate AI Recommendations
function generateAIRecommendations(lead) {
    console.log('ðŸ¤– Generating AI recommendations for lead:', lead.company);
    
    const recommendations = [];
    
    try {
        // Score-based recommendations
        if (lead.score >= 80) {
            recommendations.push({
                type: 'High Priority',
                message: 'This lead has excellent potential. Schedule a demo within 24 hours.',
                priority: 'high'
            });
        } else if (lead.score >= 60) {
            recommendations.push({
                type: 'Follow Up',
                message: 'Good prospect. Send personalized follow-up with case studies.',
                priority: 'medium'
            });
        } else {
            recommendations.push({
                type: 'Nurture',
                message: 'Add to nurture sequence. Share valuable content to build trust.',
                priority: 'low'
            });
        }
        
        // Industry-specific recommendations
        const industryAdvice = {
            'Technology': 'Emphasize integration capabilities and API documentation.',
            'Healthcare': 'Focus on compliance (HIPAA) and security features.',
            'Finance': 'Highlight security, compliance, and ROI metrics.',
            'Education': 'Stress affordability and ease of use for administrators.',
            'Manufacturing': 'Emphasize efficiency gains and cost savings.',
            'Retail': 'Focus on customer experience improvements and analytics.'
        };
        
        if (industryAdvice[lead.industry]) {
            recommendations.push({
                type: 'Industry Focus',
                message: industryAdvice[lead.industry],
                priority: 'medium'
            });
        }
        
        // Activity-based recommendations
        if (lead.lastActivity) {
            const daysSinceActivity = Math.floor((Date.now() - new Date(lead.lastActivity).getTime()) / (1000 * 60 * 60 * 24));
            
            if (daysSinceActivity > 7) {
                recommendations.push({
                    type: 'Re-engagement',
                    message: `No activity for ${daysSinceActivity} days. Send a check-in email with value proposition.`,
                    priority: 'high'
                });
            }
        }
        
        // Contact method recommendations
        if (lead.phone && !lead.lastCall) {
            recommendations.push({
                type: 'Contact Strategy',
                message: 'Consider a phone call - higher conversion than email alone.',
                priority: 'medium'
            });
        }
        
        // Company size recommendations
        if (lead.companySize === 'Enterprise') {
            recommendations.push({
                type: 'Enterprise Focus',
                message: 'Prepare enterprise demo. Involve solution engineer if needed.',
                priority: 'high'
            });
        }
        
    } catch (error) {
        console.error('Error generating AI recommendations:', error);
        recommendations.push({
            type: 'Default',
            message: 'Review lead details and follow standard qualification process.',
            priority: 'medium'
        });
    }
    
    return recommendations;
}

// MISSING FUNCTION 2: Calculate Lead Velocity
function calculateLeadVelocity(leads) {
    console.log('ðŸ“ˆ Calculating lead velocity');
    
    try {
        const now = new Date();
        const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        const recentLeads = leads.filter(lead => {
            const leadDate = new Date(lead.dateAdded || lead.created_at || now);
            return leadDate >= thirtyDaysAgo;
        });
        
        const velocity = {
            total: recentLeads.length,
            weekly: Math.round(recentLeads.length / 4.3), // 30 days / 7 days
            daily: Math.round(recentLeads.length / 30),
            trend: recentLeads.length > 0 ? 'positive' : 'neutral'
        };
        
        console.log('ðŸ“Š Lead velocity calculated:', velocity);
        return velocity;
        
    } catch (error) {
        console.error('Error calculating lead velocity:', error);
        return { total: 0, weekly: 0, daily: 0, trend: 'neutral' };
    }
}

// MISSING FUNCTION 3: Generate Score Breakdown Details
function generateScoreBreakdownDetails(lead) {
    console.log('ðŸ” Generating detailed score breakdown for:', lead.company);
    
    try {
        const breakdown = {
            companyScore: 0,
            industryScore: 0,
            engagementScore: 0,
            fitScore: 0,
            details: []
        };
        
        // Company Score (0-25 points)
        if (lead.companySize === 'Enterprise') breakdown.companyScore += 25;
        else if (lead.companySize === 'Mid-Market') breakdown.companyScore += 20;
        else if (lead.companySize === 'Small Business') breakdown.companyScore += 15;
        else breakdown.companyScore += 10;
        
        breakdown.details.push({
            category: 'Company Size',
            score: breakdown.companyScore,
            max: 25,
            reason: `${lead.companySize || 'Unknown'} company size`
        });
        
        // Industry Score (0-25 points)
        const highValueIndustries = ['Technology', 'Finance', 'Healthcare'];
        if (highValueIndustries.includes(lead.industry)) breakdown.industryScore = 25;
        else if (lead.industry) breakdown.industryScore = 20;
        else breakdown.industryScore = 10;
        
        breakdown.details.push({
            category: 'Industry Fit',
            score: breakdown.industryScore,
            max: 25,
            reason: `${lead.industry || 'Unknown'} industry alignment`
        });
        
        // Engagement Score (0-25 points)
        let engagementPoints = 0;
        if (lead.email) engagementPoints += 10;
        if (lead.phone) engagementPoints += 10;
        if (lead.website) engagementPoints += 5;
        breakdown.engagementScore = engagementPoints;
        
        breakdown.details.push({
            category: 'Contact Info',
            score: breakdown.engagementScore,
            max: 25,
            reason: `${lead.email ? 'Email' : ''}${lead.phone ? ' + Phone' : ''}${lead.website ? ' + Website' : ''} available`
        });
        
        // Fit Score (0-25 points)
        const totalEmployees = parseInt(lead.employees) || 0;
        if (totalEmployees > 1000) breakdown.fitScore = 25;
        else if (totalEmployees > 100) breakdown.fitScore = 20;
        else if (totalEmployees > 10) breakdown.fitScore = 15;
        else breakdown.fitScore = 10;
        
        breakdown.details.push({
            category: 'Company Size',
            score: breakdown.fitScore,
            max: 25,
            reason: `${totalEmployees || 'Unknown'} employees`
        });
        
        const totalScore = breakdown.companyScore + breakdown.industryScore + breakdown.engagementScore + breakdown.fitScore;
        
        return {
            ...breakdown,
            totalScore,
            maxScore: 100,
            percentage: Math.round((totalScore / 100) * 100)
        };
        
    } catch (error) {
        console.error('Error generating score breakdown:', error);
        return {
            totalScore: 50,
            maxScore: 100,
            percentage: 50,
            details: [{ category: 'Error', score: 50, max: 100, reason: 'Unable to calculate detailed breakdown' }]
        };
    }
}

// MISSING FUNCTION 4: Enhanced Mobile Touch Handler
function handleMobileTouch(element, callback) {
    if (!element || typeof callback !== 'function') return;
    
    let touchStart = { x: 0, y: 0 };
    let touchMoved = false;
    
    element.addEventListener('touchstart', function(e) {
        touchStart.x = e.touches[0].clientX;
        touchStart.y = e.touches[0].clientY;
        touchMoved = false;
        
        // Add touch feedback
        element.style.transform = 'scale(0.95)';
        element.style.transition = 'transform 0.1s ease';
    }, { passive: true });
    
    element.addEventListener('touchmove', function(e) {
        const touch = e.touches[0];
        const deltaX = Math.abs(touch.clientX - touchStart.x);
        const deltaY = Math.abs(touch.clientY - touchStart.y);
        
        if (deltaX > 10 || deltaY > 10) {
            touchMoved = true;
            // Remove touch feedback if moved
            element.style.transform = '';
        }
    }, { passive: true });
    
    element.addEventListener('touchend', function(e) {
        // Remove touch feedback
        element.style.transform = '';
        
        if (!touchMoved) {
            e.preventDefault();
            callback(e);
        }
    });
    
    // Fallback for desktop
    element.addEventListener('click', function(e) {
        if (!e.isTrusted) return; // Prevent double firing on mobile
        callback(e);
    });
}

// MISSING FUNCTION 5: Mobile Dropdown Positioning Fix
function positionMobileDropdown(dropdown, trigger) {
    if (!dropdown || !trigger) return;
    
    const isMobile = window.innerWidth < 768;
    
    if (isMobile) {
        // Center dropdown on mobile
        dropdown.style.position = 'fixed';
        dropdown.style.top = '50%';
        dropdown.style.left = '50%';
        dropdown.style.transform = 'translate(-50%, -50%)';
        dropdown.style.width = '90vw';
        dropdown.style.maxWidth = '300px';
        dropdown.style.zIndex = '10000';
        
        // Add backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'mobile-dropdown-backdrop';
        backdrop.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
        `;
        
        document.body.appendChild(backdrop);
        
        // Close on backdrop click
        backdrop.addEventListener('click', function() {
            dropdown.style.display = 'none';
            backdrop.remove();
        });
        
        // Store backdrop reference for cleanup
        dropdown._backdrop = backdrop;
        
    } else {
        // Desktop positioning
        const rect = trigger.getBoundingClientRect();
        dropdown.style.position = 'absolute';
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.left = rect.left + 'px';
        dropdown.style.transform = 'none';
        dropdown.style.width = 'auto';
        dropdown.style.zIndex = '1000';
    }
}

// MISSING FUNCTION 6: Clean up mobile dropdown
function cleanupMobileDropdown(dropdown) {
    if (dropdown && dropdown._backdrop) {
        dropdown._backdrop.remove();
        dropdown._backdrop = null;
    }
}

// MISSING FUNCTION 7: Enhanced Error Handler
function handleCRMError(error, context = 'Unknown') {
    console.error(`âŒ CRM Error in ${context}:`, error);
    
    // Show user-friendly error message
    const notification = document.createElement('div');
    notification.className = 'error-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ff4757;
        color: white;
        padding: 12px 16px;
        border-radius: 6px;
        z-index: 10001;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
    `;
    
    notification.innerHTML = `
        <strong>Error in ${context}</strong><br>
        <small>Check console for details</small>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
    
    return false; // Prevent further execution
}

// MISSING FUNCTION 8: Debug Mobile Buttons (Enhanced)
function debugMobileButtons() {
    console.log('ðŸ”§ Debugging mobile buttons...');
    
    const buttons = document.querySelectorAll('button, .btn, [onclick]');
    console.log(`Found ${buttons.length} interactive elements`);
    
    buttons.forEach((btn, index) => {
        const rect = btn.getBoundingClientRect();
        const hasClick = btn.onclick || btn.addEventListener;
        const isVisible = rect.width > 0 && rect.height > 0;
        
        console.log(`Button ${index + 1}:`, {
            text: btn.textContent?.trim().substring(0, 20) || 'No text',
            size: `${Math.round(rect.width)}x${Math.round(rect.height)}`,
            hasClick: !!hasClick,
            isVisible,
            classes: btn.className
        });
        
        // Highlight buttons temporarily
        if (isVisible) {
            const originalBorder = btn.style.border;
            btn.style.border = '2px solid red';
            setTimeout(() => {
                btn.style.border = originalBorder;
            }, 2000);
        }
    });
    
    return `Debugged ${buttons.length} buttons - check console and red highlights`;
}

// Update existing functions to use error handling
const originalShowLeadIntelligence = window.showLeadIntelligence;
window.showLeadIntelligence = function(leadId) {
    try {
        console.log('ðŸ” Opening lead intelligence for lead:', leadId);
        
        const lead = allLeads.find(l => l.id === leadId);
        if (!lead) {
            throw new Error(`Lead with ID ${leadId} not found`);
        }
        
        // Generate AI recommendations
        const recommendations = generateAIRecommendations(lead);
        
        // Get score breakdown
        const scoreBreakdown = generateScoreBreakdownDetails(lead);
        
        // Continue with original function logic...
        if (originalShowLeadIntelligence) {
            return originalShowLeadIntelligence.call(this, leadId);
        }
        
        // If no original function, create the intelligence panel
        const intelligencePanel = document.getElementById('leadIntelligencePanel');
        if (intelligencePanel) {
            intelligencePanel.style.display = 'block';
            
            // Add recommendations to panel
            const recommendationsHTML = `
                <div class="ai-recommendations">
                    <h4>ðŸ¤– AI Recommendations</h4>
                    ${recommendations.map(rec => `
                        <div class="ai-recommendation-item">
                            <strong>${rec.type}</strong>
                            <span>${rec.message}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            const existingContent = intelligencePanel.innerHTML;
            intelligencePanel.innerHTML = recommendationsHTML + existingContent;
        }
        
    } catch (error) {
        handleCRMError(error, 'Lead Intelligence');
    }
};

// Add enhanced debugging to window object
window.debugCRM = window.debugCRM || {};
window.debugCRM.testMobileButtons = debugMobileButtons;
window.debugCRM.fixMissingFunctions = function() {
    console.log('âœ… All missing functions have been added!');
    console.log('Available functions:', [
        'generateAIRecommendations',
        'calculateLeadVelocity', 
        'generateScoreBreakdownDetails',
        'handleMobileTouch',
        'positionMobileDropdown',
        'handleCRMError'
    ]);
};

console.log('âœ… Missing CRM functions have been restored!');
console.log('ðŸ”§ Run window.debugCRM.fixMissingFunctions() to verify');

</script>

</body>
</html>