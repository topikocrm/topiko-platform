<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topiko - Complete Business Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8f6ff 0%, #f0ebff 50%, #e8e0ff 100%);
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Lead Intelligence Widget */
        .lead-intelligence-widget {
            position: fixed;
            top: 4rem;
            left: 1rem;
            background: linear-gradient(135deg, #6b46c1 0%, #8b6fcd 100%);
            color: white;
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(107, 70, 193, 0.3);
            z-index: 1000;
            min-width: 200px;
            backdrop-filter: blur(20px);
        }

        .widget-header {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .lead-score-display {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .lead-quality {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        .lead-quality.hot {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .lead-quality.warm {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .lead-quality.cold {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .widget-details {
            font-size: 0.7rem;
            opacity: 0.8;
            line-height: 1.3;
        }

        /* Database Status Indicator */
        .db-status {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .db-status.testing {
            background: rgba(59, 130, 246, 0.9);
        }

        .db-status.error {
            background: rgba(239, 68, 68, 0.9);
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            font-size: 0.8rem;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }

        .debug-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1002;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 260px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(139, 111, 205, 0.1);
            padding: 2rem 0;
            position: relative;
            box-shadow: 0 0 50px rgba(139, 111, 205, 0.05);
        }

        .logo-section {
            text-align: center;
            margin-bottom: 3rem;
            padding: 0 2rem;
        }

        .logo-section h1 {
            color: #6b46c1;
            font-size: 1.8rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin: 0.3rem 0;
            padding: 0 1rem;
        }

        .nav-link {
            display: block;
            padding: 0.9rem 1.2rem;
            color: #6b46c1;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            color: #553c9a;
            background: rgba(139, 111, 205, 0.1);
            transform: translateX(2px);
            box-shadow: 0 4px 20px rgba(139, 111, 205, 0.1);
        }

        .nav-icon {
            margin-right: 0.8rem;
            font-size: 1.1rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            position: relative;
            overflow-y: auto;
            padding: 2rem;
        }

        .screen {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 80vh;
            background: linear-gradient(135deg, #faf9ff 0%, #f3f0ff 100%);
            border-radius: 20px;
            padding: 3rem;
        }

        .topiko-logo {
            font-size: 4rem;
            font-weight: 300;
            color: #6b46c1;
            letter-spacing: -2px;
            margin-bottom: 3rem;
        }

        .try-free-button {
            background: linear-gradient(135deg, #8b6fcd 0%, #6b46c1 100%);
            color: white;
            border: none;
            padding: 1rem 3rem;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 30px rgba(107, 70, 193, 0.3);
        }

        .try-free-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(107, 70, 193, 0.4);
        }

        /* Content Cards */
        .content-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(139, 111, 205, 0.1);
            border: 1px solid rgba(139, 111, 205, 0.1);
        }

        .content-card h2 {
            color: #6b46c1;
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            letter-spacing: -1px;
        }

        .content-card p {
            color: #553c9a;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #6b46c1;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.9rem 1.2rem;
            border: 1.5px solid rgba(139, 111, 205, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            color: #553c9a;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #8b6fcd;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(139, 111, 205, 0.1);
        }

        .submit-button {
            width: 100%;
            background: linear-gradient(135deg, #8b6fcd 0%, #6b46c1 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 30px rgba(107, 70, 193, 0.3);
            margin-top: 1rem;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(107, 70, 193, 0.4);
        }

        .submit-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Language Selection */
        .language-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .language-option {
            display: flex;
            align-items: center;
            padding: 1.5rem 2rem;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(139, 111, 205, 0.1);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .language-option:hover,
        .language-option.selected {
            background: rgba(139, 111, 205, 0.15);
            border-color: #8b6fcd;
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(139, 111, 205, 0.25);
        }

        .language-flag {
            font-size: 3rem;
            margin-right: 1.5rem;
            min-width: 60px;
            text-align: center;
        }

        .language-content h3 {
            color: #6b46c1;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .language-content p {
            color: #553c9a;
            font-size: 1rem;
            margin: 0;
        }

        /* Goals Selection */
        .goals-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .goal-option {
            position: relative;
        }

        .goal-checkbox {
            display: none;
        }

        .goal-card {
            display: flex;
            align-items: center;
            padding: 1.5rem 2rem;
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid rgba(139, 111, 205, 0.1);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .goal-card:hover {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(139, 111, 205, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(139, 111, 205, 0.15);
        }

        .goal-checkbox:checked + .goal-card {
            background: rgba(139, 111, 205, 0.1);
            border-color: #8b6fcd;
            box-shadow: 0 8px 30px rgba(139, 111, 205, 0.2);
        }

        .goal-icon {
            font-size: 2.5rem;
            margin-right: 1.5rem;
            min-width: 60px;
            text-align: center;
        }

        .goal-content h3 {
            color: #6b46c1;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .goal-content p {
            color: #553c9a;
            font-size: 0.95rem;
            margin: 0;
        }

        .goal-checkmark {
            font-size: 1.5rem;
            color: #8b6fcd;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease;
            margin-left: 1rem;
        }

        .goal-checkbox:checked + .goal-card .goal-checkmark {
            opacity: 1;
            transform: scale(1);
        }

        /* Enhanced Categories Styling */
        .categories-section {
            margin-bottom: 3rem;
        }

        .category-group {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid rgba(139, 111, 205, 0.1);
        }

        .main-category-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .main-category-header:hover {
            background: rgba(139, 111, 205, 0.05);
        }

        .main-category-checkbox {
            margin-right: 1rem;
            transform: scale(1.2);
        }

        .main-category-icon {
            font-size: 2rem;
            margin-right: 1rem;
        }

        .main-category-title {
            color: #6b46c1;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .subcategories-grid {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-left: 3rem;
        }

        .subcategories-grid.show {
            display: grid;
        }

        .subcategory-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(139, 111, 205, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .subcategory-item:hover {
            background: rgba(139, 111, 205, 0.05);
            border-color: rgba(139, 111, 205, 0.2);
        }

        .subcategory-checkbox {
            margin-right: 0.75rem;
        }

        .subcategory-icon {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }

        .subcategory-label {
            font-size: 0.9rem;
            color: #553c9a;
            font-weight: 500;
        }

        /* Selection Summary */
        .selection-summary {
            background: rgba(139, 111, 205, 0.1);
            padding: 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            display: none;
        }

        .selection-summary.show {
            display: block;
        }

        .selection-summary h4 {
            color: #6b46c1;
            margin-bottom: 0.5rem;
        }

        .selection-summary .summary-content {
            color: #553c9a;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, #8b6fcd 0%, #6b46c1 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(107, 70, 193, 0.3);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s ease;
            z-index: 1001;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .notification.success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .logo-section h1 {
                display: none;
            }

            .nav-link span:not(.nav-icon) {
                display: none;
            }

            .topiko-logo {
                font-size: 3rem;
            }

            .language-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .language-option {
                flex-direction: column;
                text-align: center;
                padding: 1.5rem;
            }

            .language-flag {
                margin-right: 0;
                margin-bottom: 1rem;
            }

            .lead-intelligence-widget {
                position: relative;
                top: auto;
                left: auto;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Database Status Indicator -->
    <div class="db-status testing" id="dbStatus">
        üîÑ Testing connection...
    </div>

    <!-- Lead Intelligence Widget -->
    <div class="lead-intelligence-widget" id="leadWidget">
        <div class="widget-header">üéØ Lead Intelligence</div>
        <div class="lead-score-display" id="widgetScore">0/100</div>
        <div class="lead-quality cold" id="widgetQuality">Cold Lead</div>
        <div class="widget-details" id="widgetDetails">
            Session: 0m | Pages: 1 | Goals: 0
        </div>
    </div>

    <!-- Debug Toggle -->
    <button class="debug-toggle" onclick="toggleDebugPanel()">üîç Debug</button>

    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <h4>üîç Database Debug Log</h4>
        <div id="debugLog"></div>
    </div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="logo-section">
                <h1>Topiko</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <div class="nav-link active" onclick="showScreen('welcome')">
                        <span class="nav-icon">üè†</span>
                        <span>Home</span>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="nav-link" onclick="showScreen('language')">
                        <span class="nav-icon">üåê</span>
                        <span>Language</span>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="nav-link" onclick="showScreen('goals')">
                        <span class="nav-icon">üéØ</span>
                        <span>Goals</span>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="nav-link" onclick="showScreen('registration')">
                        <span class="nav-icon">üìù</span>
                        <span>Sign Up</span>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="nav-link" onclick="showScreen('categories')">
                        <span class="nav-icon">üìÇ</span>
                        <span>Categories</span>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="nav-link" onclick="showScreen('products')">
                        <span class="nav-icon">üì¶</span>
                        <span>Products</span>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="nav-link" onclick="showScreen('themes')">
                        <span class="nav-icon">üé®</span>
                        <span>Themes</span>
                    </div>
                </li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Welcome Screen -->
            <section class="screen active" id="welcome">
                <div class="welcome-screen">
                    <h1 class="topiko-logo">Topiko</h1>
                    <p style="font-size: 1.2rem; color: #6b46c1; margin-bottom: 2rem;">Complete Business Platform for Indian SMBs</p>
                    <p style="font-size: 1rem; color: #22c55e; margin-bottom: 2rem; font-weight: bold;">üéâ ENHANCED VERSION - Categories + Live Intelligence Widget!</p>
                    <button class="try-free-button" onclick="showScreen('language')">
                        Try for Free
                    </button>
                </div>
            </section>

            <!-- Language Selection Screen -->
            <section class="screen" id="language">
                <div class="content-card" style="max-width: 600px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 0.5rem;">Choose Your Language</h2>
                    <p style="text-align: center; margin-bottom: 3rem;">‡§Ö‡§™‡§®‡•Ä ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç | ‡∞Æ‡±Ä ‡∞≠‡∞æ‡∞∑‡∞®‡±Å ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø | ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç</p>
                    
                    <div class="language-grid">
                        <div class="language-option" onclick="selectLanguage('en', this)">
                            <div class="language-flag">üá¨üáß</div>
                            <div class="language-content">
                                <h3>English</h3>
                                <p>Continue in English</p>
                            </div>
                        </div>

                        <div class="language-option" onclick="selectLanguage('hi', this)">
                            <div class="language-flag">üáÆüá≥</div>
                            <div class="language-content">
                                <h3>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</h3>
                                <p>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç</p>
                            </div>
                        </div>

                        <div class="language-option" onclick="selectLanguage('te', this)">
                            <div class="language-flag">üáÆüá≥</div>
                            <div class="language-content">
                                <h3>‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</h3>
                                <p>‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å‡∞≤‡±ã ‡∞ï‡±ä‡∞®‡∞∏‡∞æ‡∞ó‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø</p>
                            </div>
                        </div>

                        <div class="language-option" onclick="selectLanguage('ta', this)">
                            <div class="language-flag">üáÆüá≥</div>
                            <div class="language-content">
                                <h3>‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</h3>
                                <p>‡Æ§‡¶Æ‡¶ø‡Æ¥‡Æø‡Æ≤‡Øç ‡Æ§‡Øä‡Æü‡¶∞‡Æµ‡ØÅ‡ÆÆ‡Øç</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Goals Selection Screen -->
            <section class="screen" id="goals">
                <div class="content-card" style="max-width: 700px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 0.5rem;">Select Your Goals</h2>
                    <p style="text-align: center; margin-bottom: 3rem;">Choose what you want to achieve with Topiko (select all that apply)</p>
                    
                    <div class="goals-grid">
                        <div class="goal-option">
                            <input type="checkbox" id="goal-ecommerce" value="ecommerce" class="goal-checkbox" onchange="updateGoalsTracking()">
                            <label for="goal-ecommerce" class="goal-card">
                                <div class="goal-icon">üõí</div>
                                <div class="goal-content">
                                    <h3>Sell Online (E-commerce)</h3>
                                    <p>Start selling your products online with a complete e-commerce solution</p>
                                </div>
                                <div class="goal-checkmark">‚úì</div>
                            </label>
                        </div>

                        <div class="goal-option">
                            <input type="checkbox" id="goal-customers" value="customers" class="goal-checkbox" onchange="updateGoalsTracking()">
                            <label for="goal-customers" class="goal-card">
                                <div class="goal-icon">üìà</div>
                                <div class="goal-content">
                                    <h3>Reach More Customers</h3>
                                    <p>Expand your customer base and grow your market reach</p>
                                </div>
                                <div class="goal-checkmark">‚úì</div>
                            </label>
                        </div>

                        <div class="goal-option">
                            <input type="checkbox" id="goal-manage" value="manage" class="goal-checkbox" onchange="updateGoalsTracking()">
                            <label for="goal-manage" class="goal-card">
                                <div class="goal-icon">üë•</div>
                                <div class="goal-content">
                                    <h3>Manage Customers</h3>
                                    <p>Keep track of your customers and build lasting relationships</p>
                                </div>
                                <div class="goal-checkmark">‚úì</div>
                            </label>
                        </div>

                        <div class="goal-option">
                            <input type="checkbox" id="goal-search" value="search" class="goal-checkbox" onchange="updateGoalsTracking()">
                            <label for="goal-search" class="goal-card">
                                <div class="goal-icon">üîç</div>
                                <div class="goal-content">
                                    <h3>Appear in Search Results</h3>
                                    <p>Improve your online visibility and get found by potential customers</p>
                                </div>
                                <div class="goal-checkmark">‚úì</div>
                            </label>
                        </div>

                        <div class="goal-option">
                            <input type="checkbox" id="goal-brand" value="brand" class="goal-checkbox" onchange="updateGoalsTracking()">
                            <label for="goal-brand" class="goal-card">
                                <div class="goal-icon">‚≠ê</div>
                                <div class="goal-content">
                                    <h3>Establish my Brand</h3>
                                    <p>Build a strong brand presence and professional image online</p>
                                </div>
                                <div class="goal-checkmark">‚úì</div>
                            </label>
                        </div>
                    </div>

                    <button class="submit-button" onclick="submitGoals()">
                        Next Step
                    </button>
                </div>
            </section>

            <!-- Registration Screen -->
            <section class="screen" id="registration">
                <div class="content-card" style="max-width: 600px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 0.5rem;">Get Started with Topiko</h2>
                    <p style="text-align: center; margin-bottom: 2rem;">Tell us about your business to create your free account</p>
                    
                    <div class="form-group">
                        <label for="fullName">Your Name</label>
                        <input type="text" id="fullName" placeholder="Enter your full name" oninput="trackFormProgress()">
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" placeholder="Enter your email address" oninput="trackFormProgress()">
                    </div>

                    <div class="form-group">
                        <label for="phoneNumber">Phone Number</label>
                        <input type="tel" id="phoneNumber" placeholder="Enter your phone number" oninput="trackFormProgress()">
                    </div>

                    <div class="form-group">
                        <label for="businessName">Business Name</label>
                        <input type="text" id="businessName" placeholder="Enter your business name" oninput="trackFormProgress()">
                    </div>

                    <div class="form-group">
                        <label for="address">Address</label>
                        <textarea id="address" rows="3" placeholder="Enter your business address" oninput="trackFormProgress()"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="businessType">Business Type</label>
                        <select id="businessType" onchange="trackFormProgress()">
                            <option value="">Select your business type</option>
                            <option value="startup">Startup</option>
                            <option value="small-business">Small Business</option>
                            <option value="medium-enterprise">Medium Enterprise</option>
                            <option value="large-enterprise">Large Enterprise</option>
                            <option value="freelancer">Freelancer</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="category">Primary Business Category</label>
                        <select id="category" onchange="trackFormProgress()">
                            <option value="">Select your primary business category</option>
                            <option value="boutique">üè™ Boutique</option>
                            <option value="home-foods">üçõ Home Foods</option>
                            <option value="salons">üíÑ Salons & Beauty</option>
                            <option value="grocery">üõí Grocery & Provisions</option>
                            <option value="furniture">üõãÔ∏è Furniture & Home Decor</option>
                            <option value="fashion">üëó Fashion & Apparel</option>
                            <option value="jewellery">üíç Jewellery & Accessories</option>
                            <option value="electronics">üì± Electronics & Gadgets</option>
                        </select>
                    </div>

                    <button class="submit-button" onclick="submitRegistration()">
                        Create Free Account
                    </button>
                </div>
            </section>

            <!-- Enhanced Categories Screen -->
            <section class="screen" id="categories">
                <div class="content-card" style="max-width: 1000px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 0.5rem;">Select Your Business Categories</h2>
                    <p style="text-align: center; margin-bottom: 1rem;">Choose all categories and subcategories that apply to your business</p>
                    
                    <!-- Selection Summary -->
                    <div class="selection-summary" id="selectionSummary">
                        <h4>‚úÖ Your Selections</h4>
                        <div class="summary-content" id="summaryContent">
                            No categories selected yet
                        </div>
                    </div>

                    <!-- Categories Section -->
                    <div class="categories-section" id="categoriesContainer">
                        <!-- Categories will be populated here -->
                    </div>

                    <button class="submit-button" onclick="proceedToProducts()" id="categoryNextBtn" disabled>
                        Continue to Add Products
                    </button>
                </div>
            </section>

            <!-- Products Screen -->
            <section class="screen" id="products">
                <div class="content-card" style="max-width: 1000px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 0.5rem;">Add Your Products</h2>
                    <p style="text-align: center; margin-bottom: 3rem;">Build your catalog with products that represent your business</p>
                    
                    <!-- Product Form -->
                    <div class="product-form" style="background: rgba(255, 255, 255, 0.7); padding: 2rem; border-radius: 16px; margin-bottom: 2rem;">
                        <h3 style="color: #6b46c1; margin-bottom: 1.5rem;">Add New Product/Service</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label for="productName">Product/Service Name</label>
                                <input type="text" id="productName" placeholder="e.g., Cotton Kurta, Masala Dosa, Haircut">
                            </div>
                            
                            <div class="form-group">
                                <label for="productPrice">Price (‚Çπ)</label>
                                <input type="number" id="productPrice" placeholder="e.g., 899">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="productDescription">Description</label>
                            <textarea id="productDescription" rows="3" placeholder="Brief description of your product or service"></textarea>
                        </div>
                        
                        <button type="button" onclick="addProduct()" style="background: linear-gradient(135deg, #8b6fcd 0%, #6b46c1 100%); color: white; border: none; padding: 0.8rem 2rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                            ‚ûï Add Product
                        </button>
                    </div>

                    <!-- Products List -->
                    <div class="products-list">
                        <h3 style="color: #6b46c1; margin-bottom: 1.5rem;">Your Product Catalog (<span id="productCount">0</span>)</h3>
                        
                        <div id="productsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div style="text-align: center; padding: 2rem; color: #64748b; background: rgba(255, 255, 255, 0.5); border-radius: 12px;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                                <p>No products added yet. Add your first product above!</p>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 3rem;">
                        <button onclick="showScreen('categories')" style="flex: 1; background: rgba(139, 111, 205, 0.1); color: #6b46c1; border: 2px solid rgba(139, 111, 205, 0.2); padding: 1rem; border-radius: 12px; font-weight: 600; cursor: pointer;">
                            ‚Üê Back to Categories
                        </button>
                        <button onclick="proceedToThemes()" style="flex: 1; background: linear-gradient(135deg, #8b6fcd 0%, #6b46c1 100%); color: white; border: none; padding: 1rem; border-radius: 12px; font-weight: 600; cursor: pointer;">
                            Continue to Themes ‚Üí
                        </button>
                    </div>
                </div>
            </section>

            <!-- Themes Screen -->
            <section class="screen" id="themes">
                <div class="content-card" style="max-width: 1200px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 0.5rem;">Choose Your Website Theme</h2>
                    <p style="text-align: center; margin-bottom: 3rem;">See how your products will look in different themes</p>
                    
                    <div class="themes-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; margin-bottom: 3rem;">
                        <!-- Modern Theme -->
                        <div class="theme-preview" onclick="selectTheme('modern')" style="border: 3px solid rgba(139, 111, 205, 0.1); border-radius: 20px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; background: white; position: relative;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; color: white;">
                                <h3 style="margin: 0; font-size: 1.2rem;">Modern Professional</h3>
                                <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">Clean & Minimal</p>
                            </div>
                            <div style="padding: 15px; min-height: 200px;">
                                <div style="text-align: center; color: #64748b; padding: 20px;">
                                    <small>Your products will appear here</small>
                                </div>
                            </div>
                        </div>

                        <!-- Colorful Theme -->
                        <div class="theme-preview" onclick="selectTheme('colorful')" style="border: 3px solid rgba(139, 111, 205, 0.1); border-radius: 20px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; background: white; position: relative;">
                            <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%); padding: 15px; color: white;">
                                <h3 style="margin: 0; font-size: 1.2rem;">Colorful Creative</h3>
                                <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">Vibrant & Fun</p>
                            </div>
                            <div style="padding: 15px; min-height: 200px;">
                                <div style="text-align: center; color: #64748b; padding: 20px;">
                                    <small>Your products will appear here</small>
                                </div>
                            </div>
                        </div>

                        <!-- Elegant Theme -->
                        <div class="theme-preview" onclick="selectTheme('elegant')" style="border: 3px solid rgba(139, 111, 205, 0.1); border-radius: 20px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; background: white; position: relative;">
                            <div style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); padding: 15px; color: white;">
                                <h3 style="margin: 0; font-size: 1.2rem;">Elegant Luxury</h3>
                                <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">Sophisticated</p>
                            </div>
                            <div style="padding: 15px; min-height: 200px;">
                                <div style="text-align: center; color: #64748b; padding: 20px;">
                                    <small>Your products will appear here</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="selected-theme" id="selectedTheme" style="display: none; background: rgba(139, 111, 205, 0.1); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; text-align: center;">
                        <h3 style="color: #6b46c1; margin-bottom: 0.5rem;">üé® Theme Selected</h3>
                        <p style="color: #553c9a; margin: 0;" id="selectedThemeText">You've selected your website theme</p>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button onclick="showScreen('products')" style="flex: 1; background: rgba(139, 111, 205, 0.1); color: #6b46c1; border: 2px solid rgba(139, 111, 205, 0.2); padding: 1rem; border-radius: 12px; font-weight: 600; cursor: pointer;">
                            ‚Üê Back to Products
                        </button>
                        <button onclick="completeSetup()" id="themeNextBtn" style="flex: 1; background: linear-gradient(135deg, #8b6fcd 0%, #6b46c1 100%); color: white; border: none; padding: 1rem; border-radius: 12px; font-weight: 600; cursor: pointer;" disabled>
                            Complete Setup üöÄ
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // üéØ ENHANCED LEAD INTELLIGENCE SYSTEM - CATEGORIES + LIVE WIDGET
        
        // ‚úÖ CORE VARIABLES
        let sessionStartTime = Date.now();
        let selectedGoals = [];
        let selectedLanguage = 'en';
        let selectedMainCategories = [];  // NEW: Main categories
        let selectedSubcategories = [];   // ENHANCED: Subcategories
        let selectedTheme = '';
        let userProducts = [];
        let currentUserId = null;
        let pageViews = 1;
        let leadScore = 0;
        let formProgress = 0;
        let utmParams = {};
        let deviceInfo = {};
        let behaviorData = {
            timeOnPages: {},
            clickEvents: [],
            formInteractions: [],
            scrollDepth: 0,
            abandonmentPoints: []
        };
        let databaseConnected = false;
        let debugLogs = [];

        // üöÄ SUPABASE CONFIGURATION
        const SUPABASE_URL = 'https://xssbtsfjtwjholygdbqo.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhzc2J0c2ZqdHdqaG9seWdkYnFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxOTk5MjUsImV4cCI6MjA2ODc3NTkyNX0.eOSIHTpvllcH-fK6MARoe5HPiXlujsrzUWfAhmUh94k'

        // üáÆüá≥ COMPREHENSIVE INDIAN SMB BUSINESS CATEGORIES
        const comprehensiveBusinessCategories = {
            boutique: {
                name: 'Boutique & Fashion Store',
                icon: 'üè™',
                subcategories: [
                    { id: 'women-ethnic', name: 'Women\'s Ethnic Wear', icon: 'üëó' },
                    { id: 'men-ethnic', name: 'Men\'s Ethnic Wear', icon: 'üëï' },
                    { id: 'kids-wear', name: 'Kids Wear', icon: 'üë∂' },
                    { id: 'accessories', name: 'Fashion Accessories', icon: 'üëú' },
                    { id: 'footwear', name: 'Footwear', icon: 'üë†' },
                    { id: 'western-wear', name: 'Western Wear', icon: 'üëî' },
                    { id: 'party-wear', name: 'Party & Wedding Wear', icon: 'üéâ' },
                    { id: 'designer-wear', name: 'Designer Collection', icon: 'üíé' },
                    { id: 'casual-wear', name: 'Casual Wear', icon: 'üëï' },
                    { id: 'formal-wear', name: 'Formal Wear', icon: 'ü§µ' }
                ]
            },
            'home-foods': {
                name: 'Home Foods & Catering',
                icon: 'üçõ',
                subcategories: [
                    { id: 'north-indian', name: 'North Indian Cuisine', icon: 'üçõ' },
                    { id: 'south-indian', name: 'South Indian Cuisine', icon: 'ü•û' },
                    { id: 'street-food', name: 'Street Food', icon: 'ü•®' },
                    { id: 'sweets-snacks', name: 'Sweets & Snacks', icon: 'üç¨' },
                    { id: 'beverages', name: 'Beverages & Drinks', icon: 'üßÉ' },
                    { id: 'healthy-food', name: 'Healthy Food', icon: 'ü•ó' },
                    { id: 'regional-cuisine', name: 'Regional Specialties', icon: 'üç≤' },
                    { id: 'tiffin-service', name: 'Tiffin & Meal Service', icon: 'üç±' },
                    { id: 'catering', name: 'Event Catering', icon: 'üçΩÔ∏è' },
                    { id: 'bakery', name: 'Bakery Items', icon: 'üßÅ' }
                ]
            },
            salons: {
                name: 'Salons & Beauty Services',
                icon: 'üíÑ',
                subcategories: [
                    { id: 'hair-services', name: 'Hair Cut & Styling', icon: 'üíá' },
                    { id: 'facial-skincare', name: 'Facial & Skincare', icon: 'üß¥' },
                    { id: 'bridal-makeup', name: 'Bridal Makeup', icon: 'üë∞' },
                    { id: 'nail-art', name: 'Nail Art & Manicure', icon: 'üíÖ' },
                    { id: 'spa-massage', name: 'Spa & Massage', icon: 'üíÜ' },
                    { id: 'mens-grooming', name: 'Men\'s Grooming', icon: 'üßî' },
                    { id: 'eyebrow-threading', name: 'Eyebrow & Threading', icon: 'üëÅÔ∏è' },
                    { id: 'makeup-artist', name: 'Professional Makeup', icon: 'üé®' },
                    { id: 'hair-treatment', name: 'Hair Treatment', icon: 'üíÜ‚Äç‚ôÄÔ∏è' },
                    { id: 'beauty-consultation', name: 'Beauty Consultation', icon: 'üó£Ô∏è' }
                ]
            },
            grocery: {
                name: 'Grocery & Provisions',
                icon: 'üõí',
                subcategories: [
                    { id: 'vegetables-fruits', name: 'Fresh Vegetables & Fruits', icon: 'ü•¨' },
                    { id: 'dairy-products', name: 'Dairy Products', icon: 'ü•õ' },
                    { id: 'grains-pulses', name: 'Grains & Pulses', icon: 'üåæ' },
                    { id: 'spices-masala', name: 'Spices & Masala', icon: 'üå∂Ô∏è' },
                    { id: 'packaged-foods', name: 'Packaged Foods', icon: 'üì¶' },
                    { id: 'household-items', name: 'Household Items', icon: 'üßΩ' },
                    { id: 'organic-products', name: 'Organic Products', icon: 'üå±' },
                    { id: 'frozen-foods', name: 'Frozen Foods', icon: 'üßä' },
                    { id: 'beverages', name: 'Beverages & Drinks', icon: 'ü•§' },
                    { id: 'personal-care', name: 'Personal Care Items', icon: 'üß¥' }
                ]
            },
            furniture: {
                name: 'Furniture & Home Decor',
                icon: 'üõãÔ∏è',
                subcategories: [
                    { id: 'living-room', name: 'Living Room Furniture', icon: 'üõãÔ∏è' },
                    { id: 'bedroom', name: 'Bedroom Furniture', icon: 'üõèÔ∏è' },
                    { id: 'kitchen-dining', name: 'Kitchen & Dining', icon: 'üçΩÔ∏è' },
                    { id: 'home-decor', name: 'Home Decor & Art', icon: 'üñºÔ∏è' },
                    { id: 'lighting', name: 'Lighting Solutions', icon: 'üí°' },
                    { id: 'storage', name: 'Storage Solutions', icon: 'üìö' },
                    { id: 'office-furniture', name: 'Office Furniture', icon: 'ü™ë' },
                    { id: 'outdoor-furniture', name: 'Outdoor Furniture', icon: 'üè°' },
                    { id: 'modular-furniture', name: 'Modular Furniture', icon: 'üîß' },
                    { id: 'antique-furniture', name: 'Antique & Vintage', icon: 'üè∫' }
                ]
            },
            fashion: {
                name: 'Fashion & Apparel',
                icon: 'üëó',
                subcategories: [
                    { id: 'mens-clothing', name: 'Men\'s Clothing', icon: 'üëî' },
                    { id: 'womens-clothing', name: 'Women\'s Clothing', icon: 'üëó' },
                    { id: 'kids-clothing', name: 'Kids Clothing', icon: 'üë∂' },
                    { id: 'shoes-footwear', name: 'Shoes & Footwear', icon: 'üëü' },
                    { id: 'bags-wallets', name: 'Bags & Wallets', icon: 'üëú' },
                    { id: 'watches', name: 'Watches & Timepieces', icon: '‚åö' },
                    { id: 'sunglasses', name: 'Sunglasses & Eyewear', icon: 'üï∂Ô∏è' },
                    { id: 'sportswear', name: 'Sportswear & Activewear', icon: 'üèÉ‚Äç‚ôÇÔ∏è' },
                    { id: 'lingerie', name: 'Innerwear & Lingerie', icon: 'ü©≤' },
                    { id: 'fashion-jewelry', name: 'Fashion Jewelry', icon: 'üíç' }
                ]
            },
            jewellery: {
                name: 'Jewellery & Accessories',
                icon: 'üíç',
                subcategories: [
                    { id: 'gold-jewellery', name: 'Gold Jewellery', icon: 'ü•á' },
                    { id: 'silver-jewellery', name: 'Silver Jewellery', icon: 'ü•à' },
                    { id: 'diamond-jewellery', name: 'Diamond Jewellery', icon: 'üíé' },
                    { id: 'fashion-jewellery', name: 'Fashion Jewellery', icon: '‚ú®' },
                    { id: 'precious-stones', name: 'Precious Stones', icon: 'üíé' },
                    { id: 'custom-jewellery', name: 'Custom Jewellery', icon: 'üîß' },
                    { id: 'traditional-jewellery', name: 'Traditional Jewellery', icon: 'üè∫' },
                    { id: 'bridal-sets', name: 'Bridal Jewellery Sets', icon: 'üë∞' },
                    { id: 'mens-jewellery', name: 'Men\'s Jewellery', icon: 'ü§µ' },
                    { id: 'vintage-jewellery', name: 'Vintage & Antique', icon: 'üè∫' }
                ]
            },
            electronics: {
                name: 'Electronics & Gadgets',
                icon: 'üì±',
                subcategories: [
                    { id: 'mobile-phones', name: 'Mobile Phones', icon: 'üì±' },
                    { id: 'mobile-accessories', name: 'Mobile Accessories', icon: 'üì±' },
                    { id: 'laptops-computers', name: 'Laptops & Computers', icon: 'üíª' },
                    { id: 'home-appliances', name: 'Home Appliances', icon: 'üîå' },
                    { id: 'audio-video', name: 'Audio & Video Systems', icon: 'üéµ' },
                    { id: 'gaming', name: 'Gaming Accessories', icon: 'üéÆ' },
                    { id: 'electronics-repair', name: 'Electronics Repair', icon: 'üîß' },
                    { id: 'smart-devices', name: 'Smart Home Devices', icon: 'üè†' },
                    { id: 'cameras', name: 'Cameras & Photography', icon: 'üì∑' },
                    { id: 'wearable-tech', name: 'Wearable Technology', icon: '‚åö' }
                ]
            }
        };

        // üîç DEBUG LOGGING SYSTEM
        function addDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.push({ timestamp, message, type });
            
            console.log(`üîç DEBUG ${type.toUpperCase()}: ${message}`);
            
            const debugLogEl = document.getElementById('debugLog');
            if (debugLogEl) {
                debugLogEl.innerHTML = debugLogs.slice(-20).map(log => 
                    `<div style="color: ${log.type === 'error' ? '#ff6b6b' : log.type === 'success' ? '#51cf66' : '#74c0fc'}; margin-bottom: 5px;">
                        [${log.timestamp}] ${log.message}
                    </div>`
                ).join('');
                debugLogEl.scrollTop = debugLogEl.scrollHeight;
            }
        }

        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('show');
        }

        // üéØ LIVE LEAD INTELLIGENCE WIDGET UPDATE
        function updateLeadIntelligenceWidget() {
            const widget = document.getElementById('leadWidget');
            const scoreEl = document.getElementById('widgetScore');
            const qualityEl = document.getElementById('widgetQuality');
            const detailsEl = document.getElementById('widgetDetails');
            
            if (!widget) return;
            
            // Calculate current score
            calculateLeadScore();
            
            // Update score display
            scoreEl.textContent = `${leadScore}/100`;
            
            // Update quality
            let quality = 'Cold Lead';
            let qualityClass = 'cold';
            
            if (leadScore >= 70) {
                quality = 'Hot Lead üî•';
                qualityClass = 'hot';
            } else if (leadScore >= 40) {
                quality = 'Warm Lead üå°Ô∏è';
                qualityClass = 'warm';
            } else {
                quality = 'Cold Lead ‚ùÑÔ∏è';
                qualityClass = 'cold';
            }
            
            qualityEl.textContent = quality;
            qualityEl.className = `lead-quality ${qualityClass}`;
            
            // Update details
            const sessionMinutes = Math.round((Date.now() - sessionStartTime) / 60000);
            detailsEl.innerHTML = `
                Session: ${sessionMinutes}m | Pages: ${pageViews}<br>
                Goals: ${selectedGoals.length} | Categories: ${selectedMainCategories.length + selectedSubcategories.length}
            `;
            
            addDebugLog(`üéØ Lead Intelligence Widget Updated: Score ${leadScore}/100, Quality: ${quality}`);
        }

        // üéØ UTM PARAMETER TRACKING
        function captureUTMParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            utmParams = {
                source: urlParams.get('utm_source') || 'Direct',
                medium: urlParams.get('utm_medium') || 'None',
                campaign: urlParams.get('utm_campaign') || 'None'
            };
            addDebugLog(`UTM Parameters captured: ${JSON.stringify(utmParams)}`);
        }

        // üì± DEVICE DETECTION
        function detectDevice() {
            const userAgent = navigator.userAgent;
            deviceInfo = {
                type: /Mobile|Android|iPhone|iPad/.test(userAgent) ? 'Mobile' : 'Desktop',
                browser: getBrowserName(userAgent),
                os: getOperatingSystem(userAgent),
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };
            addDebugLog(`Device Info: ${JSON.stringify(deviceInfo)}`);
        }

        function getBrowserName(userAgent) {
            if (userAgent.includes('Chrome')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            return 'Unknown';
        }

        function getOperatingSystem(userAgent) {
            if (userAgent.includes('Windows')) return 'Windows';
            if (userAgent.includes('Mac')) return 'MacOS';
            if (userAgent.includes('Linux')) return 'Linux';
            if (userAgent.includes('Android')) return 'Android';
            if (userAgent.includes('iOS')) return 'iOS';
            return 'Unknown';
        }

        // üîå DATABASE STATUS MANAGEMENT
        function updateDatabaseStatus(status, message) {
            const statusEl = document.getElementById('dbStatus');
            statusEl.className = `db-status ${status}`;
            statusEl.textContent = message;
            
            databaseConnected = (status === '' || status === 'connected');
            addDebugLog(`Database status: ${message}`, status === 'error' ? 'error' : 'info');
        }

        // üîç TEST DATABASE CONNECTION
        async function testDatabaseConnection() {
            try {
                updateDatabaseStatus('testing', 'üîÑ Testing connection...');
                addDebugLog('Testing database connection...');
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/users?limit=1`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                addDebugLog(`Connection test response: ${response.status} ${response.statusText}`);

                if (response.ok || response.status === 200) {
                    updateDatabaseStatus('', '‚úÖ Database connected');
                    addDebugLog('Database connection successful', 'success');
                    return true;
                } else {
                    const errorText = await response.text();
                    addDebugLog(`Database responding but with error: ${response.status} ${errorText}`);
                    
                    if (response.status === 400 || response.status === 401) {
                        updateDatabaseStatus('', '‚ö†Ô∏è Database connected (with permissions)');
                        addDebugLog('Database connected with permission restrictions', 'success');
                        return true;
                    }
                    
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                addDebugLog(`Database connection failed: ${error.message}`, 'error');
                
                if (error.message.includes('Failed to fetch')) {
                    updateDatabaseStatus('', '‚ö†Ô∏è Database working (CORS bypass)');
                    addDebugLog('Bypassing CORS issue - database should work for actual saves', 'info');
                    return true;
                } else {
                    updateDatabaseStatus('error', '‚ùå Database offline');
                    return false;
                }
            }
        }

        // üíæ ENHANCED SUPABASE SAVE WITH DETAILED DEBUGGING
        async function saveToSupabase(data, table = 'users') {
            try {
                addDebugLog(`üöÄ STARTING SAVE to table: ${table}`);
                addDebugLog(`üì§ Data being sent: ${JSON.stringify(data, null, 2)}`);
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(data)
                });

                addDebugLog(`üì• Response status: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const result = await response.json();
                    addDebugLog(`‚úÖ SAVE SUCCESSFUL to ${table}: ${JSON.stringify(result)}`, 'success');
                    updateDatabaseStatus('', '‚úÖ Saved to database');
                    return { success: true, data: result };
                } else {
                    const errorText = await response.text();
                    addDebugLog(`‚ùå SAVE FAILED to ${table}: Status ${response.status} - ${errorText}`, 'error');
                    updateDatabaseStatus('error', '‚ùå Database error');
                    
                    let detailedError = `HTTP ${response.status}: ${errorText}`;
                    try {
                        const errorObj = JSON.parse(errorText);
                        if (errorObj.message) {
                            detailedError = `${errorObj.code || 'ERROR'}: ${errorObj.message}`;
                            if (errorObj.details) detailedError += ` | Details: ${errorObj.details}`;
                            if (errorObj.hint) detailedError += ` | Hint: ${errorObj.hint}`;
                        }
                    } catch (e) {}
                    
                    return { success: false, error: detailedError };
                }
            } catch (error) {
                addDebugLog(`üí• SAVE EXCEPTION to ${table}: ${error.message}`, 'error');
                updateDatabaseStatus('error', '‚ùå Database offline');
                return { success: false, error: `Network Error: ${error.message}` };
            }
        }

        // üíæ ENHANCED SAVE WITH CATEGORIES SUPPORT
        async function saveDataSafely(leadData) {
            addDebugLog('üíæ Starting COMPLETE data save process...');
            
            // STEP 1: ALWAYS save to localStorage first (100% reliable)
            try {
                const existingLeads = JSON.parse(localStorage.getItem('topiko_local_leads') || '[]');
                const completeLocalData = {
                    ...leadData,
                    user_id: currentUserId,
                    created_at: new Date().toISOString(),
                    data_source: 'localStorage_primary',
                    // COMPLETE LEAD INTELLIGENCE IN LOCALSTORAGE
                    lead_intelligence: {
                        lead_score: leadScore,
                        lead_quality: leadScore >= 70 ? 'Hot' : leadScore >= 40 ? 'Warm' : 'Cold',
                        engagement_level: leadScore >= 70 ? 'High' : leadScore >= 40 ? 'Medium' : 'Low',
                        session_duration_minutes: Math.round((Date.now() - sessionStartTime) / 60000),
                        page_views: pageViews,
                        selected_goals: selectedGoals,
                        selected_language: selectedLanguage,
                        selected_main_categories: selectedMainCategories,  // NEW
                        selected_subcategories: selectedSubcategories,     // ENHANCED
                        device_type: deviceInfo.type,
                        browser: deviceInfo.browser,
                        utm_source: utmParams.source,
                        ready_for_sdr_assignment: true,
                        selected_theme: selectedTheme,
                        products_count: userProducts.length,
                        products: userProducts
                    }
                };
                
                const existingIndex = existingLeads.findIndex(lead => lead.user_id === currentUserId);
                if (existingIndex !== -1) {
                    existingLeads[existingIndex] = { ...existingLeads[existingIndex], ...completeLocalData };
                } else {
                    existingLeads.push(completeLocalData);
                }
                
                localStorage.setItem('topiko_local_leads', JSON.stringify(existingLeads));
                addDebugLog('‚úÖ COMPLETE DATA saved to localStorage (primary storage)', 'success');
                
                showNotification(`üíæ Lead saved! Score: ${leadScore}/100 (${leadScore >= 70 ? 'Hot' : leadScore >= 40 ? 'Warm' : 'Cold'} lead)`, 'success');
                
            } catch (error) {
                addDebugLog(`‚ùå LocalStorage save failed: ${error.message}`, 'error');
            }
            
            // STEP 2: Try to save to Supabase with DUPLICATE EMAIL HANDLING
            if (databaseConnected) {
                addDebugLog('üóÑÔ∏è Attempting database save...');
                
                const usersData = {
                    name: leadData.name,
                    email: leadData.email,
                    phone: leadData.phone,
                    business_name: leadData.business_name,
                    address: leadData.address,
                    business_type: leadData.business_type,
                    business_category: leadData.business_category
                };

                addDebugLog('üîÑ STEP 1: Saving to USERS table...');
                const usersResult = await saveToSupabase(usersData, 'users');
                
                let userId = null;
                
                if (usersResult.success) {
                    addDebugLog('‚úÖ USERS table save successful!', 'success');
                    showNotification('‚úÖ User data saved to database!', 'success');
                    userId = usersResult.data[0].id;
                } else if (usersResult.error.includes('duplicate key value') || usersResult.error.includes('23505')) {
                    addDebugLog('‚ö†Ô∏è DUPLICATE EMAIL detected - checking if user exists...', 'info');
                    
                    try {
                        const response = await fetch(`${SUPABASE_URL}/rest/v1/users?email=eq.${leadData.email}`, {
                            method: 'GET',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const existingUsers = await response.json();
                            if (existingUsers.length > 0) {
                                userId = existingUsers[0].id;
                                addDebugLog(`‚úÖ FOUND existing user with ID: ${userId}`, 'success');
                                showNotification('‚ö†Ô∏è Email exists, but proceeding with lead intelligence!', 'warning');
                            }
                        }
                    } catch (error) {
                        addDebugLog(`‚ùå Could not fetch existing user: ${error.message}`, 'error');
                    }
                } else {
                    addDebugLog(`‚ùå USERS table save failed: ${usersResult.error}`, 'error');
                    showNotification(`üíæ Database save failed: ${usersResult.error}`, 'error');
                }
                
                // STEP 3: Save LEAD INTELLIGENCE with ENHANCED CATEGORIES
                if (userId) {
                    currentUserId = userId;
                    
                    addDebugLog(`üîÑ STEP 2: Saving LEAD INTELLIGENCE for user ID: ${userId}...`);
                    
                    const intelligenceData = {
                        user_id: userId,
                        lead_score: leadScore,
                        lead_quality: leadScore >= 70 ? 'Hot' : leadScore >= 40 ? 'Warm' : 'Cold',
                        engagement_level: leadScore >= 70 ? 'High' : leadScore >= 40 ? 'Medium' : 'Low',
                        session_duration_minutes: Math.round((Date.now() - sessionStartTime) / 60000),
                        page_views: pageViews,
                        selected_goals: selectedGoals,
                        selected_language: selectedLanguage,
                        device_type: deviceInfo.type,
                        browser: deviceInfo.browser,
                        utm_source: utmParams.source,
                        lead_status: 'New',
                        ready_for_sdr_assignment: true,
                        // ENHANCED: Add category data if schema supports it
                        selected_main_categories: selectedMainCategories,    // NEW FIELD
                        selected_subcategories: selectedSubcategories        // ENHANCED FIELD
                    };
                    
                    addDebugLog(`üìä LEAD INTELLIGENCE data prepared: ${JSON.stringify(intelligenceData, null, 2)}`);
                    
                    const intelligenceResult = await saveToSupabase(intelligenceData, 'lead_intelligence');
                    
                    if (intelligenceResult.success) {
                        addDebugLog('üéâ LEAD INTELLIGENCE saved successfully! Complete data in database!', 'success');
                        showNotification('üéâ Complete lead intelligence saved!', 'success');
                    } else {
                        addDebugLog(`‚ùå LEAD INTELLIGENCE save failed: ${intelligenceResult.error}`, 'error');
                        showNotification(`‚ö†Ô∏è Lead intelligence failed: ${intelligenceResult.error}`, 'warning');
                    }
                } else {
                    addDebugLog('‚ùå Could not get user ID for lead intelligence save', 'error');
                    showNotification('‚ö†Ô∏è Could not save lead intelligence - no user ID', 'warning');
                }
            } else {
                addDebugLog('‚ö†Ô∏è Database not connected, localStorage only', 'info');
                showNotification('üíæ Saved locally (offline mode)', 'info');
            }
        }

        // üìä ENHANCED LEAD SCORING ALGORITHM
        function calculateLeadScore() {
            let score = 0;
            
            // Language Selection (5 points)
            if (selectedLanguage) score += 5;
            
            // Goals Selected (5 points per goal, max 25)
            score += Math.min(selectedGoals.length * 5, 25);
            
            // Form Progress (0-30 points based on completion)
            score += Math.floor(formProgress * 0.3);
            
            // Time on Site (0-20 points)
            const sessionMinutes = (Date.now() - sessionStartTime) / 60000;
            if (sessionMinutes > 1) score += 5;
            if (sessionMinutes > 3) score += 5;
            if (sessionMinutes > 5) score += 10;
            
            // Page Views (2 points per page, max 10)
            score += Math.min(pageViews * 2, 10);
            
            // Categories Selected (3 points per main category, 2 points per subcategory, max 20)
            score += Math.min(selectedMainCategories.length * 3, 15);
            score += Math.min(selectedSubcategories.length * 2, 15);
            
            // Products Added (2 points per product, max 10)
            score += Math.min(userProducts.length * 2, 10);
            
            // Theme Selected (10 points)
            if (selectedTheme) score += 10;
            
            leadScore = Math.min(score, 100);
            addDebugLog(`üìä Lead Score Updated: ${leadScore}/100`);
            
            // Update widget
            updateLeadIntelligenceWidget();
            
            return leadScore;
        }

        // üåê LANGUAGE SELECTION
        function selectLanguage(lang, element) {
            selectedLanguage = lang;
            
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('selected');
            });
            element.classList.add('selected');
            
            const languageNames = {
                'en': 'English',
                'hi': '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä',
                'te': '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å',
                'ta': '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç'
            };
            
            showNotification(`Language selected: ${languageNames[lang]}`, 'success');
            calculateLeadScore();
            
            setTimeout(() => showScreen('goals'), 1500);
        }

        // üéØ GOALS TRACKING
        function updateGoalsTracking() {
            const checkedGoals = document.querySelectorAll('.goal-checkbox:checked');
            selectedGoals = Array.from(checkedGoals).map(checkbox => checkbox.value);
            
            addDebugLog(`Goals updated: ${JSON.stringify(selectedGoals)}`);
            calculateLeadScore();
        }

        // üéØ GOALS SUBMISSION
        function submitGoals() {
            if (selectedGoals.length === 0) {
                showNotification('Please select at least one goal to continue', 'error');
                return;
            }

            addDebugLog(`Goals submitted: ${JSON.stringify(selectedGoals)}`);
            showNotification(`Great! You've selected ${selectedGoals.length} goal${selectedGoals.length > 1 ? 's' : ''}`, 'success');
            calculateLeadScore();
            
            setTimeout(() => showScreen('registration'), 1500);
        }

        // üìù FORM PROGRESS TRACKING
        function trackFormProgress() {
            const formFields = ['fullName', 'email', 'phoneNumber', 'businessName', 'address', 'businessType', 'category'];
            let completedFields = 0;
            
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value.trim() !== '') {
                    completedFields++;
                }
            });
            
            formProgress = (completedFields / formFields.length) * 100;
            addDebugLog(`Form progress: ${Math.round(formProgress)}%`);
            calculateLeadScore();
        }

        // üìù REGISTRATION SUBMISSION
        async function submitRegistration() {
            addDebugLog('üéØ REGISTRATION SUBMISSION STARTED');
            
            const name = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phoneNumber').value.trim();
            const business = document.getElementById('businessName').value.trim();
            const address = document.getElementById('address').value.trim();
            const type = document.getElementById('businessType').value;
            const category = document.getElementById('category').value;

            if (!name || !email || !phone || !business || !address || !type || !category) {
                showNotification('Please fill in all fields', 'error');
                addDebugLog('‚ùå Registration failed: Missing required fields', 'error');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('Please enter a valid email address', 'error');
                addDebugLog('‚ùå Registration failed: Invalid email format', 'error');
                return;
            }

            showNotification('Creating your account...', 'info');
            addDebugLog('‚úÖ Form validation passed, proceeding with save...');
            addDebugLog(`üîç Attempting to save user with email: ${email}`);

            currentUserId = 'topiko_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            addDebugLog(`üÜî Generated user ID: ${currentUserId}`);

            const leadData = {
                name: name,
                email: email,
                phone: phone,
                business_name: business,
                address: address,
                business_type: type,
                business_category: category,
                selected_language: selectedLanguage,
                selected_goals: selectedGoals,
                lead_score: leadScore,
                engagement_level: leadScore >= 70 ? 'High' : leadScore >= 40 ? 'Medium' : 'Low',
                session_duration_minutes: Math.round((Date.now() - sessionStartTime) / 60000),
                page_views: pageViews,
                form_completion_percentage: formProgress,
                utm_source: utmParams.source,
                device_type: deviceInfo.type,
                browser: deviceInfo.browser,
                lead_status: 'New',
                lead_quality: leadScore >= 70 ? 'Hot' : leadScore >= 40 ? 'Warm' : 'Cold',
                ready_for_sdr_assignment: true,
                registration_completed: true,
                session_start_time: new Date(sessionStartTime).toISOString(),
                registration_completed_time: new Date().toISOString()
            };

            addDebugLog(`üìã Complete lead data prepared: ${JSON.stringify(leadData, null, 2)}`);

            await saveDataSafely(leadData);
            
            showNotification('‚úÖ Registration completed successfully!', 'success');
            addDebugLog('üéâ Registration process completed!', 'success');
            
            setTimeout(() => showScreen('categories'), 2000);
        }

        // üè∑Ô∏è LOAD COMPREHENSIVE CATEGORIES
        function loadComprehensiveCategories() {
            const categoriesContainer = document.getElementById('categoriesContainer');
            
            const categoryGroups = Object.entries(comprehensiveBusinessCategories).map(([key, category]) => `
                <div class="category-group">
                    <div class="main-category-header" onclick="toggleMainCategory('${key}')">
                        <input type="checkbox" id="main-${key}" class="main-category-checkbox" onchange="handleMainCategoryChange('${key}')" />
                        <div class="main-category-icon">${category.icon}</div>
                        <div class="main-category-title">${category.name}</div>
                    </div>
                    
                    <div class="subcategories-grid" id="subcategories-${key}">
                        ${category.subcategories.map(subcat => `
                            <div class="subcategory-item">
                                <input type="checkbox" id="sub-${subcat.id}" class="subcategory-checkbox" value="${subcat.id}" onchange="handleSubcategoryChange('${key}', '${subcat.id}')" />
                                <div class="subcategory-icon">${subcat.icon}</div>
                                <label for="sub-${subcat.id}" class="subcategory-label">${subcat.name}</label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            categoriesContainer.innerHTML = categoryGroups;
            
            addDebugLog('üìÇ Comprehensive categories loaded with checkboxes');
        }

        // üè∑Ô∏è TOGGLE MAIN CATEGORY
        function toggleMainCategory(categoryKey) {
            const subcategoriesGrid = document.getElementById(`subcategories-${categoryKey}`);
            subcategoriesGrid.classList.toggle('show');
        }

        // üè∑Ô∏è HANDLE MAIN CATEGORY CHANGE
        function handleMainCategoryChange(categoryKey) {
            const checkbox = document.getElementById(`main-${categoryKey}`);
            
            if (checkbox.checked) {
                if (!selectedMainCategories.includes(categoryKey)) {
                    selectedMainCategories.push(categoryKey);
                }
                // Show subcategories when main category is selected
                document.getElementById(`subcategories-${categoryKey}`).classList.add('show');
            } else {
                selectedMainCategories = selectedMainCategories.filter(id => id !== categoryKey);
                // Hide subcategories and uncheck all when main category is unchecked
                document.getElementById(`subcategories-${categoryKey}`).classList.remove('show');
                
                // Uncheck all subcategories of this main category
                const subcategoryCheckboxes = document.querySelectorAll(`#subcategories-${categoryKey} .subcategory-checkbox`);
                subcategoryCheckboxes.forEach(subCheckbox => {
                    if (subCheckbox.checked) {
                        subCheckbox.checked = false;
                        selectedSubcategories = selectedSubcategories.filter(id => id !== subCheckbox.value);
                    }
                });
            }
            
            updateSelectionSummary();
            calculateLeadScore();
        }

        // üè∑Ô∏è HANDLE SUBCATEGORY CHANGE
        function handleSubcategoryChange(categoryKey, subcategoryId) {
            const checkbox = document.getElementById(`sub-${subcategoryId}`);
            
            if (checkbox.checked) {
                if (!selectedSubcategories.includes(subcategoryId)) {
                    selectedSubcategories.push(subcategoryId);
                }
                // Auto-check main category if not already checked
                const mainCheckbox = document.getElementById(`main-${categoryKey}`);
                if (!mainCheckbox.checked) {
                    mainCheckbox.checked = true;
                    if (!selectedMainCategories.includes(categoryKey)) {
                        selectedMainCategories.push(categoryKey);
                    }
                }
            } else {
                selectedSubcategories = selectedSubcategories.filter(id => id !== subcategoryId);
            }
            
            updateSelectionSummary();
            calculateLeadScore();
        }

        // üìù UPDATE SELECTION SUMMARY
        function updateSelectionSummary() {
            const summaryDiv = document.getElementById('selectionSummary');
            const summaryContent = document.getElementById('summaryContent');
            const nextBtn = document.getElementById('categoryNextBtn');
            
            const totalSelections = selectedMainCategories.length + selectedSubcategories.length;
            
            if (totalSelections > 0) {
                summaryDiv.classList.add('show');
                
                let summaryText = '';
                
                if (selectedMainCategories.length > 0) {
                    const mainCategoryNames = selectedMainCategories.map(key => {
                        const category = comprehensiveBusinessCategories[key];
                        return `${category.icon} ${category.name}`;
                    });
                    summaryText += `<strong>Main Categories:</strong> ${mainCategoryNames.join(', ')}<br>`;
                }
                
                if (selectedSubcategories.length > 0) {
                    const subcategoryNames = selectedSubcategories.map(id => {
                        // Find the subcategory across all main categories
                        for (const [key, category] of Object.entries(comprehensiveBusinessCategories)) {
                            const subcat = category.subcategories.find(s => s.id === id);
                            if (subcat) return `${subcat.icon} ${subcat.name}`;
                        }
                        return id;
                    });
                    summaryText += `<strong>Subcategories:</strong> ${subcategoryNames.join(', ')}`;
                }
                
                summaryContent.innerHTML = summaryText;
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
            } else {
                summaryDiv.classList.remove('show');
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.5';
            }
            
            addDebugLog(`Categories selected: ${selectedMainCategories.length} main, ${selectedSubcategories.length} sub`);
        }

        // ‚û°Ô∏è PROCEED TO PRODUCTS
        function proceedToProducts() {
            if (selectedMainCategories.length === 0 && selectedSubcategories.length === 0) {
                showNotification('Please select at least one category or subcategory', 'error');
                return;
            }
            
            showNotification(`Great! You've selected ${selectedMainCategories.length} main categories and ${selectedSubcategories.length} subcategories`, 'success');
            setTimeout(() => showScreen('products'), 1000);
        }

        // üì¶ ADD PRODUCT
        function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = document.getElementById('productPrice').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            
            if (!name || !price || !description) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            if (isNaN(price) || price <= 0) {
                showNotification('Please enter a valid price', 'error');
                return;
            }
            
            const product = {
                id: 'prod_' + Date.now(),
                name: name,
                price: parseFloat(price),
                description: description,
                createdAt: new Date().toISOString()
            };
            
            userProducts.push(product);
            
            // Clear form
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productDescription').value = '';
            
            displayProducts();
            calculateLeadScore();
            
            showNotification(`Product "${name}" added successfully!`, 'success');
        }

        // üìã DISPLAY PRODUCTS
        function displayProducts() {
            const productsList = document.getElementById('productsList');
            const productCount = document.getElementById('productCount');
            
            productCount.textContent = userProducts.length;
            
            if (userProducts.length === 0) {
                productsList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #64748b; background: rgba(255, 255, 255, 0.5); border-radius: 12px;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                        <p>No products added yet. Add your first product above!</p>
                    </div>
                `;
                return;
            }
            
            productsList.innerHTML = userProducts.map(product => `
                <div class="product-card" style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="padding: 1rem;">
                        <div style="font-size: 1.1rem; font-weight: 600; color: #1e293b; margin-bottom: 0.5rem;">${product.name}</div>
                        <div style="color: #059669; font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">‚Çπ${product.price.toLocaleString()}</div>
                        <div style="color: #64748b; font-size: 0.9rem;">${product.description}</div>
                    </div>
                </div>
            `).join('');
        }

        // üé® PROCEED TO THEMES
        function proceedToThemes() {
            calculateLeadScore();
            showNotification(`Great! You've added ${userProducts.length} products. Moving to themes...`, 'success');
            setTimeout(() => showScreen('themes'), 1500);
        }

        // üé® THEME SELECTION
        function selectTheme(theme) {
            selectedTheme = theme;
            
            document.querySelectorAll('.theme-preview').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedCard = event.target.closest('.theme-preview');
            selectedCard.classList.add('selected');
            
            const selectedDiv = document.getElementById('selectedTheme');
            const selectedText = document.getElementById('selectedThemeText');
            const completeBtn = document.getElementById('themeNextBtn');
            
            const themeNames = {
                'modern': 'Modern Professional - Clean and minimal design',
                'colorful': 'Colorful Creative - Vibrant and engaging design',
                'elegant': 'Elegant Luxury - Sophisticated and refined design'
            };
            
            selectedDiv.style.display = 'block';
            selectedText.textContent = `You've selected: ${themeNames[theme]}`;
            
            completeBtn.disabled = false;
            completeBtn.style.opacity = '1';
            
            calculateLeadScore();
            showNotification(`Theme selected: ${themeNames[theme].split(' - ')[0]}`, 'success');
        }

        // üöÄ COMPLETE SETUP
        async function completeSetup() {
            if (!selectedTheme) {
                showNotification('Please select a theme to complete setup', 'error');
                return;
            }

            const completeSetupData = {
                user_id: currentUserId,
                name: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                business_name: document.getElementById('businessName').value,
                phone: document.getElementById('phoneNumber').value,
                business_category: document.getElementById('category').value,
                selected_language: selectedLanguage,
                selected_goals: selectedGoals,
                selected_main_categories: selectedMainCategories,   // NEW
                selected_subcategories: selectedSubcategories,     // ENHANCED
                selected_theme: selectedTheme,
                products_count: userProducts.length,
                products: userProducts,
                lead_score: leadScore + 15, // Bonus for completion
                setup_completed: true,
                completed_at: new Date().toISOString()
            };

            await saveDataSafely(completeSetupData);
            
            showNotification('üéâ Setup completed successfully!', 'success');
            
            setTimeout(() => {
                const dbStatus = databaseConnected ? 'Database connected ‚úÖ' : 'Offline mode üíæ';
                alert(`‚úÖ Congratulations! 
                
Your Topiko business platform setup is complete:
‚Ä¢ Business: ${document.getElementById('businessName').value}
‚Ä¢ Categories: ${selectedMainCategories.length} main, ${selectedSubcategories.length} sub
‚Ä¢ Products: ${userProducts.length}
‚Ä¢ Theme: ${selectedTheme}
‚Ä¢ Lead Score: ${leadScore}/100

${dbStatus}

Enhanced Features:
‚Ä¢ Live lead intelligence tracking
‚Ä¢ Comprehensive category selection
‚Ä¢ Real-time scoring widget

Your complete lead data has been captured!`);
            }, 1500);
        }

        // üìÑ SCREEN NAVIGATION
        function showScreen(screenId) {
            pageViews++;
            
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });

            document.getElementById(screenId).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[onclick="showScreen('${screenId}')"]`).classList.add('active');
            
            // Special handling for categories page
            if (screenId === 'categories') {
                setTimeout(loadComprehensiveCategories, 100);
            }
            
            addDebugLog(`üìÑ Navigated to screen: ${screenId}`);
            calculateLeadScore();
        }

        // üîî NOTIFICATIONS
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 400);
            }, 3000);
        }

        // üöÄ INITIALIZATION
        document.addEventListener('DOMContentLoaded', async function() {
            addDebugLog('üöÄ Topiko Lead Form - ENHANCED VERSION Initialized');
            
            captureUTMParameters();
            detectDevice();
            databaseConnected = await testDatabaseConnection();
            
            // Initialize lead intelligence widget
            updateLeadIntelligenceWidget();
            
            // Update widget every 10 seconds
            setInterval(updateLeadIntelligenceWidget, 10000);
            
            addDebugLog('‚úÖ Enhanced Lead Intelligence System Ready');
            addDebugLog('üéØ Live intelligence widget active');
            addDebugLog('üìÇ Comprehensive categories with checkboxes loaded');
            addDebugLog('üíæ Enhanced database storage for categories');
        });

        // Track all clicks for behavior analysis
        document.addEventListener('click', function(event) {
            behaviorData.clickEvents.push({
                type: 'click',
                element: event.target.tagName,
                class: event.target.className,
                id: event.target.id,
                timestamp: Date.now()
            });
            
            // Update widget on interaction
            setTimeout(updateLeadIntelligenceWidget, 100);
        });

        // Track form focus events
        document.addEventListener('focus', function(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
                behaviorData.formInteractions.push({
                    type: 'field_focus',
                    field: event.target.id,
                    timestamp: Date.now()
                });
                
                // Update widget on form interaction
                setTimeout(updateLeadIntelligenceWidget, 100);
            }
        }, true);
    </script>
</body>
</html>