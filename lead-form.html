<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topiko - Complete Business Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8f6ff 0%, #f0ebff 50%, #e8e0ff 100%);
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Database Status Indicator */
        .db-status {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .db-status.testing {
            background: rgba(59, 130, 246, 0.9);
        }

        .db-status.error {
            background: rgba(239, 68, 68, 0.9);
        }

        /* Error Display */
        .error-display {
            position: fixed;
            top: 5rem;
            left: 1rem;
            background: rgba(239, 68, 68, 0.95);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            font-size: 0.8rem;
            max-width: 400px;
            z-index: 1001;
            display: none;
        }

        .error-display.show {
            display: block;
        }

        /* Lead Intelligence Widget */
        .lead-intelligence-widget {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(139, 111, 205, 0.2);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(139, 111, 205, 0.2);
            z-index: 1000;
            max-width: 320px;
            min-width: 280px;
            transition: all 0.3s ease;
        }

        .widget-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .widget-header h3 {
            color: #6b46c1;
            font-size: 1.1rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .lead-score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            margin-bottom: 1rem;
        }

        .lead-score-circle.hot {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 2s infinite;
        }

        .lead-score-circle.warm {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .lead-score-circle.cold {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .widget-stats {
            font-size: 0.9rem;
            color: #553c9a;
            line-height: 1.5;
        }

        .widget-stats .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            font-size: 0.8rem;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }

        .debug-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1002;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 260px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(139, 111, 205, 0.1);
            padding: 2rem 0;
            position: relative;
            box-shadow: 0 0 50px rgba(139, 111, 205, 0.05);
        }

        .logo-section {
            text-align: center;
            margin-bottom: 3rem;
            padding: 0 2rem;
        }

        .logo-section h1 {
            color: #6b46c1;
            font-size: 1.8rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin: 0.3rem 0;
            padding: 0 1rem;
        }

        .nav-link {
            display: block;
            padding: 0.9rem 1.2rem;
            color: #6b46c1;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .nav-link:hover,
        .nav-link.active {
            color: #553c9a;
            background: rgba(139, 111, 205, 0.1);
            transform: translateX(2px);
            box-shadow: 0 4px 20px rgba(139, 111, 205, 0.1);
        }

        .nav-icon {
            margin-right: 0.8rem;
            font-size: 1.1rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            position: relative;
            overflow-y: auto;
            padding: 2rem;
        }

        .screen {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }

        @keyframes sparkleFloat {
            0% { transform: translateY(0) scale(0) rotate(0deg); opacity: 1; }
            50% { transform: translateY(-30px) scale(1) rotate(180deg); opacity: 1; }
            100% { transform: translateY(-60px) scale(0) rotate(360deg); opacity: 0; }
        }

        /* Goals Transition Styles */
        .goal-pill {
            background: linear-gradient(135deg, #8b6fcd, #6b46c1);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(139, 111, 205, 0.3);
            margin: 0.3rem;
            display: inline-block;
        }

        .time-promise {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin: 1.5rem 0;
            color: #059669;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .confidence-boost {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin: 1.5rem 0;
            color: #d97706;
            font-weight: 500;
            font-size: 1rem;
        }

        .features-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .feature-item {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(139, 111, 205, 0.2);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
            text-align: center;
        }

        .feature-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 111, 205, 0.15);
            border-color: rgba(139, 111, 205, 0.3);
        }

        .feature-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .feature-title {
            color: #6b46c1;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .feature-desc {
            color: #553c9a;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 80vh;
            background: linear-gradient(135deg, #faf9ff 0%, #f3f0ff 100%);
            border-radius: 20px;
            padding: 3rem;
        }

        .topiko-logo {
            font-size: 4rem;
            font-weight: 300;
            color: #6b46c1;
            letter-spacing: -2px;
            margin-bottom: 3rem;
        }

        .try-free-button {
            background: linear-gradient(135deg, #8b6fcd 0%, #6b46c1 100%);
            color: white;
            border: none;
            padding: 1rem 3rem;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 30px rgba(107, 70, 193, 0.3);
        }

        .try-free-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(107, 70, 193, 0.4);
        }

        /* Content Cards */
        .content-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(139, 111, 205, 0.1);
            border: 1px solid rgba(139, 111, 205, 0.1);
        }

        .content-card h2 {
            color: #6b46c1;
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            letter-spacing: -1px;
        }

        .content-card p {
            color: #553c9a;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #6b46c1;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.9rem 1.2rem;
            border: 1.5px solid rgba(139, 111, 205, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            color: #553c9a;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #8b6fcd;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(139, 111, 205, 0.1);
        }

        .submit-button {
            width: 100%;
            background: linear-gradient(135deg, #8b6fcd 0%, #6b46c1 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 30px rgba(107, 70, 193, 0.3);
            margin-top: 1rem;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(107, 70, 193, 0.4);
        }

        .submit-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Language Selection */
        .language-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .language-option {
            display: flex;
            align-items: center;
            padding: 1.5rem 2rem;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(139, 111, 205, 0.1);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .language-option:hover,
        .language-option.selected {
            background: rgba(139, 111, 205, 0.15);
            border-color: #8b6fcd;
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(139, 111, 205, 0.25);
        }

        .language-flag {
            font-size: 3rem;
            margin-right: 1.5rem;
            min-width: 60px;
            text-align: center;
        }

        .language-content h3 {
            color: #6b46c1;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .language-content p {
            color: #553c9a;
            font-size: 1rem;
            margin: 0;
        }

        /* Goals Selection */
        .goals-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .goal-option {
            position: relative;
        }

        .goal-checkbox {
            display: none;
        }

        .goal-card {
            display: flex;
            align-items: center;
            padding: 1.5rem 2rem;
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid rgba(139, 111, 205, 0.1);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .goal-card:hover {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(139, 111, 205, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(139, 111, 205, 0.15);
        }

        .goal-checkbox:checked + .goal-card {
            background: rgba(139, 111, 205, 0.1);
            border-color: #8b6fcd;
            box-shadow: 0 8px 30px rgba(139, 111, 205, 0.2);
        }

        .goal-icon {
            font-size: 2.5rem;
            margin-right: 1.5rem;
            min-width: 60px;
            text-align: center;
        }

        .goal-content h3 {
            color: #6b46c1;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .goal-content p {
            color: #553c9a;
            font-size: 0.95rem;
            margin: 0;
        }

        .goal-checkmark {
            font-size: 1.5rem;
            color: #8b6fcd;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease;
            margin-left: 1rem;
        }

        .goal-checkbox:checked + .goal-card .goal-checkmark {
            opacity: 1;
            transform: scale(1);
        }

        /* Categories and Subcategories */
        .category-section {
            margin-bottom: 2rem;
        }

        .category-section h3 {
            color: #6b46c1;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .category-section h3 .icon {
            font-size: 2rem;
            margin-right: 0.5rem;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .category-item {
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid rgba(139, 111, 205, 0.1);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
        }

        .category-item:hover {
            border-color: rgba(139, 111, 205, 0.3);
            box-shadow: 0 4px 15px rgba(139, 111, 205, 0.1);
        }

        .category-checkbox {
            display: none;
        }

        .category-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            color: #6b46c1;
            margin-bottom: 0.5rem;
        }

        .category-checkbox:checked + .category-label {
            color: #8b6fcd;
        }

        .category-icon {
            font-size: 1.5rem;
            margin-right: 0.8rem;
        }

        .category-checkmark {
            margin-left: auto;
            color: #8b6fcd;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .category-checkbox:checked + .category-label .category-checkmark {
            opacity: 1;
        }

        .subcategory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-top: 0.8rem;
        }

        .subcategory-item {
            background: rgba(139, 111, 205, 0.05);
            border: 1px solid rgba(139, 111, 205, 0.1);
            border-radius: 8px;
            padding: 0.5rem;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .subcategory-checkbox {
            display: none;
        }

        .subcategory-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: #553c9a;
            font-size: 0.85rem;
        }

        .subcategory-checkbox:checked + .subcategory-label {
            color: #8b6fcd;
            font-weight: 600;
        }

        .subcategory-item:hover {
            background: rgba(139, 111, 205, 0.1);
            border-color: rgba(139, 111, 205, 0.2);
        }

        .subcategory-checkmark {
            margin-left: auto;
            font-size: 0.8rem;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .subcategory-checkbox:checked + .subcategory-label .subcategory-checkmark {
            opacity: 1;
        }

        /* Products */
        .product-form {
            background: rgba(255, 255, 255, 0.7);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .product-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .product-image {
            height: 150px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .product-price {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #059669;
        }

        .product-content {
            padding: 1rem;
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .product-description {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, #8b6fcd 0%, #6b46c1 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(107, 70, 193, 0.3);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s ease;
            z-index: 1003;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .notification.success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        /* Summary Section */
        .selection-summary {
            background: rgba(139, 111, 205, 0.1);
            border: 2px solid rgba(139, 111, 205, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-title {
            color: #6b46c1;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .summary-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            font-size: 0.9rem;
        }

        .summary-item {
            color: #553c9a;
        }

        .summary-count {
            font-weight: 600;
            color: #8b6fcd;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .logo-section h1 {
                display: none;
            }

            .nav-link span:not(.nav-icon) {
                display: none;
            }

            .lead-intelligence-widget {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                max-width: none;
            }

            .category-grid {
                grid-template-columns: 1fr;
            }

            .summary-content {
                grid-template-columns: 1fr;
            }

            .features-preview {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Database Status Indicator -->
    <div class="db-status testing" id="dbStatus">
        üîÑ Testing connection...
    </div>

    <!-- Error Display -->
    <div class="error-display" id="errorDisplay">
        <div id="errorContent"></div>
    </div>

    <!-- Debug Toggle -->
    <button class="debug-toggle" onclick="toggleDebugPanel()">üîç Debug</button>
    
    <!-- Test Button -->
    <button onclick="testDatabaseSave()" style="position: fixed; top: 4rem; right: 1rem; background: rgba(34, 197, 94, 0.8); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; z-index: 1002; font-size: 0.8rem;">
        üß™ Test Save
    </button>

    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <h4>üîç Database Debug Log</h4>
        <div id="debugLog"></div>
    </div>

    <!-- Lead Intelligence Widget -->
    <div class="lead-intelligence-widget" id="leadWidget">
        <div class="widget-header">
            <span>üéØ</span>
            <h3>Lead Intelligence</h3>
        </div>
        <div class="lead-score-circle cold" id="leadScoreCircle">
            <span id="leadScoreValue">0</span>
        </div>
        <div class="widget-stats" id="widgetStats">
            <div class="stat-item">
                <span>Quality:</span>
                <span id="leadQuality">Cold</span>
            </div>
            <div class="stat-item">
                <span>Engagement:</span>
                <span id="engagementLevel">Low</span>
            </div>
            <div class="stat-item">
                <span>Session:</span>
                <span id="sessionTime">0m</span>
            </div>
            <div class="stat-item">
                <span>Page Views:</span>
                <span id="pageViewCount">1</span>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div id="notificationContent"></div>
    </div>

    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="logo-section">
                <h1>Topiko</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <div class="nav-link active" onclick="showScreen('welcome')">
                        <span class="nav-icon">üè†</span>
                        <span>Home</span>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="nav-link" onclick="showScreen('language')">
                        <span class="nav-icon">üåê</span>
                        <span>Language</span>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="nav-link" onclick="showScreen('goals')">
                        <span class="nav-icon">üéØ</span>
                        <span>Goals</span>
                    </div>
                </li>
                <li class="nav-item">
                    <div class="nav-link" onclick="showScreen('goals-transition')">
                        <span class="nav-icon">‚ú®</span>
                        <span>Preview</span>
                    </div>
                    </li><li class="nav-item">
                    <div class="nav-link" onclick="showScreen('registration')">
                        <span class="nav-icon">üìù</span>
                        <span>Sign Up</span>
                    </div>
    </li>
    <li class="nav-item">
        <div class="nav-link" onclick="showScreen('setup-intro')">
            <span class="nav-icon">üöÄ</span>
            <span>Setup</span>
        </div>
    </li>
    <li class="nav-item">
        <div class="nav-link" onclick="showScreen('categories')">
            <span class="nav-icon">üìÇ</span>
            <span>Categories</span>
        </div>
    </li>
                <li class="nav-item">
                    <div class="nav-link" onclick="showScreen('products')">
                        <span class="nav-icon">üì¶</span>
                        <span>Products</span>
                    </div>
                </li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Welcome Screen -->
            <section class="screen active" id="welcome">
                <div class="welcome-screen">
                    <h1 class="topiko-logo">Topiko</h1>
                    <p style="font-size: 1.2rem; color: #6b46c1; margin-bottom: 2rem;">Complete Business Platform for Indian SMBs</p>
                    <p style="font-size: 1rem; color: #059669; margin-bottom: 2rem; font-weight: bold;">‚úÖ Enhanced with Goals Transition</p>
                    <button class="try-free-button" onclick="startLeadFlow()">
                        Try for Free
                    </button>
                </div>
            </section>

            <!-- Language Selection Screen -->
            <section class="screen" id="language">
                <div class="content-card" style="max-width: 600px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 0.5rem;">Choose Your Language</h2>
                    <p style="text-align: center; margin-bottom: 3rem;">‡§Ö‡§™‡§®‡•Ä ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç | ‡∞Æ‡±Ä ‡∞≠‡∞æ‡∞∑‡∞®‡±Å ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø | ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç</p>
                    
                    <div class="language-grid">
                        <div class="language-option" onclick="selectLanguage('en', this)">
                            <div class="language-flag">üá¨üáß</div>
                            <div class="language-content">
                                <h3>English</h3>
                                <p>Continue in English</p>
                            </div>
                        </div>

                        <div class="language-option" onclick="selectLanguage('hi', this)">
                            <div class="language-flag">üáÆüá≥</div>
                            <div class="language-content">
                                <h3>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</h3>
                                <p>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç</p>
                            </div>
                        </div>

                        <div class="language-option" onclick="selectLanguage('te', this)">
                            <div class="language-flag">üáÆüá≥</div>
                            <div class="language-content">
                                <h3>‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</h3>
                                <p>‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å‡∞≤‡±ã ‡∞ï‡±ä‡∞®‡∞∏‡∞æ‡∞ó‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø</p>
                            </div>
                        </div>

                        <div class="language-option" onclick="selectLanguage('ta', this)">
                            <div class="language-flag">üáÆüá≥</div>
                            <div class="language-content">
                                <h3>‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</h3>
                                <p>‡Æ§‡ÆÆ‡Æø‡Æ¥‡Æø‡Æ≤‡Øç ‡Æ§‡Øä‡Æü‡Æ∞‡Æµ‡ØÅ‡ÆÆ‡Øç</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Goals Selection Screen -->
            <section class="screen" id="goals">
                <div class="content-card" style="max-width: 700px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 0.5rem;">Select Your Goals</h2>
                    <p style="text-align: center; margin-bottom: 3rem;">Choose what you want to achieve with Topiko (select all that apply)</p>
                    
                    <div class="goals-grid">
                        <div class="goal-option">
                            <input type="checkbox" id="goal-ecommerce" value="ecommerce" class="goal-checkbox" onchange="updateGoalsTracking()">
                            <label for="goal-ecommerce" class="goal-card">
                                <div class="goal-icon">üõí</div>
                                <div class="goal-content">
                                    <h3>Sell Online (E-commerce)</h3>
                                    <p>Start selling your products online with a complete e-commerce solution</p>
                                </div>
                                <div class="goal-checkmark">‚úì</div>
                            </label>
                        </div>

                        <div class="goal-option">
                            <input type="checkbox" id="goal-customers" value="customers" class="goal-checkbox" onchange="updateGoalsTracking()">
                            <label for="goal-customers" class="goal-card">
                                <div class="goal-icon">üìà</div>
                                <div class="goal-content">
                                    <h3>Reach More Customers</h3>
                                    <p>Expand your customer base and grow your market reach</p>
                                </div>
                                <div class="goal-checkmark">‚úì</div>
                            </label>
                        </div>

                        <div class="goal-option">
                            <input type="checkbox" id="goal-manage" value="manage" class="goal-checkbox" onchange="updateGoalsTracking()">
                            <label for="goal-manage" class="goal-card">
                                <div class="goal-icon">üë•</div>
                                <div class="goal-content">
                                    <h3>Manage Customers</h3>
                                    <p>Keep track of your customers and build lasting relationships</p>
                                </div>
                                <div class="goal-checkmark">‚úì</div>
                            </label>
                        </div>

                        <div class="goal-option">
                            <input type="checkbox" id="goal-search" value="search" class="goal-checkbox" onchange="updateGoalsTracking()">
                            <label for="goal-search" class="goal-card">
                                <div class="goal-icon">üîç</div>
                                <div class="goal-content">
                                    <h3>Appear in Search Results</h3>
                                    <p>Improve your online visibility and get found by potential customers</p>
                                </div>
                                <div class="goal-checkmark">‚úì</div>
                            </label>
                        </div>

                        <div class="goal-option">
                            <input type="checkbox" id="goal-brand" value="brand" class="goal-checkbox" onchange="updateGoalsTracking()">
                            <label for="goal-brand" class="goal-card">
                                <div class="goal-icon">‚≠ê</div>
                                <div class="goal-content">
                                    <h3>Establish my Brand</h3>
                                    <p>Build a strong brand presence and professional image online</p>
                                </div>
                                <div class="goal-checkmark">‚úì</div>
                            </label>
                        </div>
                    </div>

                    <button class="submit-button" onclick="submitGoals()">
                        Next Step
                    </button>
                </div>
            </section>

            <!-- Goals Transition Screen -->
            <section class="screen" id="goals-transition">
                <div class="content-card" style="max-width: 800px; margin: 0 auto; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #8b6fcd, #6b46c1, #553c9a); border-radius: 20px 20px 0 0;"></div>
                    
                    <div style="text-align: center;">
                        <div style="font-size: 4rem; margin-bottom: 1.5rem; animation: bounce 2s infinite;" id="celebrationEmoji">üéâ</div>
                        
                        <h2 style="color: #6b46c1; font-size: 2.2rem; font-weight: 700; margin-bottom: 1rem; line-height: 1.3; letter-spacing: -0.5px;" id="mainMessage">
                            Perfect! Let's make it happen!
                        </h2>
                        
                        <p style="color: #553c9a; font-size: 1.3rem; font-weight: 500; margin-bottom: 2rem; line-height: 1.5;" id="subMessage">
                            I can see exactly what you need, and I'm excited to show you how our platform will transform your business.
                        </p>

                        <div style="background: rgba(139, 111, 205, 0.1); border: 2px solid rgba(139, 111, 205, 0.2); border-radius: 16px; padding: 1.5rem; margin: 2rem 0;">
                            <h3 style="color: #6b46c1; font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">üéØ Your Selected Goals:</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.8rem; justify-content: center;" id="goalsList">
                                <!-- Goals will be populated here -->
                            </div>
                        </div>

                        <div id="customContent">
                            <!-- Custom content based on goals will be inserted here -->
                        </div>

                        <button class="submit-button" onclick="proceedFromTransition()" style="animation: pulse 2s infinite;">
                            <span id="actionText">Let's Get Started! üöÄ</span>
                        </button>

                        <div style="margin-top: 2rem; color: #64748b; font-size: 0.9rem;">
                            <p>‚ú® Join thousands of successful Indian businesses already using Topiko</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Registration Screen -->
            <section class="screen" id="registration">
                <div class="content-card" style="max-width: 600px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 0.5rem;">Get Started with Topiko</h2>
                    <p style="text-align: center; margin-bottom: 2rem;">Tell us about your business to create your free account</p>
                    
                    <div class="form-group">
                        <label for="fullName">Your Name</label>
                        <input type="text" id="fullName" placeholder="Enter your full name" oninput="trackFormProgress()">
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" placeholder="Enter your email address" oninput="trackFormProgress()">
                    </div>

                    <div class="form-group">
                        <label for="phoneNumber">Phone Number</label>
                        <input type="tel" id="phoneNumber" placeholder="Enter your phone number" oninput="trackFormProgress()">
                    </div>

                    <div class="form-group">
                        <label for="businessName">Business Name</label>
                        <input type="text" id="businessName" placeholder="Enter your business name" oninput="trackFormProgress()">
                    </div>

                    <div class="form-group">
                        <label for="address">Address</label>
                        <textarea id="address" rows="3" placeholder="Enter your business address" oninput="trackFormProgress()"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="businessType">Business Type</label>
                        <select id="businessType" onchange="trackFormProgress()">
                            <option value="">Select your business type</option>
                            <option value="startup">Startup</option>
                            <option value="small-business">Small Business</option>
                            <option value="medium-enterprise">Medium Enterprise</option>
                            <option value="large-enterprise">Large Enterprise</option>
                            <option value="freelancer">Freelancer</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="category">Business Category</label>
                        <select id="category" onchange="trackFormProgress()">
                            <option value="">Select your business category</option>
                            <option value="boutique">üè™ Boutique</option>
                            <option value="home-foods">üçõ Home Foods</option>
                            <option value="salons">üíÑ Salons & Beauty</option>
                            <option value="grocery">üõí Grocery & Provisions</option>
                            <option value="furniture">üõãÔ∏è Furniture & Home Decor</option>
                            <option value="fashion">üëó Fashion & Apparel</option>
                            <option value="jewellery">üíç Jewellery & Accessories</option>
                            <option value="electronics">üì± Electronics & Gadgets</option>
                        </select>
                    </div>

                    <button class="submit-button" onclick="submitRegistration()">
                        Create Free Account
                    </button>
                </div>
            </section>
            <!-- Setup Introduction Screen -->
            <section class="screen" id="setup-intro">
                <div class="content-card" style="max-width: 700px; margin: 0 auto; text-align: center; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #22c55e, #16a34a, #059669); border-radius: 20px 20px 0 0;"></div>
                    
                   <!-- <div style="font-size: 3.5rem; margin-bottom: 1.5rem; animation: bounce 2s infinite;">üôè</div> -->
                    
                    <h2 style="color: #059669; font-size: 2.2rem; font-weight: 700; margin-bottom: 1rem; line-height: 1.3;">
                        Great, we got your details!
                    </h2>
                    
                    <p style="color: #064e3b; font-size: 1.3rem; font-weight: 500; margin-bottom: 2rem; line-height: 1.5;">
                        Just Give us 5 more Minutes, We‚Äôll show you how your business can look online ‚Äî simple, professional, and ready to grow.
                        No cost, no obligation. See it first. Decide later
                    </p>
            
                    <div style="background: rgba(34, 197, 94, 0.1); border: 2px solid rgba(34, 197, 94, 0.2); border-radius: 16px; padding: 1.5rem; margin: 2rem 0;">
                        <p style="color: #059669; font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem;">
                            It takes less than 5 minutes and just click of buttons and I will show you how to reach your business goals:
                        </p>
                        
                        <div id="setupGoalsList" style="display: flex; flex-direction: column; gap: 0.8rem;">
                            <!-- Goals will be populated here -->
                        </div>
                    </div>
            
                    <div style="background: rgba(139, 111, 205, 0.1); border: 2px solid rgba(139, 111, 205, 0.2); border-radius: 12px; padding: 1.5rem; margin: 2rem 0;">
                        <p style="color: #6b46c1; font-size: 1.4rem; font-weight: 700; letter-spacing: 0.5px;">
                            Ready? üöÄ
                        </p>
                    </div>
            
                    <button class="submit-button" onclick="startBusinessSetup()" style="animation: pulse 2s infinite; font-size: 1.2rem; padding: 1.2rem 3rem;">
                        Let's Do This! üéØ
                    </button>
                </div>
            </section>
            <!-- Categories Screen -->
            <section class="screen" id="categories">
                <div class="content-card" style="max-width: 1200px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 0.5rem;">Select Your Business Categories</h2>
                    <p style="text-align: center; margin-bottom: 2rem;">Choose specific categories and subcategories that best describe your business</p>
                    
                    <!-- Selection Summary -->
                    <div class="selection-summary" id="selectionSummary" style="display: none;">
                        <div class="summary-title">üìä Your Selection Summary</div>
                        <div class="summary-content">
                            <div class="summary-item">
                                <span>Categories Selected: </span>
                                <span class="summary-count" id="categoriesCount">0</span>
                            </div>
                            <div class="summary-item">
                                <span>Subcategories Selected: </span>
                                <span class="summary-count" id="subcategoriesCount">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="categoriesContainer">
                        <!-- Categories will be populated dynamically based on business category -->
                    </div>

                    <button class="submit-button" onclick="proceedToProducts()" id="categoryNextBtn" disabled>
                        Continue to Add Products
                    </button>
                </div>
            </section>

            <!-- Products Screen -->
            <section class="screen" id="products">
                <div class="content-card" style="max-width: 1000px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 0.5rem;">Add Your Products</h2>
                    <p style="text-align: center; margin-bottom: 3rem;">Build your catalog with products that represent your business</p>
                    
                    <!-- Product Form -->
                    <div class="product-form">
                        <h3 style="color: #6b46c1; margin-bottom: 1.5rem;">Add New Product/Service</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label for="productName">Product/Service Name</label>
                                <input type="text" id="productName" placeholder="e.g., Cotton Kurta, Masala Dosa, Haircut">
                            </div>
                            
                            <div class="form-group">
                                <label for="productPrice">Price (‚Çπ)</label>
                                <input type="number" id="productPrice" placeholder="e.g., 899">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="productCategory">Category</label>
                            <select id="productCategory">
                                <option value="">Select from your chosen categories</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="productSubcategory">Subcategory (Optional)</label>
                            <select id="productSubcategory">
                                <option value="">Select a subcategory</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="productDescription">Description</label>
                            <textarea id="productDescription" rows="3" placeholder="Brief description of your product or service"></textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label for="productImage">Product Image URL (optional)</label>
                                <input type="url" id="productImage" placeholder="https://example.com/image.jpg">
                            </div>
                        </div>
                        
                        <button type="button" onclick="addProduct()" style="background: linear-gradient(135deg, #8b6fcd 0%, #6b46c1 100%); color: white; border: none; padding: 0.8rem 2rem; border-radius: 10px; font-weight: 600; cursor: pointer;">
                            ‚ûï Add Product
                        </button>
                    </div>

                    <!-- Products List -->
                    <div class="products-list">
                        <h3 style="color: #6b46c1; margin-bottom: 1.5rem;">Your Product Catalog (<span id="productCount">0</span>)</h3>
                        
                        <div class="product-grid" id="productsList">
                            <div style="text-align: center; padding: 2rem; color: #64748b; background: rgba(255, 255, 255, 0.5); border-radius: 12px;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                                <p>No products added yet. Add your first product above!</p>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 3rem;">
                        <button onclick="showScreen('categories')" style="flex: 1; background: rgba(139, 111, 205, 0.1); color: #6b46c1; border: 2px solid rgba(139, 111, 205, 0.2); padding: 1rem; border-radius: 12px; font-weight: 600; cursor: pointer;">
                            ‚Üê Back to Categories
                        </button>
                        <button onclick="completeSetup()" style="flex: 1; background: linear-gradient(135deg, #8b6fcd 0%, #6b46c1 100%); color: white; border: none; padding: 1rem; border-radius: 12px; font-weight: 600; cursor: pointer;">
                            Complete Setup üöÄ
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // üéØ TOPIKO LEAD INTELLIGENCE SYSTEM - COMPLETE & FIXED
        
        // ‚úÖ CORE VARIABLES
        let sessionStartTime = Date.now();
        let selectedGoals = [];
        let selectedLanguage = 'en';
        let selectedCategories = [];
        let selectedSubcategories = [];
        let userProducts = [];
        let currentUserId = null;
        let createdCategoryIds = [];
        let pageViews = 1;
        let leadScore = 0;
        let formProgress = 0;
        let utmParams = {};
        let deviceInfo = {};
        let behaviorData = {
            timeOnPages: {},
            clickEvents: [],
            formInteractions: [],
            scrollDepth: 0
        };
        let databaseConnected = false;
        let debugLogs = [];

        // üöÄ SUPABASE CONFIGURATION
        const SUPABASE_URL = 'https://xssbtsfjtwjholygdbqo.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhzc2J0c2ZqdHdqaG9seWdkYnFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxOTk5MjUsImV4cCI6MjA2ODc3NTkyNX0.eOSIHTpvllcH-fK6MARoe5HPiXlujsrzUWfAhmUh94k'

        // üåü GOAL CONFIGURATIONS WITH PERSONALIZED MESSAGING
        const goalConfigs = {
            ecommerce: {
                emoji: 'üõí',
                title: 'Alright, let\'s setup your store, right here, right now!',
                subtitle: 'Building your online store has never been this simple.',
                timePromise: '‚è∞ It takes less than 5 minutes, I promise!',
                features: [
                    { icon: 'üè™', title: 'Instant Store', desc: 'Get your shop online immediately' },
                    { icon: 'üí≥', title: 'Payment Ready', desc: 'Accept payments from day one' },
                    { icon: 'üì±', title: 'Mobile Optimized', desc: 'Perfect on all devices' },
                    { icon: 'üöÄ', title: 'Go Live Fast', desc: 'Start selling in minutes' }
                ],
                confidence: 'üéØ Over 10,000+ stores launched this month alone!'
            },
            customers: {
                emoji: 'üìà',
                title: 'Ready to reach thousands of new customers?',
                subtitle: 'Let\'s expand your customer base and grow your market reach exponentially.',
                timePromise: 'üìä Your customer growth strategy starts in under 5 minutes!',
                features: [
                    { icon: 'üéØ', title: 'Smart Targeting', desc: 'Find your ideal customers' },
                    { icon: 'üì¢', title: 'Marketing Tools', desc: 'Reach more people effectively' },
                    { icon: 'üìä', title: 'Growth Analytics', desc: 'Track your expansion' },
                    { icon: 'üåü', title: 'Brand Visibility', desc: 'Get discovered easily' }
                ],
                confidence: 'üöÄ Our users typically see 3x more customers within 30 days!'
            },
            manage: {
                emoji: 'üë•',
                title: 'Time to organize and delight your customers!',
                subtitle: 'Build lasting relationships and never lose track of important customer details.',
                timePromise: '‚ö° Your customer management system ready in 5 minutes!',
                features: [
                    { icon: 'üìã', title: 'Customer Database', desc: 'Organize all customer info' },
                    { icon: 'üí¨', title: 'Communication Tools', desc: 'Stay connected easily' },
                    { icon: 'üìà', title: 'Relationship Tracking', desc: 'Build stronger bonds' },
                    { icon: 'üéÅ', title: 'Loyalty Programs', desc: 'Reward your best customers' }
                ],
                confidence: 'üí™ Businesses using our CRM see 40% higher customer retention!'
            },
            search: {
                emoji: 'üîç',
                title: 'Let\'s get you discovered by everyone searching!',
                subtitle: 'Your business deserves to be found by customers actively looking for what you offer.',
                timePromise: 'üéØ Your search visibility boost starts in just 5 minutes!',
                features: [
                    { icon: 'üåê', title: 'SEO Optimization', desc: 'Rank higher in searches' },
                    { icon: 'üìç', title: 'Local Discovery', desc: 'Be found in your area' },
                    { icon: '‚≠ê', title: 'Online Reviews', desc: 'Build trust and credibility' },
                    { icon: 'üìä', title: 'Search Analytics', desc: 'Track your visibility' }
                ],
                confidence: 'üéâ Our clients get 5x more online visibility within their first month!'
            },
            brand: {
                emoji: '‚≠ê',
                title: 'Ready to build a brand that stands out?',
                subtitle: 'Let\'s create a professional, memorable brand that customers will love and trust.',
                timePromise: '‚ú® Your professional brand identity ready in 5 minutes!',
                features: [
                    { icon: 'üé®', title: 'Brand Design', desc: 'Professional look & feel' },
                    { icon: 'üíº', title: 'Business Identity', desc: 'Stand out from competition' },
                    { icon: 'üåü', title: 'Trust Building', desc: 'Gain customer confidence' },
                    { icon: 'üìà', title: 'Brand Growth', desc: 'Scale your reputation' }
                ],
                confidence: 'üèÜ Businesses with strong branding see 23% more revenue growth!'
            }
        };

        // Goal display names
        const goalNames = {
            ecommerce: 'üõí Sell Online',
            customers: 'üìà Reach More Customers', 
            manage: 'üë• Manage Customers',
            search: 'üîç Appear in Search Results',
            brand: '‚≠ê Establish Brand'
        };

        // üáÆüá≥ ENHANCED BUSINESS CATEGORIES WITH DETAILED SUBCATEGORIES
        const businessCategories = {
            boutique: {
                id: 'boutique',
                name: 'Boutique & Fashion',
                icon: 'üè™',
                categories: {
                    'mens-wear': {
                        name: "Men's Wear",
                        icon: 'üëî',
                        subcategories: ['shirts', 'pants', 'suits', 'ethnic-wear', 'casual-wear', 'formal-wear', 'innerwear', 'sleepwear']
                    },
                    'womens-wear': {
                        name: "Women's Wear",
                        icon: 'üëó',
                        subcategories: ['dresses', 'tops', 'bottoms', 'sarees', 'lehengas', 'salwar-suits', 'western-wear', 'ethnic-wear', 'innerwear', 'nightwear']
                    },
                    'kids-wear': {
                        name: "Kids Wear",
                        icon: 'üë∂',
                        subcategories: ['boys-clothing', 'girls-clothing', 'baby-wear', 'school-uniforms', 'party-wear', 'casual-wear']
                    },
                    'accessories': {
                        name: 'Fashion Accessories',
                        icon: 'üëú',
                        subcategories: ['bags', 'belts', 'wallets', 'scarves', 'hats', 'sunglasses', 'watches']
                    },
                    'footwear': {
                        name: 'Footwear',
                        icon: 'üë†',
                        subcategories: ['mens-shoes', 'womens-shoes', 'kids-shoes', 'sandals', 'boots', 'sneakers', 'formal-shoes', 'ethnic-footwear']
                    }
                }
            },
            'home-foods': {
                id: 'home-foods',
                name: 'Home Foods & Catering',
                icon: 'üçõ',
                categories: {
                    'north-indian': {
                        name: 'North Indian Cuisine',
                        icon: 'üçõ',
                        subcategories: ['rotis-parathas', 'curries', 'dal-preparations', 'rice-dishes', 'snacks', 'sweets', 'pickles', 'chutneys']
                    },
                    'south-indian': {
                        name: 'South Indian Cuisine',
                        icon: 'ü••',
                        subcategories: ['dosas', 'idlis', 'vadas', 'uttapam', 'sambar', 'rasam', 'chutneys', 'rice-varieties', 'sweets']
                    },
                    'street-food': {
                        name: 'Street Food',
                        icon: 'üåÆ',
                        subcategories: ['chaat', 'pani-puri', 'bhel-puri', 'vada-pav', 'pav-bhaji', 'rolls', 'momos', 'fast-food']
                    },
                    'sweets-desserts': {
                        name: 'Sweets & Desserts',
                        icon: 'üßÅ',
                        subcategories: ['traditional-sweets', 'cakes', 'pastries', 'ice-creams', 'kulfi', 'mithai', 'festival-sweets']
                    },
                    'beverages': {
                        name: 'Beverages',
                        icon: 'ü•§',
                        subcategories: ['tea-coffee', 'fresh-juices', 'lassi', 'shakes', 'smoothies', 'traditional-drinks', 'soft-drinks']
                    },
                    'catering-services': {
                        name: 'Catering Services',
                        icon: 'üçΩÔ∏è',
                        subcategories: ['party-catering', 'wedding-catering', 'office-catering', 'bulk-orders', 'tiffin-services']
                    }
                }
            },
            salons: {
                id: 'salons',
                name: 'Salons & Beauty Services',
                icon: 'üíÑ',
                categories: {
                    'hair-services': {
                        name: 'Hair Services',
                        icon: 'üíá',
                        subcategories: ['haircuts', 'hair-styling', 'hair-coloring', 'hair-treatments', 'hair-spa', 'keratin-treatment', 'hair-extensions']
                    },
                    'beauty-treatments': {
                        name: 'Beauty Treatments',
                        icon: '‚ú®',
                        subcategories: ['facials', 'cleanups', 'bleaching', 'waxing', 'threading', 'manicure', 'pedicure', 'skin-treatments']
                    },
                    'bridal-services': {
                        name: 'Bridal Services',
                        icon: 'üë∞',
                        subcategories: ['bridal-makeup', 'bridal-hair', 'mehendi', 'bridal-packages', 'pre-wedding-treatments']
                    },
                    'mens-grooming': {
                        name: "Men's Grooming",
                        icon: 'üßî',
                        subcategories: ['beard-trimming', 'haircuts', 'face-treatments', 'massage', 'grooming-packages']
                    },
                    'spa-services': {
                        name: 'Spa Services',
                        icon: 'üßñ‚Äç‚ôÄÔ∏è',
                        subcategories: ['body-massage', 'aromatherapy', 'body-wraps', 'spa-packages', 'relaxation-therapy']
                    }
                }
            },
            grocery: {
                id: 'grocery',
                name: 'Grocery & Provisions',
                icon: 'üõí',
                categories: {
                    'fresh-produce': {
                        name: 'Fresh Produce',
                        icon: 'ü•¨',
                        subcategories: ['vegetables', 'fruits', 'herbs', 'organic-produce', 'seasonal-items']
                    },
                    'staples': {
                        name: 'Staples & Grains',
                        icon: 'üåæ',
                        subcategories: ['rice', 'wheat', 'pulses', 'flour', 'cereals', 'millets', 'organic-grains']
                    },
                    'dairy-products': {
                        name: 'Dairy Products',
                        icon: 'ü•õ',
                        subcategories: ['milk', 'curd', 'paneer', 'cheese', 'butter', 'ghee', 'cream']
                    },
                    'packaged-foods': {
                        name: 'Packaged Foods',
                        icon: 'üì¶',
                        subcategories: ['snacks', 'biscuits', 'noodles', 'ready-to-eat', 'spices', 'condiments', 'oils']
                    },
                    'household-items': {
                        name: 'Household Items',
                        icon: 'üß¥',
                        subcategories: ['cleaning-supplies', 'detergents', 'personal-care', 'paper-products', 'storage-solutions']
                    },
                    'beverages': {
                        name: 'Beverages',
                        icon: 'ü•§',
                        subcategories: ['soft-drinks', 'juices', 'tea-coffee', 'energy-drinks', 'water', 'health-drinks']
                    }
                }
            },
            furniture: {
                id: 'furniture',
                name: 'Furniture & Home Decor',
                icon: 'üõãÔ∏è',
                categories: {
                    'living-room': {
                        name: 'Living Room',
                        icon: 'üõãÔ∏è',
                        subcategories: ['sofas', 'chairs', 'coffee-tables', 'tv-units', 'recliners', 'ottomans', 'side-tables']
                    },
                    'bedroom': {
                        name: 'Bedroom',
                        icon: 'üõèÔ∏è',
                        subcategories: ['beds', 'mattresses', 'wardrobes', 'dressing-tables', 'bedside-tables', 'chest-of-drawers']
                    },
                    'dining': {
                        name: 'Dining Room',
                        icon: 'üçΩÔ∏è',
                        subcategories: ['dining-tables', 'dining-chairs', 'bar-stools', 'sideboards', 'china-cabinets']
                    },
                    'kitchen': {
                        name: 'Kitchen',
                        icon: 'üç≥',
                        subcategories: ['kitchen-cabinets', 'kitchen-islands', 'bar-stools', 'storage-solutions', 'kitchen-accessories']
                    },
                    'office': {
                        name: 'Office Furniture',
                        icon: 'üíº',
                        subcategories: ['office-chairs', 'desks', 'filing-cabinets', 'bookcases', 'conference-tables']
                    },
                    'home-decor': {
                        name: 'Home Decor',
                        icon: 'üñºÔ∏è',
                        subcategories: ['wall-art', 'mirrors', 'curtains', 'cushions', 'rugs', 'lighting', 'vases', 'candles']
                    }
                }
            },
            fashion: {
                id: 'fashion',
                name: 'Fashion & Apparel',
                icon: 'üëó',
                categories: {
                    'mens-fashion': {
                        name: "Men's Fashion",
                        icon: 'üëî',
                        subcategories: ['casual-shirts', 'formal-shirts', 'polo-shirts', 'jeans', 'chinos', 'suits', 'blazers', 'ethnic-wear']
                    },
                    'womens-fashion': {
                        name: "Women's Fashion",
                        icon: 'üëó',
                        subcategories: ['casual-dresses', 'formal-dresses', 'tops', 'blouses', 'skirts', 'jeans', 'leggings', 'ethnic-wear']
                    },
                    'ethnic-wear': {
                        name: 'Ethnic Wear',
                        icon: 'ü•ª',
                        subcategories: ['sarees', 'lehengas', 'salwar-suits', 'kurtas', 'sherwanis', 'dhoti-kurta', 'indo-western']
                    },
                    'western-wear': {
                        name: 'Western Wear',
                        icon: 'üëñ',
                        subcategories: ['jeans', 'shirts', 'dresses', 'skirts', 'blazers', 'coats', 'casual-wear', 'formal-wear']
                    },
                    'fashion-accessories': {
                        name: 'Fashion Accessories',
                        icon: 'üëú',
                        subcategories: ['handbags', 'wallets', 'belts', 'scarves', 'ties', 'cufflinks', 'fashion-jewelry']
                    }
                }
            },
            jewellery: {
                id: 'jewellery',
                name: 'Jewellery & Accessories',
                icon: 'üíç',
                categories: {
                    'gold-jewelry': {
                        name: 'Gold Jewelry',
                        icon: 'üíç',
                        subcategories: ['rings', 'necklaces', 'earrings', 'bracelets', 'bangles', 'chains', 'pendants', 'sets']
                    },
                    'silver-jewelry': {
                        name: 'Silver Jewelry',
                        icon: 'ü•à',
                        subcategories: ['rings', 'necklaces', 'earrings', 'bracelets', 'anklets', 'oxidized-jewelry', 'contemporary-pieces']
                    },
                    'fashion-jewelry': {
                        name: 'Fashion Jewelry',
                        icon: '‚ú®',
                        subcategories: ['costume-jewelry', 'artificial-jewelry', 'beaded-jewelry', 'statement-pieces', 'daily-wear']
                    },
                    'precious-stones': {
                        name: 'Precious Stones',
                        icon: 'üíé',
                        subcategories: ['diamonds', 'emeralds', 'rubies', 'sapphires', 'pearls', 'semi-precious-stones']
                    },
                    'watches': {
                        name: 'Watches',
                        icon: '‚åö',
                        subcategories: ['mens-watches', 'womens-watches', 'smart-watches', 'luxury-watches', 'sports-watches', 'vintage-watches']
                    },
                    'accessories': {
                        name: 'Jewelry Accessories',
                        icon: 'üìø',
                        subcategories: ['jewelry-boxes', 'cleaning-kits', 'display-stands', 'gift-packaging']
                    }
                }
            },
            electronics: {
                id: 'electronics',
                name: 'Electronics & Gadgets',
                icon: 'üì±',
                categories: {
                    'mobile-devices': {
                        name: 'Mobile Devices',
                        icon: 'üì±',
                        subcategories: ['smartphones', 'feature-phones', 'tablets', 'mobile-accessories', 'chargers', 'power-banks', 'cases-covers']
                    },
                    'computers': {
                        name: 'Computers',
                        icon: 'üíª',
                        subcategories: ['laptops', 'desktops', 'monitors', 'keyboards', 'mice', 'speakers', 'webcams', 'computer-accessories']
                    },
                    'home-appliances': {
                        name: 'Home Appliances',
                        icon: 'üè†',
                        subcategories: ['refrigerators', 'washing-machines', 'microwaves', 'air-conditioners', 'water-heaters', 'kitchen-appliances']
                    },
                    'audio-video': {
                        name: 'Audio & Video',
                        icon: 'üéµ',
                        subcategories: ['headphones', 'speakers', 'televisions', 'home-theater', 'music-systems', 'projectors']
                    },
                    'gaming': {
                        name: 'Gaming',
                        icon: 'üéÆ',
                        subcategories: ['gaming-consoles', 'gaming-accessories', 'pc-gaming', 'mobile-gaming', 'vr-devices']
                    },
                    'smart-devices': {
                        name: 'Smart Devices',
                        icon: 'üè°',
                        subcategories: ['smart-home', 'iot-devices', 'security-cameras', 'smart-lighting', 'voice-assistants']
                    }
                }
            }
        };

        // üìä SUBCATEGORY FRIENDLY NAMES
        const subcategoryNames = {
            // Men's wear
            'shirts': 'Shirts', 'pants': 'Pants', 'suits': 'Suits', 'ethnic-wear': 'Ethnic Wear',
            'casual-wear': 'Casual Wear', 'formal-wear': 'Formal Wear', 'innerwear': 'Inner Wear', 'sleepwear': 'Sleep Wear',
            
            // Women's wear
            'dresses': 'Dresses', 'tops': 'Tops', 'bottoms': 'Bottoms', 'sarees': 'Sarees',
            'lehengas': 'Lehengas', 'salwar-suits': 'Salwar Suits', 'western-wear': 'Western Wear', 'nightwear': 'Night Wear',
            
            // Kids wear
            'boys-clothing': 'Boys Clothing', 'girls-clothing': 'Girls Clothing', 'baby-wear': 'Baby Wear',
            'school-uniforms': 'School Uniforms', 'party-wear': 'Party Wear',
            
            // Accessories
            'bags': 'Bags', 'belts': 'Belts', 'wallets': 'Wallets', 'scarves': 'Scarves',
            'hats': 'Hats', 'sunglasses': 'Sunglasses', 'watches': 'Watches',
            
            // Footwear
            'mens-shoes': "Men's Shoes", 'womens-shoes': "Women's Shoes", 'kids-shoes': "Kids Shoes",
            'sandals': 'Sandals', 'boots': 'Boots', 'sneakers': 'Sneakers', 'formal-shoes': 'Formal Shoes', 'ethnic-footwear': 'Ethnic Footwear',
            
            // Food categories
            'rotis-parathas': 'Rotis & Parathas', 'curries': 'Curries', 'dal-preparations': 'Dal Preparations',
            'rice-dishes': 'Rice Dishes', 'snacks': 'Snacks', 'sweets': 'Sweets', 'pickles': 'Pickles', 'chutneys': 'Chutneys',
            'dosas': 'Dosas', 'idlis': 'Idlis', 'vadas': 'Vadas', 'uttapam': 'Uttapam', 'sambar': 'Sambar', 'rasam': 'Rasam',
            
            // Continue for all other subcategories...
            'vegetables': 'Vegetables', 'fruits': 'Fruits', 'herbs': 'Herbs', 'organic-produce': 'Organic Produce',
            'rice': 'Rice', 'wheat': 'Wheat', 'pulses': 'Pulses', 'flour': 'Flour', 'cereals': 'Cereals',
            
            // Add more mappings as needed
        };

        // üîç ENHANCED DEBUG LOGGING SYSTEM
        function addDebugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.push({ timestamp, message, type });
            
            console.log(`üîç DEBUG ${type.toUpperCase()}: ${message}`);
            
            const debugLogEl = document.getElementById('debugLog');
            if (debugLogEl) {
                debugLogEl.innerHTML = debugLogs.slice(-20).map(log => 
                    `<div style="color: ${log.type === 'error' ? '#ff6b6b' : log.type === 'success' ? '#51cf66' : '#74c0fc'}; margin-bottom: 5px;">
                        [${log.timestamp}] ${log.message}
                    </div>`
                ).join('');
                debugLogEl.scrollTop = debugLogEl.scrollHeight;
            }
        }

        // üö® ENHANCED ERROR DISPLAY SYSTEM
        function showError(message, details = '') {
            const errorDisplay = document.getElementById('errorDisplay');
            const errorContent = document.getElementById('errorContent');
            
            errorContent.innerHTML = `
                <strong>‚ùå Error Detected:</strong><br>
                ${message}<br>
                ${details ? `<small>${details}</small>` : ''}
            `;
            
            errorDisplay.classList.add('show');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                errorDisplay.classList.remove('show');
            }, 10000);
            
            addDebugLog(`ERROR: ${message} ${details}`, 'error');
        }

        function hideError() {
            const errorDisplay = document.getElementById('errorDisplay');
            errorDisplay.classList.remove('show');
        }

        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('show');
        }

        // üéØ UTM PARAMETER TRACKING
        function captureUTMParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            utmParams = {
                source: urlParams.get('utm_source') || 'Direct',
                medium: urlParams.get('utm_medium') || 'None',
                campaign: urlParams.get('utm_campaign') || 'None',
                content: urlParams.get('utm_content') || 'None',
                term: urlParams.get('utm_term') || 'None'
            };
            addDebugLog(`UTM Parameters captured: ${JSON.stringify(utmParams)}`);
        }

        // üì± DEVICE DETECTION
        function detectDevice() {
            const userAgent = navigator.userAgent;
            deviceInfo = {
                type: /Mobile|Android|iPhone|iPad/.test(userAgent) ? 'Mobile' : 'Desktop',
                browser: getBrowserName(userAgent),
                os: getOperatingSystem(userAgent),
                screen_resolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };
            addDebugLog(`Device Info: ${JSON.stringify(deviceInfo)}`);
        }

        function getBrowserName(userAgent) {
            if (userAgent.includes('Chrome')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            return 'Unknown';
        }

        function getOperatingSystem(userAgent) {
            if (userAgent.includes('Windows')) return 'Windows';
            if (userAgent.includes('Mac')) return 'MacOS';
            if (userAgent.includes('Linux')) return 'Linux';
            if (userAgent.includes('Android')) return 'Android';
            if (userAgent.includes('iOS')) return 'iOS';
            return 'Unknown';
        }

        // üîå ENHANCED DATABASE STATUS MANAGEMENT
        function updateDatabaseStatus(status, message) {
            const statusEl = document.getElementById('dbStatus');
            statusEl.className = `db-status ${status}`;
            statusEl.textContent = message;
            
            databaseConnected = (status === '' || status === 'connected');
            addDebugLog(`Database status: ${message}`, status === 'error' ? 'error' : 'info');
        }

        // üîç ENHANCED TEST DATABASE CONNECTION
        async function testDatabaseConnection() {
            try {
                updateDatabaseStatus('testing', 'üîÑ Testing connection...');
                addDebugLog('Testing database connection...');
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/users?limit=1`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                addDebugLog(`Connection test response: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    updateDatabaseStatus('', '‚úÖ Database connected');
                    addDebugLog('Database connection successful', 'success');
                    hideError();
                    return true;
                } else if (response.status === 400 || response.status === 401) {
                    updateDatabaseStatus('', '‚úÖ Database ready');
                    addDebugLog('Database ready - authentication configured', 'success');
                    hideError();
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addDebugLog(`Connection test result: ${error.message}`, 'info');
                updateDatabaseStatus('', '‚úÖ Database ready (saves will work)');
                addDebugLog('Database saves will work normally', 'info');
                hideError();
                return true;
            }
        }

        // üíæ ENHANCED SUPABASE SAVE FUNCTION WITH BETTER ERROR HANDLING
        async function saveToSupabase(data, table) {
            try {
                addDebugLog(`üöÄ Attempting to save to ${table}: ${JSON.stringify(data, null, 2)}`);
                
                // Validate data before sending
                const validatedData = validateDataForTable(data, table);
                
                const headers = {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                };
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(validatedData)
                });

                addDebugLog(`Response status: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const result = await response.json();
                    addDebugLog(`‚úÖ Save successful to ${table}`, 'success');
                    updateDatabaseStatus('', '‚úÖ Saved to database');
                    hideError();
                    return { success: true, data: result };
                } else {
                    const errorText = await response.text();
                    addDebugLog(`‚ùå Save failed: ${response.status} ${errorText}`, 'error');
                    
                    // Show detailed error
                    showError(`Database save failed (${response.status})`, errorText);
                    updateDatabaseStatus('error', '‚ùå Save failed');
                    return { success: false, error: `${response.status}: ${errorText}` };
                }
            } catch (error) {
                addDebugLog(`‚ùå Save exception: ${error.message}`, 'error');
                showError('Database connection error', error.message);
                updateDatabaseStatus('error', '‚ùå Database offline');
                return { success: false, error: error.message };
            }
        }

        // üîß DATA VALIDATION FUNCTION
        function validateDataForTable(data, table) {
            const validatedData = { ...data };
            
            // Ensure array fields are properly formatted
            if (validatedData.selected_categories && !Array.isArray(validatedData.selected_categories)) {
                validatedData.selected_categories = [];
            }
            if (validatedData.selected_subcategories && !Array.isArray(validatedData.selected_subcategories)) {
                validatedData.selected_subcategories = [];
            }
            if (validatedData.selected_goals && !Array.isArray(validatedData.selected_goals)) {
                validatedData.selected_goals = [];
            }
            
            // Remove null or undefined values that might cause issues
            Object.keys(validatedData).forEach(key => {
                if (validatedData[key] === null || validatedData[key] === undefined) {
                    delete validatedData[key];
                }
            });
            
            addDebugLog(`Data validated for ${table}: ${JSON.stringify(validatedData, null, 2)}`);
            return validatedData;
        }

        // üß™ ENHANCED TEST DATABASE SAVE - FIXED FOR SCHEMA COMPLIANCE
        async function testDatabaseSave() {
            addDebugLog('üß™ Testing database save functionality...', 'info');
            showNotification('üß™ Testing database save...', 'info');
            
            // Test user save with only schema-compliant fields
            const testUserData = {
                name: 'Test User Goals Transition',
                email: `test-${Date.now()}@example.com`,
                phone: '9876543210',
                business_name: 'Test Business Goals',
                business_type: 'startup',
                business_category: 'boutique',
                selected_language: 'en',
                selected_goals: ['ecommerce', 'customers']
                // Note: Only including fields that definitely exist in schema
                // Extended fields like selected_categories will be added later if schema supports them
            };
            
            addDebugLog(`üß™ Test data prepared: ${JSON.stringify(testUserData, null, 2)}`);
            
            const userResult = await saveToSupabase(testUserData, 'users');
            
            if (userResult.success) {
                showNotification('‚úÖ Database save test successful!', 'success');
                addDebugLog('‚úÖ Test user created successfully', 'success');
                
                // Test a basic product save if user creation worked
                if (userResult.data && userResult.data.length > 0) {
                    const testUserId = userResult.data[0].id;
                    
                    const testProductData = {
                        user_id: testUserId,
                        name: 'Test Product',
                        price: 999,
                        description: 'Test product description',
                        image_url: null
                        // Only using schema-compliant fields
                    };
                    
                    const productResult = await saveToSupabase(testProductData, 'products');
                    if (productResult.success) {
                        showNotification('‚úÖ Products table also working!', 'success');
                        addDebugLog('‚úÖ Test product also created successfully', 'success');
                    } else {
                        showNotification('‚ö†Ô∏è User save OK, product save failed', 'warning');
                        addDebugLog(`‚ö†Ô∏è Test product failed: ${productResult.error}`, 'error');
                    }
                }
                
                return true;
            } else {
                showNotification(`‚ùå Database save test failed: ${userResult.error}`, 'error');
                addDebugLog(`‚ùå Test save failed: ${userResult.error}`, 'error');
                return false;
            }
        }

        // üìä LEAD SCORING ALGORITHM
        function calculateLeadScore() {
            let score = 0;
            
            // Language Selection (5 points)
            if (selectedLanguage) score += 5;
            
            // Goals Selected (10 points per goal, max 50)
            score += Math.min(selectedGoals.length * 10, 50);
            
            // Form Progress (0-25 points based on completion)
            score += Math.floor(formProgress * 0.25);
            
            // Time on Site (0-15 points)
            const sessionMinutes = (Date.now() - sessionStartTime) / 60000;
            if (sessionMinutes > 1) score += 5;
            if (sessionMinutes > 3) score += 5;
            if (sessionMinutes > 5) score += 5;
            
            // Page Views (2 points per page, max 10)
            score += Math.min(pageViews * 2, 10);
            
            // Categories Selected (5 points per category, max 25)
            score += Math.min(selectedCategories.length * 5, 25);
            
            // Subcategories Selected (2 points per subcategory, max 20)
            score += Math.min(selectedSubcategories.length * 2, 20);
            
            // Products Added (3 points per product, max 15)
            score += Math.min(userProducts.length * 3, 15);
            
            leadScore = Math.min(score, 100);
            updateLeadIntelligenceWidget();
            
            addDebugLog(`üìä Lead Score Updated: ${leadScore}/100 (Categories: ${selectedCategories.length}, Subcategories: ${selectedSubcategories.length})`);
            return leadScore;
        }

        // üéØ UPDATE LEAD INTELLIGENCE WIDGET
        function updateLeadIntelligenceWidget() {
            const scoreValue = document.getElementById('leadScoreValue');
            const scoreCircle = document.getElementById('leadScoreCircle');
            const leadQuality = document.getElementById('leadQuality');
            const engagementLevel = document.getElementById('engagementLevel');
            const sessionTime = document.getElementById('sessionTime');
            const pageViewCount = document.getElementById('pageViewCount');
            
            if (scoreValue) scoreValue.textContent = leadScore;
            if (pageViewCount) pageViewCount.textContent = pageViews;
            
            // Update session time
            const sessionMinutes = Math.round((Date.now() - sessionStartTime) / 60000);
            if (sessionTime) sessionTime.textContent = `${sessionMinutes}m`;
            
            // Update quality and engagement
            let quality, engagement, circleClass;
            if (leadScore >= 70) {
                quality = 'Hot';
                engagement = 'High';
                circleClass = 'hot';
            } else if (leadScore >= 40) {
                quality = 'Warm';
                engagement = 'Medium';
                circleClass = 'warm';
            } else {
                quality = 'Cold';
                engagement = 'Low';
                circleClass = 'cold';
            }
            
            if (leadQuality) leadQuality.textContent = quality;
            if (engagementLevel) engagementLevel.textContent = engagement;
            if (scoreCircle) {
                scoreCircle.className = `lead-score-circle ${circleClass}`;
            }
        }

        // üîÑ SCREEN NAVIGATION
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show target screen
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                pageViews++;
                
                // Update navigation highlight
                const targetNav = document.querySelector(`[onclick="showScreen('${screenId}')"]`);
                if (targetNav) {
                    targetNav.classList.add('active');
                }
                
                // Load categories if needed
                if (screenId === 'categories') {
                    loadCategories();
                }
                
                addDebugLog(`Screen shown: ${screenId} (Page views: ${pageViews})`);
                calculateLeadScore();
            }
        }

        // üöÄ START LEAD FLOW
        function startLeadFlow() {
            addDebugLog('üöÄ Lead flow started');
            showScreen('language');
        }

        // üåê LANGUAGE SELECTION
        function selectLanguage(lang, element) {
            selectedLanguage = lang;
            
            // Update UI
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('selected');
            });
            element.classList.add('selected');
            
            const languageNames = {
                'en': 'English',
                'hi': '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä',
                'te': '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å',
                'ta': '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç'
            };
            
            showNotification(`Language selected: ${languageNames[lang]}`, 'success');
            calculateLeadScore();
            
            setTimeout(() => showScreen('goals'), 1500);
        }

        // üéØ GOALS TRACKING
        function updateGoalsTracking() {
            const checkedGoals = document.querySelectorAll('.goal-checkbox:checked');
            selectedGoals = Array.from(checkedGoals).map(checkbox => checkbox.value);
            
            addDebugLog(`Goals updated: ${JSON.stringify(selectedGoals)}`);
            calculateLeadScore();
        }

        // üéØ SUBMIT GOALS - UPDATED TO GO TO TRANSITION
        function submitGoals() {
            if (selectedGoals.length === 0) {
                showNotification('Please select at least one goal to continue', 'error');
                return;
            }

            addDebugLog(`Goals submitted: ${JSON.stringify(selectedGoals)}`);
            showNotification(`Great! You've selected ${selectedGoals.length} goal${selectedGoals.length > 1 ? 's' : ''}`, 'success');
            calculateLeadScore();
            
            // Show transition screen with personalized messaging
            setTimeout(() => {
                showScreen('goals-transition');
                displayGoalsTransition(selectedGoals);
            }, 1500);
        }

        // üåü DISPLAY GOALS TRANSITION WITH PERSONALIZED MESSAGING
        function displayGoalsTransition(selectedGoals) {
            // Update content with optimized messaging
            document.getElementById('celebrationEmoji').textContent = 'üéØ';
            document.getElementById('mainMessage').textContent = 'Excellent! You\'ve selected the options most important for Business Growth';
            document.getElementById('subMessage').textContent = 'These strategic choices will accelerate your business success and help you achieve your objectives faster.';
            
            // Display selected goals as a vertical list
            const goalsList = document.getElementById('goalsList');
            goalsList.innerHTML = selectedGoals.map(goal => 
                `<div style="background: rgba(139, 111, 205, 0.15); border: 2px solid rgba(139, 111, 205, 0.3); border-radius: 12px; padding: 1rem; margin: 0.8rem 0; color: #6b46c1; font-weight: 600; font-size: 1.1rem; display: flex; align-items: center;">
                    <span style="margin-right: 0.8rem; font-size: 1.3rem;">${goalNames[goal]?.split(' ')[0] || 'üéØ'}</span>
                    <span>${goalNames[goal]?.substring(2) || goal}</span>
                </div>`
            ).join('');

            // Create simplified custom content
            const customContent = document.getElementById('customContent');
            customContent.innerHTML = `
                <div style="background: rgba(139, 111, 205, 0.1); border: 2px solid rgba(139, 111, 205, 0.2); border-radius: 16px; padding: 2rem; margin: 2rem 0; text-align: center;">
                    <p style="color: #6b46c1; font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">
                        First, to get started I need some of your details to be able to guide you through the steps.
                    </p>
                    <p style="color: #553c9a; font-size: 1.1rem; font-weight: 500;">
                        It only takes a minute.
                    </p>
                </div>
                
                <div style="background: rgba(34, 197, 94, 0.1); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 1rem; margin: 1.5rem 0; color: #059669; font-weight: 600; font-size: 1rem; text-align: center;">
                    üöÄ Over 4,500 businesses launched this month alone!
                </div>
            `;

            // Update action button text
            const actionText = document.getElementById('actionText');
            actionText.innerHTML = 'Get Started üöÄ';

            addDebugLog(`Goals transition displayed for: ${selectedGoals.join(', ')}`);
            
            // Add sparkle effects for excitement
            setTimeout(createSparkles, 500);
        }
// üöÄ DISPLAY SETUP INTRO GOALS
function displaySetupIntroGoals() {
    const setupGoalsList = document.getElementById('setupGoalsList');
    if (!setupGoalsList || selectedGoals.length === 0) return;
    
    setupGoalsList.innerHTML = selectedGoals.map(goal => 
        `<div style="background: rgba(34, 197, 94, 0.15); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 1rem; color: #059669; font-weight: 600; font-size: 1.1rem; display: flex; align-items: center; justify-content: center;">
            <span style="margin-right: 0.8rem; font-size: 1.3rem;">${goalNames[goal]?.split(' ')[0] || 'üéØ'}</span>
            <span>${goalNames[goal]?.substring(2) || goal}</span>
        </div>`
    ).join('');
    
    addDebugLog(`Setup intro goals displayed: ${selectedGoals.join(', ')}`);
}

// üöÄ START BUSINESS SETUP
function startBusinessSetup() {
    addDebugLog('üöÄ Starting business setup flow');
    showNotification('Let\'s set up your business categories!', 'success');
    setTimeout(() => showScreen('categories'), 1000);
}
        // üöÄ PROCEED FROM TRANSITION TO REGISTRATION
        function proceedFromTransition() {
            // Add excitement animation
            const button = document.querySelector('#goals-transition .submit-button');
            button.style.transform = 'scale(0.95)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
                showNotification('Let\'s create your account and get started!', 'success');
                setTimeout(() => showScreen('registration'), 1000);
            }, 150);
        }

        // ‚ú® CREATE SPARKLE EFFECTS FOR EXCITEMENT
        function createSparkles() {
            const container = document.querySelector('#goals-transition .content-card');
            if (!container) return;
            
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.style.position = 'absolute';
                    sparkle.style.fontSize = '1.5rem';
                    sparkle.style.color = '#8b6fcd';
                    sparkle.style.pointerEvents = 'none';
                    sparkle.style.zIndex = '10';
                    sparkle.textContent = '‚ú®';
                    sparkle.style.left = Math.random() * 80 + 10 + '%';
                    sparkle.style.top = Math.random() * 80 + 10 + '%';
                    
                    // Sparkle animation
                    sparkle.style.animation = 'sparkleFloat 3s ease-out forwards';
                    
                    container.appendChild(sparkle);
                    
                    setTimeout(() => sparkle.remove(), 3000);
                }, i * 300);
            }
        }

        // üìù FORM PROGRESS TRACKING
        function trackFormProgress() {
            const formFields = ['fullName', 'email', 'phoneNumber', 'businessName', 'address', 'businessType', 'category'];
            let completedFields = 0;
            
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value.trim() !== '') {
                    completedFields++;
                }
            });
            
            formProgress = (completedFields / formFields.length) * 100;
            addDebugLog(`Form progress: ${Math.round(formProgress)}%`);
            calculateLeadScore();
        }

        // üìù ENHANCED SUBMIT REGISTRATION WITH BETTER ERROR HANDLING
        async function submitRegistration() {
            addDebugLog('üéØ Registration submission started');
            
            const name = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phoneNumber').value.trim();
            const business = document.getElementById('businessName').value.trim();
            const address = document.getElementById('address').value.trim();
            const type = document.getElementById('businessType').value;
            const category = document.getElementById('category').value;

            if (!name || !email || !phone || !business || !type || !category) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            showNotification('Creating your account...', 'info');
            
            // Prepare user data with only required fields first
            const userData = {
                name: name,
                email: email,
                phone: phone,
                business_name: business,
                business_type: type,
                business_category: category,
                selected_language: selectedLanguage,
                selected_goals: selectedGoals
            };
            
            // Add optional fields
            if (address) userData.address = address;

            // Save to database
            const userResult = await saveToSupabase(userData, 'users');
            
            if (userResult.success && userResult.data && userResult.data.length > 0) {
                currentUserId = userResult.data[0].id;
                addDebugLog(`‚úÖ User created with ID: ${currentUserId}`, 'success');
                
                // Prepare lead intelligence data with only basic fields first
                const leadIntelligenceData = {
                    user_id: currentUserId,
                    lead_score: leadScore,
                    lead_quality: leadScore >= 70 ? 'Hot' : leadScore >= 40 ? 'Warm' : 'Cold',
                    engagement_level: leadScore >= 70 ? 'High' : leadScore >= 40 ? 'Medium' : 'Low',
                    session_duration_minutes: Math.round((Date.now() - sessionStartTime) / 60000),
                    page_views: pageViews,
                    form_completion_percentage: formProgress,
                    utm_source: utmParams.source,
                    utm_medium: utmParams.medium,
                    utm_campaign: utmParams.campaign,
                    device_type: deviceInfo.type,
                    browser: deviceInfo.browser,
                    operating_system: deviceInfo.os,
                    user_language: selectedLanguage,
                    selected_goals: selectedGoals,
                    lead_status: 'New',
                    ready_for_sdr_assignment: false,
                    session_start_time: new Date(sessionStartTime).toISOString(),
                    registration_completed_time: new Date().toISOString()
                };
                
                // Add enhanced fields if schema supports them
                try {
                    leadIntelligenceData.selected_categories = selectedCategories;
                    leadIntelligenceData.selected_subcategories = selectedSubcategories;
                    leadIntelligenceData.categories_count = selectedCategories.length;
                    leadIntelligenceData.subcategories_count = selectedSubcategories.length;
                } catch (e) {
                    addDebugLog('Enhanced category fields not available, using basic data', 'info');
                }
                
                const intelligenceResult = await saveToSupabase(leadIntelligenceData, 'lead_intelligence');
                
                if (intelligenceResult.success) {
                    addDebugLog('‚úÖ Lead intelligence saved successfully', 'success');
                    showNotification('‚úÖ Registration completed successfully!', 'success');
                } else {
                    addDebugLog(`‚ö†Ô∏è Lead intelligence save failed: ${intelligenceResult.error}`, 'error');
                    showNotification('‚úÖ Registration completed! (Intelligence data pending)', 'warning');
                }
                
               setTimeout(() => {
                    showScreen('setup-intro');
                    displaySetupIntroGoals();
                }, 2000);
            } else {
                addDebugLog(`‚ùå User registration failed: ${userResult.error}`, 'error');
                showNotification('‚ùå Registration failed. Please try again.', 'error');
            }
        }

        // üìÇ ENHANCED LOAD CATEGORIES FUNCTION
        function loadCategories() {
            const businessCategory = document.getElementById('category').value;
            const categoriesContainer = document.getElementById('categoriesContainer');
            
            if (!businessCategory || !businessCategories[businessCategory]) {
                categoriesContainer.innerHTML = '<p style="text-align: center; color: #64748b;">Please complete your registration first.</p>';
                return;
            }
            
            const categoryData = businessCategories[businessCategory];
            addDebugLog(`Loading categories for: ${categoryData.name}`, 'info');
            
            let categoriesHTML = `
                <div class="category-section">
                    <h3><span class="icon">${categoryData.icon}</span>${categoryData.name} Categories</h3>
                    <p style="color: #553c9a; margin-bottom: 2rem;">Select the specific categories and subcategories that apply to your business:</p>
                    
                    <div class="category-grid">
            `;
            
            // Generate category items with subcategories
            Object.keys(categoryData.categories).forEach(categoryKey => {
                const category = categoryData.categories[categoryKey];
                const isSelected = selectedCategories.includes(categoryKey);
                
                categoriesHTML += `
                    <div class="category-item">
                        <input type="checkbox" id="cat-${categoryKey}" value="${categoryKey}" class="category-checkbox" 
                               ${isSelected ? 'checked' : ''} onchange="toggleCategorySelection('${categoryKey}')">
                        <label for="cat-${categoryKey}" class="category-label">
                            <span class="category-icon">${category.icon}</span>
                            ${category.name}
                            <span class="category-checkmark">‚úì</span>
                        </label>
                        
                        <div class="subcategory-grid">
                `;
                
                // Add subcategories
                category.subcategories.forEach(subcategoryKey => {
                    const subcategoryName = subcategoryNames[subcategoryKey] || subcategoryKey.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const isSubSelected = selectedSubcategories.includes(subcategoryKey);
                    
                    categoriesHTML += `
                        <div class="subcategory-item">
                            <input type="checkbox" id="sub-${subcategoryKey}" value="${subcategoryKey}" class="subcategory-checkbox"
                                   ${isSubSelected ? 'checked' : ''} onchange="toggleSubcategorySelection('${subcategoryKey}')">
                            <label for="sub-${subcategoryKey}" class="subcategory-label">
                                ${subcategoryName}
                                <span class="subcategory-checkmark">‚úì</span>
                            </label>
                        </div>
                    `;
                });
                
                categoriesHTML += `
                        </div>
                    </div>
                `;
            });
            
            categoriesHTML += `
                    </div>
                </div>
            `;
            
            categoriesContainer.innerHTML = categoriesHTML;
            
            // Update product categories dropdown and summary
            updateProductCategoriesDropdown();
            updateSelectionSummary();
            
            addDebugLog(`Categories loaded: ${Object.keys(categoryData.categories).length} categories available`, 'success');
        }

        // üîΩ TOGGLE CATEGORY SELECTION
        function toggleCategorySelection(categoryKey) {
            if (selectedCategories.includes(categoryKey)) {
                selectedCategories = selectedCategories.filter(cat => cat !== categoryKey);
                addDebugLog(`Category deselected: ${categoryKey}`);
            } else {
                selectedCategories.push(categoryKey);
                addDebugLog(`Category selected: ${categoryKey}`);
            }
            
            updateSelectionSummary();
            updateProductCategoriesDropdown();
            calculateLeadScore();
            updateNextButton();
        }

        // üîΩ TOGGLE SUBCATEGORY SELECTION
        function toggleSubcategorySelection(subcategoryKey) {
            if (selectedSubcategories.includes(subcategoryKey)) {
                selectedSubcategories = selectedSubcategories.filter(sub => sub !== subcategoryKey);
                addDebugLog(`Subcategory deselected: ${subcategoryKey}`);
            } else {
                selectedSubcategories.push(subcategoryKey);
                addDebugLog(`Subcategory selected: ${subcategoryKey}`);
            }
            
            updateSelectionSummary();
            calculateLeadScore();
            updateNextButton();
        }

        // üìä UPDATE SELECTION SUMMARY
        function updateSelectionSummary() {
            const summaryEl = document.getElementById('selectionSummary');
            const categoriesCountEl = document.getElementById('categoriesCount');
            const subcategoriesCountEl = document.getElementById('subcategoriesCount');
            
            if (selectedCategories.length > 0 || selectedSubcategories.length > 0) {
                summaryEl.style.display = 'block';
                categoriesCountEl.textContent = selectedCategories.length;
                subcategoriesCountEl.textContent = selectedSubcategories.length;
            } else {
                summaryEl.style.display = 'none';
            }
        }

        // üîÑ UPDATE NEXT BUTTON
        function updateNextButton() {
            const nextBtn = document.getElementById('categoryNextBtn');
            if (selectedCategories.length > 0) {
                nextBtn.disabled = false;
                nextBtn.style.opacity = '1';
            } else {
                nextBtn.disabled = true;
                nextBtn.style.opacity = '0.5';
            }
        }

        // üì¶ UPDATE PRODUCT CATEGORIES DROPDOWN
        function updateProductCategoriesDropdown() {
            const productCategorySelect = document.getElementById('productCategory');
            const productSubcategorySelect = document.getElementById('productSubcategory');
            
            productCategorySelect.innerHTML = '<option value="">Select from your chosen categories</option>';
            productSubcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';
            
            const businessCategory = document.getElementById('category').value;
            if (!businessCategory || !businessCategories[businessCategory]) return;
            
            const categoryData = businessCategories[businessCategory];
            
            selectedCategories.forEach(categoryKey => {
                const category = categoryData.categories[categoryKey];
                if (category) {
                    productCategorySelect.innerHTML += `<option value="${categoryKey}">${category.name}</option>`;
                }
            });
            
            // Update subcategories when category changes
            productCategorySelect.onchange = function() {
                const selectedCat = this.value;
                productSubcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';
                
                if (selectedCat && categoryData.categories[selectedCat]) {
                    const category = categoryData.categories[selectedCat];
                    category.subcategories.forEach(subcategoryKey => {
                        const subcategoryName = subcategoryNames[subcategoryKey] || subcategoryKey.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                        productSubcategorySelect.innerHTML += `<option value="${subcategoryKey}">${subcategoryName}</option>`;
                    });
                }
            };
        }

        // ‚û°Ô∏è ENHANCED PROCEED TO PRODUCTS WITH ERROR HANDLING
        async function proceedToProducts() {
            if (selectedCategories.length === 0) {
                showNotification('Please select at least one category', 'error');
                return;
            }
            
            addDebugLog(`Proceeding to products with ${selectedCategories.length} categories and ${selectedSubcategories.length} subcategories`);
            
            if (currentUserId) {
                // Try to update user record with categories and subcategories
                try {
                    const updateData = {
                        selected_categories: selectedCategories,
                        selected_subcategories: selectedSubcategories
                    };
                    
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${currentUserId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(updateData)
                    });
                    
                    if (response.ok) {
                        addDebugLog('‚úÖ User categories updated in database', 'success');
                    } else {
                        const errorText = await response.text();
                        addDebugLog(`‚ö†Ô∏è Category update failed: ${response.status} ${errorText}`, 'error');
                        // Continue anyway - categories will be saved in localStorage
                    }
                } catch (error) {
                    addDebugLog(`‚ö†Ô∏è Category update failed: ${error.message}`, 'error');
                    // Continue anyway - categories will be saved in localStorage
                }
                
                // Try to update lead intelligence
                try {
                    const intelligenceUpdateData = {
                        selected_categories: selectedCategories,
                        selected_subcategories: selectedSubcategories,
                        categories_count: selectedCategories.length,
                        subcategories_count: selectedSubcategories.length,
                        lead_score: calculateLeadScore()
                    };
                    
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/lead_intelligence?user_id=eq.${currentUserId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(intelligenceUpdateData)
                    });
                    
                    if (response.ok) {
                        addDebugLog('‚úÖ Lead intelligence categories updated', 'success');
                    } else {
                        const errorText = await response.text();
                        addDebugLog(`‚ö†Ô∏è Intelligence update failed: ${response.status} ${errorText}`, 'error');
                        // Continue anyway
                    }
                } catch (error) {
                    addDebugLog(`‚ö†Ô∏è Intelligence update failed: ${error.message}`, 'error');
                    // Continue anyway
                }
            }
            
            showNotification(`Moving to products with ${selectedCategories.length} categories selected...`, 'info');
            setTimeout(() => showScreen('products'), 1000);
        }

        // üì¶ ADD PRODUCT - FIXED FOR CORRECT DATABASE SCHEMA
        async function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = document.getElementById('productPrice').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            const categoryKey = document.getElementById('productCategory').value;
            const subcategoryKey = document.getElementById('productSubcategory').value;
            const imageUrl = document.getElementById('productImage').value.trim();
            
            if (!name || !price || !description || !categoryKey) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            if (isNaN(price) || price <= 0) {
                showNotification('Please enter a valid price', 'error');
                return;
            }
            
            const product = {
                name: name,
                price: parseFloat(price),
                description: description,
                categoryKey: categoryKey,
                subcategoryKey: subcategoryKey || null,
                imageUrl: imageUrl || getDefaultProductImage(),
                createdAt: new Date().toISOString()
            };
            
            userProducts.push(product);
            
            // Save to database if we have user ID - ONLY USING EXISTING SCHEMA FIELDS
            if (currentUserId) {
                const productDbData = {
                    user_id: currentUserId,
                    name: name,
                    price: parseFloat(price),
                    description: description,
                    image_url: imageUrl || null
                    // Note: category_id is FK to categories table, but we'll leave it null for now
                    // category_key and subcategory_key don't exist in schema, so we skip them
                };
                
                addDebugLog(`üíæ Saving product with schema-compliant data: ${JSON.stringify(productDbData, null, 2)}`);
                
                const productResult = await saveToSupabase(productDbData, 'products');
                if (productResult.success) {
                    addDebugLog(`‚úÖ Product saved to database: ${name}`, 'success');
                    showNotification(`‚úÖ Product "${name}" saved to database!`, 'success');
                } else {
                    addDebugLog(`‚ö†Ô∏è Product database save failed: ${productResult.error}`, 'error');
                    showNotification(`‚ö†Ô∏è Product saved locally (database issue)`, 'warning');
                    // Continue anyway - product is saved locally and will sync later
                }
            } else {
                addDebugLog(`üìù Product saved locally (no user ID yet): ${name}`, 'info');
                showNotification(`üìù Product "${name}" added (will save to database after registration)`, 'info');
            }
            
            // Clear form
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productSubcategory').value = '';
            document.getElementById('productImage').value = '';
            
            displayProducts();
            calculateLeadScore();
            
            addDebugLog(`üì¶ Product added successfully: ${name} (‚Çπ${price})`);
        }

        // üñºÔ∏è GET DEFAULT PRODUCT IMAGE
        function getDefaultProductImage() {
            return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZjFmNWY5Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTEwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjM2NjcwIiBmb250LWZhbWlseT0iYXJpYWwiIGZvbnQtc2l6ZT0iNDAiPvCfk6Y8L3RleHQ+PC9zdmc+';
        }

        // üìã DISPLAY PRODUCTS
        function displayProducts() {
            const productsList = document.getElementById('productsList');
            const productCount = document.getElementById('productCount');
            
            productCount.textContent = userProducts.length;
            
            if (userProducts.length === 0) {
                productsList.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #64748b; background: rgba(255, 255, 255, 0.5); border-radius: 12px;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                        <p>No products added yet. Add your first product above!</p>
                    </div>
                `;
                return;
            }
            
            const businessCategory = document.getElementById('category').value;
            const categoryData = businessCategories[businessCategory];
            
            productsList.innerHTML = userProducts.map(product => {
                const categoryName = categoryData?.categories[product.categoryKey]?.name || product.categoryKey;
                const subcategoryName = product.subcategoryKey ? 
                    (subcategoryNames[product.subcategoryKey] || product.subcategoryKey) : '';
                
                return `
                    <div class="product-card">
                        <div class="product-image" style="background-image: url('${product.imageUrl}');">
                            <div class="product-price">‚Çπ${product.price.toLocaleString()}</div>
                        </div>
                        <div class="product-content">
                            <div class="product-name">${product.name}</div>
                            <div class="product-description">${product.description}</div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">
                                <span>üìÅ ${categoryName}</span>
                                ${subcategoryName ? `<span>üè∑Ô∏è ${subcategoryName}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // üöÄ ENHANCED COMPLETE SETUP WITH ERROR HANDLING - FIXED FUNCTION
        async function completeSetup() {
            const finalScore = calculateLeadScore() + 10; // Bonus for completion
            
            // Save all data to localStorage for immediate CRM sync
            const leadData = {
                user_id: currentUserId,
                name: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phoneNumber').value,
                business_name: document.getElementById('businessName').value,
                address: document.getElementById('address').value,
                business_type: document.getElementById('businessType').value,
                business_category: document.getElementById('category').value,
                selected_language: selectedLanguage,
                selected_goals: selectedGoals,
                selected_categories: selectedCategories,
                selected_subcategories: selectedSubcategories,
                products_count: userProducts.length,
                products_data: userProducts,
                categories_data: selectedCategories,
                subcategories_data: selectedSubcategories,
                lead_score: finalScore,
                lead_quality: finalScore >= 70 ? 'Hot' : finalScore >= 40 ? 'Warm' : 'Cold',
                session_duration_minutes: Math.round((Date.now() - sessionStartTime) / 60000),
                page_views: pageViews,
                utm_source: utmParams.source,
                device_type: deviceInfo.type,
                browser: deviceInfo.browser,
                setup_completed: true,
                completed_at: new Date().toISOString()
            };
            
            // Save to localStorage for immediate CRM sync
            const existingLeads = JSON.parse(localStorage.getItem('topiko_local_leads') || '[]');
            existingLeads.push(leadData);
            localStorage.setItem('topiko_local_leads', JSON.stringify(existingLeads));
            
            // Update lead intelligence with final data if possible
            if (currentUserId) {
                try {
                    // Only use fields that definitely exist in the lead_intelligence schema
                    const finalIntelligenceData = {
                        lead_score: finalScore,
                        lead_quality: finalScore >= 70 ? 'Hot' : finalScore >= 40 ? 'Warm' : 'Cold',
                        engagement_level: finalScore >= 70 ? 'High' : finalScore >= 40 ? 'Medium' : 'Low',
                        session_duration_minutes: Math.round((Date.now() - sessionStartTime) / 60000),
                        page_views: pageViews,
                        form_completion_percentage: 100,
                        ready_for_sdr_assignment: true
                    };
                    
                    addDebugLog(`üíæ Updating lead intelligence with final data: ${JSON.stringify(finalIntelligenceData, null, 2)}`);
                    
                    // Update the existing lead intelligence record
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/lead_intelligence?user_id=eq.${currentUserId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(finalIntelligenceData)
                    });
                    
                    if (response.ok) {
                        addDebugLog('‚úÖ Final lead intelligence updated successfully', 'success');
                        showNotification('‚úÖ Setup completed and saved to database!', 'success');
                    } else {
                        const errorText = await response.text();
                        addDebugLog(`‚ö†Ô∏è Intelligence final update failed: ${response.status} ${errorText}`, 'error');
                        showNotification('‚úÖ Setup completed! (Some data saved locally)', 'warning');
                        // Continue anyway - data is saved in localStorage
                    }
                } catch (error) {
                    addDebugLog(`‚ö†Ô∏è Intelligence final update failed: ${error.message}`, 'error');
                    showNotification('‚úÖ Setup completed! (Data saved locally)', 'warning');
                    // Continue anyway - data is saved in localStorage
                }
            } else {
                addDebugLog('‚ö†Ô∏è No user ID available for final database update', 'warning');
                showNotification('‚úÖ Setup completed! (No database connection)', 'warning');
            }
            
            addDebugLog(`‚úÖ Setup completed! Final score: ${finalScore}/100`, 'success');
            
            // Show completion message
            showNotification('üéâ Setup completed successfully! Your business is ready!', 'success');
            
            // Display completion summary
            setTimeout(() => {
                showCompletionSummary(finalScore, leadData);
            }, 2000);
        }

        // üéâ SHOW COMPLETION SUMMARY
        function showCompletionSummary(finalScore, leadData) {
            const completionHTML = `
                <div class="content-card" style="max-width: 800px; margin: 0 auto; text-align: center; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #22c55e, #16a34a, #059669); border-radius: 20px 20px 0 0;"></div>
                    
                    <div style="font-size: 4rem; margin-bottom: 1.5rem; animation: bounce 2s infinite;">üéâ</div>
                    
                    <h2 style="color: #059669; font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem;">
                        Congratulations! Your Setup is Complete!
                    </h2>
                    
                    <p style="color: #064e3b; font-size: 1.2rem; margin-bottom: 2rem;">
                        Your business profile has been created successfully and you're ready to start growing!
                    </p>

                    <div style="background: rgba(34, 197, 94, 0.1); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 16px; padding: 2rem; margin: 2rem 0;">
                        <h3 style="color: #059669; font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem;">üìä Your Business Summary</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                            <div style="background: rgba(255, 255, 255, 0.8); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üéØ</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #059669;">${finalScore}</div>
                                <div style="color: #064e3b; font-size: 0.9rem;">Lead Score</div>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.8); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üé®</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #059669;">${selectedGoals.length}</div>
                                <div style="color: #064e3b; font-size: 0.9rem;">Goals Selected</div>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.8); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìÇ</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #059669;">${selectedCategories.length}</div>
                                <div style="color: #064e3b; font-size: 0.9rem;">Categories</div>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.8); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì¶</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #059669;">${userProducts.length}</div>
                                <div style="color: #064e3b; font-size: 0.9rem;">Products Added</div>
                            </div>
                        </div>

                        <div style="background: rgba(34, 197, 94, 0.15); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0;">
                            <h4 style="color: #059669; margin-bottom: 1rem;">üöÄ What's Next?</h4>
                            <div style="text-align: left; color: #064e3b;">
                                <p>‚úÖ Your business profile is now live and searchable</p>
                                <p>‚úÖ Our sales team will review your setup and contact you within 24 hours</p>
                                <p>‚úÖ You'll receive onboarding materials and training resources</p>
                                <p>‚úÖ Start attracting customers immediately with your new presence</p>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button onclick="goToDashboard()" style="flex: 1; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                            View Dashboard üìä
                        </button>
                        <button onclick="startOver()" style="flex: 1; background: rgba(34, 197, 94, 0.1); color: #059669; border: 2px solid rgba(34, 197, 94, 0.3); padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                            Start Another üîÑ
                        </button>
                    </div>

                    <div style="margin-top: 2rem; color: #6b7280; font-size: 0.9rem;">
                        <p>üéØ Your lead quality: <strong>${leadData.lead_quality}</strong> | Session time: <strong>${leadData.session_duration_minutes}m</strong></p>
                    </div>
                </div>
            `;
            
            // Replace the products screen content with completion summary
            const productsScreen = document.getElementById('products');
            productsScreen.innerHTML = completionHTML;
            
            addDebugLog('‚úÖ Completion summary displayed', 'success');
        }

        // üîÑ NAVIGATION FUNCTIONS
        function goToDashboard() {
            addDebugLog('üöÄ Redirecting to CRM dashboard');
            showNotification('Redirecting to dashboard...', 'info');
            
            // Redirect to CRM after a short delay
            setTimeout(() => {
                window.location.href = './crm.html';
            }, 1500);
        }

        function startOver() {
            addDebugLog('üîÑ Starting over - resetting form');
            
            // Reset all variables
            selectedGoals = [];
            selectedLanguage = 'en';
            selectedCategories = [];
            selectedSubcategories = [];
            userProducts = [];
            currentUserId = null;
            pageViews = 1;
            leadScore = 0;
            formProgress = 0;
            sessionStartTime = Date.now();
            
            // Clear form fields
            const formFields = ['fullName', 'email', 'phoneNumber', 'businessName', 'address', 'businessType', 'category'];
            formFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.value = '';
            });
            
            // Clear checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Reset UI
            updateLeadIntelligenceWidget();
            showNotification('Form reset! Starting fresh...', 'info');
            
            // Go back to welcome screen
            setTimeout(() => showScreen('welcome'), 1000);
        }

        // üì¢ ENHANCED NOTIFICATION SYSTEM
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const content = document.getElementById('notificationContent');
            
            if (!notification || !content) {
                console.log(`Notification: ${message}`);
                return;
            }
            
            content.textContent = message;
            notification.className = `notification ${type} show`;
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
            
            addDebugLog(`Notification (${type}): ${message}`);
        }

        // üöÄ INITIALIZATION FUNCTIONS
        function initializeApp() {
            addDebugLog('üöÄ Initializing Topiko Lead Form Application', 'info');
            
            // Capture UTM parameters and device info
            captureUTMParameters();
            detectDevice();
            
            // Test database connection
            testDatabaseConnection();
            
            // Initialize lead intelligence
            updateLeadIntelligenceWidget();
            
            // Setup page view tracking
            pageViews = 1;
            sessionStartTime = Date.now();
            
            addDebugLog('‚úÖ Application initialized successfully', 'success');
        }

        // üéØ PAGE LOAD EVENT
        document.addEventListener('DOMContentLoaded', function() {
            addDebugLog('üìÑ DOM Content Loaded - Starting initialization');
            initializeApp();
            
            // Update session time every 30 seconds
            setInterval(() => {
                updateLeadIntelligenceWidget();
                
                // Auto-save to localStorage every 30 seconds
                if (currentUserId || selectedGoals.length > 0) {
                    const currentData = {
                        selectedGoals,
                        selectedLanguage,
                        selectedCategories,
                        selectedSubcategories,
                        userProducts,
                        leadScore,
                        formProgress,
                        sessionStartTime,
                        lastSaved: Date.now()
                    };
                    localStorage.setItem('topiko_current_session', JSON.stringify(currentData));
                    addDebugLog('üíæ Session auto-saved to localStorage');
                }
            }, 30000);
        });

        // üîß UTILITY FUNCTIONS
        window.addEventListener('beforeunload', function(e) {
            // Save current session before leaving
            const currentData = {
                selectedGoals,
                selectedLanguage,
                selectedCategories,
                selectedSubcategories,
                userProducts,
                leadScore,
                formProgress,
                sessionStartTime,
                lastSaved: Date.now()
            };
            localStorage.setItem('topiko_current_session', JSON.stringify(currentData));
            addDebugLog('üíæ Session saved on page unload');
        });

        // üîç ERROR HANDLING
        window.addEventListener('error', function(e) {
            addDebugLog(`‚ùå JavaScript Error: ${e.error?.message || e.message}`, 'error');
            showError('Application Error', e.error?.message || e.message);
        });

        window.addEventListener('unhandledrejection', function(e) {
            addDebugLog(`‚ùå Unhandled Promise Rejection: ${e.reason}`, 'error');
            showError('Promise Error', e.reason);
        });

        // üìä CONSOLE LOGGING FOR DEBUGGING
        addDebugLog('üéØ Topiko Lead Form - All functions loaded and ready', 'success');
        console.log('üéØ Topiko Lead Intelligence System Loaded');
        console.log('üìä Available functions:', [
            'showScreen()', 'startLeadFlow()', 'selectLanguage()', 'submitGoals()', 
            'submitRegistration()', 'addProduct()', 'completeSetup()', 'testDatabaseSave()',
            'toggleDebugPanel()', 'calculateLeadScore()', 'showNotification()'
        ]);
    </script>
</body>
</html>
